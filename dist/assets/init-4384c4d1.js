import{_ as S,E as y,a as k,b as Rt,T as Ue,A as Y,ac as fe,ab as $e,w as se,W as E,F as O,P as Mt,R as Fe,O as Ne,U as oe,B as Qe,c as K,d as V,a9 as $,aa as N,g as J,t as ve,s as ae,a7 as Z,ad as At,ae as Ut,e as Gt,i as Q,af as ye,ag as j,a1 as he,ah as zt,ai as Pe,aj as ie,ak as W,al as be,am as Ht,an as Ge,Q as U,ao as It,S as Je,k as Ze,ap as pe,D as ue,aq as Wt,ar as ge,o as X,p as R,as as Ot,M as ze,at as Dt,au as Te,n as He,h as G,av as Lt}from"./index-e9a6487e.js";import{d as Be,c as et,e as tt,b as Et,r as rt,j as Xt,i as at,a as Yt,g as Kt,f as Vt,h as qt,B as nt}from"./colorToUniform-e74e556a.js";import{C as ne}from"./CanvasPool-b559b4fe.js";import{b as jt}from"./batchSamplersUniformGroup-77861437.js";var it=function(){function i(){k(this,i)}return S(i,null,[{key:"init",value:function(e){var r=this;Object.defineProperty(this,"resizeTo",{set:function(a){globalThis.removeEventListener("resize",this.queueResize),this._resizeTo=a,a&&(globalThis.addEventListener("resize",this.queueResize),this.resize())},get:function(){return this._resizeTo}}),this.queueResize=function(){r._resizeTo&&(r._cancelResize(),r._resizeId=requestAnimationFrame(function(){return r.resize()}))},this._cancelResize=function(){r._resizeId&&(cancelAnimationFrame(r._resizeId),r._resizeId=null)},this.resize=function(){if(r._resizeTo){r._cancelResize();var t,a;if(r._resizeTo===globalThis.window)t=globalThis.innerWidth,a=globalThis.innerHeight;else{var s=r._resizeTo,o=s.clientWidth,u=s.clientHeight;t=o,a=u}r.renderer.resize(t,a),r.render()}},this._resizeId=null,this._resizeTo=null,this.resizeTo=e.resizeTo||null}},{key:"destroy",value:function(){globalThis.removeEventListener("resize",this.queueResize),this._cancelResize(),this._cancelResize=null,this.queueResize=null,this.resizeTo=null,this.resize=null}}]),i}();it.extension=y.Application;var st=function(){function i(){k(this,i)}return S(i,null,[{key:"init",value:function(e){var r=this;e=Object.assign({autoStart:!0,sharedTicker:!1},e),Object.defineProperty(this,"ticker",{set:function(a){this._ticker&&this._ticker.remove(this.render,this),this._ticker=a,a&&a.add(this.render,this,Rt.LOW)},get:function(){return this._ticker}}),this.stop=function(){r._ticker.stop()},this.start=function(){r._ticker.start()},this._ticker=null,this.ticker=e.sharedTicker?Ue.shared:new Ue,e.autoStart&&this.start()}},{key:"destroy",value:function(){if(this._ticker){var e=this._ticker;this.ticker=null,e.destroy()}}}]),i}();st.extension=y.Application;var ot=function(){function i(n){k(this,i),this._renderer=n}return S(i,[{key:"push",value:function(e,r,t){var a=this._renderer.renderPipes;a.batch.break(t),t.add({renderPipeId:"filter",canBundle:!1,action:"pushFilter",container:r,filterEffect:e})}},{key:"pop",value:function(e,r,t){this._renderer.renderPipes.batch.break(t),t.add({renderPipeId:"filter",action:"popFilter",canBundle:!1})}},{key:"execute",value:function(e){e.action==="pushFilter"?this._renderer.filter.push(e):e.action==="popFilter"&&this._renderer.filter.pop()}},{key:"destroy",value:function(){this._renderer=null}}]),i}();ot.extension={type:[y.WebGLPipes,y.WebGPUPipes,y.CanvasPipes],name:"filter"};var $t=new Y;function Nt(i,n){return n.clear(),ut(i,n),n.isValid||n.set(0,0,0,0),i.isRenderGroupRoot?n.applyMatrix(i.renderGroup.localTransform):n.applyMatrix(i.renderGroup.worldTransform),n}function ut(i,n){if(!(i.localDisplayStatus!==7||!i.measurable)){var e=!!i.effects.length,r=n;if((i.isRenderGroupRoot||e)&&(r=fe.get().clear()),i.boundsArea)n.addRect(i.boundsArea,i.worldTransform);else{if(i.renderPipeId){var t=i.bounds;r.addFrame(t.minX,t.minY,t.maxX,t.maxY,i.groupTransform)}for(var a=i.children,s=0;s<a.length;s++)ut(a[s],r)}if(e){for(var o=!1,u=0;u<i.effects.length;u++)i.effects[u].addBounds&&(o||(o=!0,r.applyMatrix(i.renderGroup.worldTransform)),i.effects[u].addBounds(r,!0));o&&(r.applyMatrix(i.renderGroup.worldTransform.copyTo($t).invert()),n.addBounds(r,i.relativeGroupTransform)),n.addBounds(r),fe.return(r)}else i.isRenderGroupRoot&&(n.addBounds(r,i.relativeGroupTransform),fe.return(r))}}function Qt(i,n){n.clear();for(var e=n.matrix,r=0;r<i.length;r++){var t=i[r];t.globalDisplayStatus<7||(n.matrix=t.worldTransform,t.addBounds(n))}return n.matrix=e,n}var Jt=new $e({attributes:{aPosition:{buffer:new Float32Array([0,0,1,0,1,1,0,1]),location:0,format:"float32x2",stride:2*4,offset:0}},indexBuffer:new Uint32Array([0,1,2,0,2,3])}),lt=function(){function i(n){k(this,i),this._filterStackIndex=0,this._filterStack=[],this._filterGlobalUniforms=new oe({uInputSize:{value:new Float32Array(4),type:"vec4<f32>"},uInputPixel:{value:new Float32Array(4),type:"vec4<f32>"},uInputClamp:{value:new Float32Array(4),type:"vec4<f32>"},uOutputFrame:{value:new Float32Array(4),type:"vec4<f32>"},uGlobalFrame:{value:new Float32Array(4),type:"vec4<f32>"},uOutputTexture:{value:new Float32Array(4),type:"vec4<f32>"}}),this._globalFilterBindGroup=new Qe({}),this.renderer=n}return S(i,[{key:"activeBackTexture",get:function(){var e;return(e=this._activeFilterData)===null||e===void 0?void 0:e.backTexture}},{key:"push",value:function(e){var r=this.renderer,t=e.filterEffect.filters;this._filterStack[this._filterStackIndex]||(this._filterStack[this._filterStackIndex]=this._getFilterData());var a=this._filterStack[this._filterStackIndex];if(this._filterStackIndex++,t.length===0){a.skip=!0;return}var s=a.bounds;e.renderables?Qt(e.renderables,s):e.filterEffect.filterArea?(s.clear(),s.addRect(e.filterEffect.filterArea),s.applyMatrix(e.container.worldTransform)):Nt(e.container,s);for(var o=r.renderTarget.rootRenderTarget.colorTexture.source,u=o._resolution,l=0,d=o.antialias,h=!1,f=!1,c=0;c<t.length;c++){var v,p,g=t[c];u=Math.min(u,g.resolution),l+=g.padding,g.antialias!=="inherit"&&(g.antialias==="on"?d=!0:d=!1);var x=!!(g.compatibleRenderers&r.type);if(!x){f=!1;break}if(g.blendRequired&&!(!((v=(p=r.backBuffer)===null||p===void 0?void 0:p.useBackBuffer)!==null&&v!==void 0)||v)){se("Blend filter requires backBuffer on WebGL renderer to be enabled. Set `useBackBuffer: true` in the renderer options."),f=!1;break}f=g.enabled||f,h=h||g.blendRequired}if(!f){a.skip=!0;return}var m=r.renderTarget.rootViewPort;if(s.scale(u).fitBounds(0,m.width,0,m.height).scale(1/u).pad(l).ceil(),!s.isPositive){a.skip=!0;return}a.skip=!1,a.bounds=s,a.blendRequired=h,a.container=e.container,a.filterEffect=e.filterEffect,a.previousRenderSurface=r.renderTarget.renderSurface,a.inputTexture=E.getOptimalTexture(s.width,s.height,u,d),r.renderTarget.bind(a.inputTexture,!0),r.globalUniforms.push({offset:s})}},{key:"pop",value:function(){var e=this.renderer;this._filterStackIndex--;var r=this._filterStack[this._filterStackIndex];if(!r.skip){this._activeFilterData=r;var t=r.inputTexture,a=r.bounds,s=O.EMPTY;if(e.renderTarget.finishRenderPass(),r.blendRequired){var o=this._filterStackIndex>0?this._filterStack[this._filterStackIndex-1].bounds:null,u=e.renderTarget.getRenderTarget(r.previousRenderSurface);s=this.getBackTexture(u,a,o)}r.backTexture=s;var l=r.filterEffect.filters;if(this._globalFilterBindGroup.setResource(t.source.style,2),this._globalFilterBindGroup.setResource(s.source,3),e.globalUniforms.pop(),l.length===1)l[0].apply(this,t,r.previousRenderSurface,!1),E.returnTexture(t);else{var d=r.inputTexture,h=E.getOptimalTexture(a.width,a.height,d.source._resolution,!1),f=0;for(f=0;f<l.length-1;++f){var c=l[f];c.apply(this,d,h,!0);var v=d;d=h,h=v}l[f].apply(this,d,r.previousRenderSurface,!1),E.returnTexture(d),E.returnTexture(h)}r.blendRequired&&E.returnTexture(s)}}},{key:"getBackTexture",value:function(e,r,t){var a=e.colorTexture.source._resolution,s=E.getOptimalTexture(r.width,r.height,a,!1),o=r.minX,u=r.minY;t&&(o-=t.minX,u-=t.minY),o=Math.floor(o*a),u=Math.floor(u*a);var l=Math.ceil(r.width*a),d=Math.ceil(r.height*a);return this.renderer.renderTarget.copyToTexture(e,s,{x:o,y:u},{width:l,height:d},{x:0,y:0}),s}},{key:"applyFilter",value:function(e,r,t,a){for(var s=this.renderer,o=this._filterStack[this._filterStackIndex],u=o.bounds,l=Mt.shared,d=o.previousRenderSurface,h=d===t,f=this.renderer.renderTarget.rootRenderTarget.colorTexture.source._resolution,c=this._filterStackIndex-1;c>0&&this._filterStack[c].skip;)--c;c>0&&(f=this._filterStack[c].inputTexture.source._resolution);var v=this._filterGlobalUniforms,p=v.uniforms,g=p.uOutputFrame,x=p.uInputSize,m=p.uInputPixel,_=p.uInputClamp,P=p.uGlobalFrame,C=p.uOutputTexture;if(h){for(var T=this._filterStackIndex;T>0;){T--;var F=this._filterStack[this._filterStackIndex-1];if(!F.skip){l.x=F.bounds.minX,l.y=F.bounds.minY;break}}g[0]=u.minX-l.x,g[1]=u.minY-l.y}else g[0]=0,g[1]=0;g[2]=r.frame.width,g[3]=r.frame.height,x[0]=r.source.width,x[1]=r.source.height,x[2]=1/x[0],x[3]=1/x[1],m[0]=r.source.pixelWidth,m[1]=r.source.pixelHeight,m[2]=1/m[0],m[3]=1/m[1],_[0]=.5*m[2],_[1]=.5*m[3],_[2]=r.frame.width*x[2]-.5*m[2],_[3]=r.frame.height*x[3]-.5*m[3];var w=this.renderer.renderTarget.rootRenderTarget.colorTexture;P[0]=l.x*f,P[1]=l.y*f,P[2]=w.source.width*f,P[3]=w.source.height*f;var b=this.renderer.renderTarget.getRenderTarget(t);if(s.renderTarget.bind(t,!!a),t instanceof O?(C[0]=t.frame.width,C[1]=t.frame.height):(C[0]=b.width,C[1]=b.height),C[2]=b.isRoot?-1:1,v.update(),s.renderPipes.uniformBatch){var B=s.renderPipes.uniformBatch.getUboResource(v);this._globalFilterBindGroup.setResource(B,0)}else this._globalFilterBindGroup.setResource(v,0);this._globalFilterBindGroup.setResource(r.source,1),this._globalFilterBindGroup.setResource(r.source.style,2),e.groups[0]=this._globalFilterBindGroup,s.encoder.draw({geometry:Jt,shader:e,state:e._state,topology:"triangle-list"}),s.type===Fe.WEBGL&&s.renderTarget.finishRenderPass()}},{key:"_getFilterData",value:function(){return{skip:!1,inputTexture:null,bounds:new Ne,container:null,filterEffect:null,blendRequired:!1,previousRenderSurface:null}}},{key:"calculateSpriteMatrix",value:function(e,r){var t=this._activeFilterData,a=e.set(t.inputTexture._source.width,0,0,t.inputTexture._source.height,t.bounds.minX,t.bounds.minY),s=r.worldTransform.copyTo(Y.shared);return s.invert(),a.prepend(s),a.scale(1/r.texture.frame.width,1/r.texture.frame.height),a.translate(r.anchor.x,r.anchor.y),a}}]),i}();lt.extension={type:[y.WebGLSystem,y.WebGPUSystem],name:"filter"};var dt=function(i){K(e,i);var n=V(e);function e(){var r,t;k(this,e);var a=(r=arguments.length<=0?void 0:arguments[0])!==null&&r!==void 0?r:{};a instanceof Float32Array&&($(N,"use new MeshGeometry({ positions, uvs, indices }) instead"),a={positions:a,uvs:arguments.length<=1?void 0:arguments[1],indices:arguments.length<=2?void 0:arguments[2]}),a=J(J({},e.defaultOptions),a);var s=a.positions||new Float32Array([0,0,1,0,1,1,0,1]),o=a.uvs||new Float32Array([0,0,1,0,1,1,0,1]),u=a.indices||new Uint32Array([0,1,2,0,2,3]),l=a.shrinkBuffersToFit,d=new ve({data:s,label:"attribute-mesh-positions",shrinkToFit:l,usage:ae.VERTEX|ae.COPY_DST}),h=new ve({data:o,label:"attribute-mesh-uvs",shrinkToFit:l,usage:ae.VERTEX|ae.COPY_DST}),f=new ve({data:u,label:"index-mesh-buffer",shrinkToFit:l,usage:ae.INDEX|ae.COPY_DST});return t=n.call(this,{attributes:{aPosition:{buffer:d,format:"float32x2",stride:2*4,offset:0},aUV:{buffer:h,format:"float32x2",stride:2*4,offset:0}},indexBuffer:f,topology:a.topology}),t.batchMode="auto",t}return S(e,[{key:"positions",get:function(){return this.attributes.aPosition.buffer.data},set:function(t){this.attributes.aPosition.buffer.data=t}},{key:"uvs",get:function(){return this.attributes.aUV.buffer.data},set:function(t){this.attributes.aUV.buffer.data=t}},{key:"indices",get:function(){return this.indexBuffer.data},set:function(t){this.indexBuffer.data=t}}]),e}($e);dt.defaultOptions={topology:"triangle-list",shrinkBuffersToFit:!1};var Re=dt;function ce(i,n){if(i.texture===O.WHITE&&!i.fill)return Z.shared.setValue(i.color).toHex();if(i.fill){if(i.fill instanceof At){var t=i.fill,a=n.createPattern(t.texture.source.resource,"repeat"),s=t.transform.copyTo(Y.shared);return s.scale(t.texture.frame.width,t.texture.frame.height),a.setTransform(s),a}else if(i.fill instanceof Ut){var o=i.fill;if(o.type==="linear"){var u=n.createLinearGradient(o.x0,o.y0,o.x1,o.y1);return o.gradientStops.forEach(function(l){u.addColorStop(l.offset,Z.shared.setValue(l.color).toHex())}),u}}}else{var e=n.createPattern(i.texture.source.resource,"repeat"),r=i.matrix.copyTo(Y.shared);return r.scale(i.texture.frame.width,i.texture.frame.height),e.setTransform(r),e}return se("FillStyle not recognised",i),"red"}var ht=function(i){K(e,i);var n=V(e);function e(){var r;return k(this,e),r=n.apply(this,arguments),r.chars=Object.create(null),r.lineHeight=0,r.fontFamily="",r.fontMetrics={fontSize:0,ascent:0,descent:0},r.baseLineOffset=0,r.distanceField={type:"none",range:0},r.pages=[],r.baseMeasurementFontSize=100,r.baseRenderedFontSize=100,r}return S(e,[{key:"font",get:function(){return $(N,"BitmapFont.font is deprecated, please use BitmapFont.fontFamily instead."),this.fontFamily}},{key:"pageTextures",get:function(){return $(N,"BitmapFont.pageTextures is deprecated, please use BitmapFont.pages instead."),this.pages}},{key:"size",get:function(){return $(N,"BitmapFont.size is deprecated, please use BitmapFont.fontMetrics.fontSize instead."),this.fontMetrics.fontSize}},{key:"distanceFieldRange",get:function(){return $(N,"BitmapFont.distanceFieldRange is deprecated, please use BitmapFont.distanceField.range instead."),this.distanceField.range}},{key:"distanceFieldType",get:function(){return $(N,"BitmapFont.distanceFieldType is deprecated, please use BitmapFont.distanceField.type instead."),this.distanceField.type}},{key:"destroy",value:function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;this.emit("destroy",this),this.removeAllListeners();for(var a in this.chars)this.chars[a].texture.destroy();this.chars=null,t&&(this.pages.forEach(function(s){return s.texture.destroy(!0)}),this.pages=null)}}]),e}(Gt);function ct(i){if(i==="")return[];typeof i=="string"&&(i=[i]);for(var n=[],e=0,r=i.length;e<r;e++){var t=i[e];if(Array.isArray(t)){if(t.length!==2)throw new Error("[BitmapFont]: Invalid character range length, expecting 2 got ".concat(t.length,"."));if(t[0].length===0||t[1].length===0)throw new Error("[BitmapFont]: Invalid character delimiter.");var a=t[0].charCodeAt(0),s=t[1].charCodeAt(0);if(s<a)throw new Error("[BitmapFont]: Invalid character range.");for(var o=a,u=s;o<=u;o++)n.push(String.fromCharCode(o))}else n.push.apply(n,Q(Array.from(t)))}if(n.length===0)throw new Error("[BitmapFont]: Empty set when resolving characters.");return n}var Ie=function(i){K(e,i);var n=V(e);function e(r){var t,a,s,o;k(this,e),o=n.call(this),o.resolution=1,o.pages=[],o._padding=4,o._measureCache=Object.create(null),o._currentChars=[],o._currentX=0,o._currentY=0,o._currentPageIndex=-1,o._skipKerning=!1;var u=r,l=u.style.clone();u.overrideFill&&(l._fill.color=16777215,l._fill.alpha=1,l._fill.texture=O.WHITE,l._fill.fill=null);var d=l.fontSize;l.fontSize=o.baseMeasurementFontSize;var h=ye(l);return u.overrideSize?l._stroke&&(l._stroke.width*=o.baseRenderedFontSize/d):l.fontSize=o.baseRenderedFontSize=d,o._style=l,o._skipKerning=(t=u.skipKerning)!==null&&t!==void 0?t:!1,o.resolution=(a=u.resolution)!==null&&a!==void 0?a:1,o._padding=(s=u.padding)!==null&&s!==void 0?s:4,o.fontMetrics=j.measureFont(h),o.lineHeight=l.lineHeight||o.fontMetrics.fontSize||l.fontSize,o}return S(e,[{key:"ensureCharacters",value:function(t){var a=this,s=ct(t).filter(function(ee){return!a._currentChars.includes(ee)}).filter(function(ee,I,Bt){return Bt.indexOf(ee)===I});if(s.length){this._currentChars=[].concat(Q(this._currentChars),Q(s));var o;this._currentPageIndex===-1?o=this._nextPage():o=this.pages[this._currentPageIndex];for(var u=o.canvasAndContext,l=u.canvas,d=u.context,h=o.texture.source,f=this._style,c=this._currentX,v=this._currentY,p=this.baseRenderedFontSize/this.baseMeasurementFontSize,g=this._padding*p,x=f.fontStyle==="italic"?2:1,m=0,_=!1,P=0;P<s.length;P++){var C,T,F,w,b=s[P],B=j.measureText(b,f,l,!1);B.lineHeight=B.height;var M=x*B.width*p,te=B.height*p,q=M+g*2,A=te+g*2;if(_=!1,b!==`
`&&b!=="\r"&&b!=="	"&&b!==" "&&(_=!0,m=Math.ceil(Math.max(A,m))),c+q>512&&(v+=m,m=A,c=0,v+m>512)){h.update();var D=this._nextPage();l=D.canvasAndContext.canvas,d=D.canvasAndContext.context,h=D.texture.source,v=0}var L=M/p-((C=(T=f.dropShadow)===null||T===void 0?void 0:T.distance)!==null&&C!==void 0?C:0)-((F=(w=f._stroke)===null||w===void 0?void 0:w.width)!==null&&F!==void 0?F:0);if(this.chars[b]={id:b.codePointAt(0),xOffset:-this._padding,yOffset:-this._padding,xAdvance:L,kerning:{}},_){this._drawGlyph(d,B,c+g,v+g,p,f);var H=h.width*p,z=h.height*p,re=new he(c/H*h.width,v/z*h.height,q/H*h.width,A/z*h.height);this.chars[b].texture=new O({source:h,frame:re}),c+=Math.ceil(q)}}h.update(),this._currentX=c,this._currentY=v,this._skipKerning&&this._applyKerning(s,d)}}},{key:"pageTextures",get:function(){return $(N,"BitmapFont.pageTextures is deprecated, please use BitmapFont.pages instead."),this.pages}},{key:"_applyKerning",value:function(t,a){for(var s=this._measureCache,o=0;o<t.length;o++)for(var u=t[o],l=0;l<this._currentChars.length;l++){var d=this._currentChars[l],h=s[u];h||(h=s[u]=a.measureText(u).width);var f=s[d];f||(f=s[d]=a.measureText(d).width);var c=a.measureText(u+d).width,v=c-(h+f);v&&(this.chars[u].kerning[d]=v),c=a.measureText(u+d).width,v=c-(h+f),v&&(this.chars[d].kerning[u]=v)}}},{key:"_nextPage",value:function(){this._currentPageIndex++;var t=this.resolution,a=ne.getOptimalCanvasAndContext(512,512,t);this._setupContext(a.context,this._style,t);var s=t*(this.baseRenderedFontSize/this.baseMeasurementFontSize),o=new O({source:new zt({resource:a.canvas,resolution:s,alphaMode:"premultiply-alpha-on-upload"})}),u={canvasAndContext:a,texture:o};return this.pages[this._currentPageIndex]=u,u}},{key:"_setupContext",value:function(t,a,s){var o;a.fontSize=this.baseRenderedFontSize,t.scale(s,s),t.font=ye(a),a.fontSize=this.baseMeasurementFontSize,t.textBaseline=a.textBaseline;var u=a._stroke,l=(o=u==null?void 0:u.width)!==null&&o!==void 0?o:0;if(u&&(t.lineWidth=l,t.lineJoin=u.join,t.miterLimit=u.miterLimit,t.strokeStyle=ce(u,t)),a._fill&&(t.fillStyle=ce(a._fill,t)),a.dropShadow){var d=a.dropShadow,h=Z.shared.setValue(d.color).toArray(),f=d.blur*s,c=d.distance*s;t.shadowColor="rgba(".concat(h[0]*255,",").concat(h[1]*255,",").concat(h[2]*255,",").concat(d.alpha,")"),t.shadowBlur=f,t.shadowOffsetX=Math.cos(d.angle)*c,t.shadowOffsetY=Math.sin(d.angle)*c}else t.shadowColor="black",t.shadowBlur=0,t.shadowOffsetX=0,t.shadowOffsetY=0}},{key:"_drawGlyph",value:function(t,a,s,o,u,l){var d,h=a.text,f=a.fontProperties,c=l._stroke,v=((d=c==null?void 0:c.width)!==null&&d!==void 0?d:0)*u,p=s+v/2,g=o-v/2,x=f.descent*u,m=a.lineHeight*u;l.stroke&&v&&t.strokeText(h,p,g+m-x),l._fill&&t.fillText(h,p,g+m-x)}},{key:"destroy",value:function(){Pe(ie(e.prototype),"destroy",this).call(this);for(var t=0;t<this.pages.length;t++){var a=this.pages[t],s=a.canvasAndContext,o=a.texture;ne.returnCanvasAndContext(s),o.destroy(!0)}this.pages=null}}]),e}(ht);function ft(i,n,e){var r={width:0,height:0,offsetY:0,scale:n.fontSize/e.baseMeasurementFontSize,lines:[{width:0,charPositions:[],spaceWidth:0,spacesIndex:[],chars:[]}]};r.offsetY=e.baseLineOffset;for(var t=r.lines[0],a=null,s=!0,o={spaceWord:!1,width:0,start:0,index:0,positions:[],chars:[]},u=function(w){for(var b=t.width,B=0;B<o.index;B++){var M=w.positions[B];t.chars.push(w.chars[B]),t.charPositions.push(M+b)}t.width+=w.width,s=!1,o.width=0,o.index=0,o.chars.length=0},l=function(){for(var w=t.chars.length-1,b=t.chars[w];b===" ";)t.width-=e.chars[b].xAdvance,b=t.chars[--w];r.width=Math.max(r.width,t.width),t={width:0,charPositions:[],chars:[],spaceWidth:0,spacesIndex:[]},s=!0,r.lines.push(t),r.height+=e.lineHeight},d=e.baseMeasurementFontSize/n.fontSize,h=n.letterSpacing*d,f=n.wordWrapWidth*d,c=0;c<i.length+1;c++){var v=void 0,p=c===i.length;p||(v=i[c]);var g=e.chars[v]||e.chars[" "],x=/(?:\s)/.test(v),m=x||v==="\r"||v===`
`||p;if(m){var _=!s&&n.wordWrap&&t.width+o.width-h>f;if(_?(l(),u(o),p||t.charPositions.push(0)):(o.start=t.width,u(o),p||t.charPositions.push(0)),v==="\r"||v===`
`)t.width!==0&&l();else if(!p){var P=g.xAdvance+(g.kerning[a]||0)+h;t.width+=P,t.spaceWidth=P,t.spacesIndex.push(t.charPositions.length),t.chars.push(v)}}else{var C=g.kerning[a]||0,T=g.xAdvance+C+h;o.positions[o.index++]=o.width+C,o.chars.push(v),o.width+=T}a=v}return l(),n.align==="center"?Zt(r):n.align==="right"?er(r):n.align==="justify"&&tr(r),r}function Zt(i){for(var n=0;n<i.lines.length;n++)for(var e=i.lines[n],r=i.width/2-e.width/2,t=0;t<e.charPositions.length;t++)e.charPositions[t]+=r}function er(i){for(var n=0;n<i.lines.length;n++)for(var e=i.lines[n],r=i.width-e.width,t=0;t<e.charPositions.length;t++)e.charPositions[t]+=r}function tr(i){for(var n=i.width,e=0;e<i.lines.length;e++)for(var r=i.lines[e],t=0,a=r.spacesIndex[t++],s=0,o=r.spacesIndex.length,u=(n-r.width)/o,l=u,d=0;d<r.charPositions.length;d++)d===a&&(a=r.spacesIndex[t++],s+=l),r.charPositions[d]+=s}var rr=function(){function i(){k(this,i),this.ALPHA=[["a","z"],["A","Z"]," "],this.NUMERIC=[["0","9"]],this.ALPHANUMERIC=[["a","z"],["A","Z"],["0","9"]," "],this.ASCII=[[" ","~"]],this.defaultOptions={chars:this.ALPHANUMERIC,resolution:1,padding:4,skipKerning:!1}}return S(i,[{key:"getFont",value:function(e,r){var t,a="".concat(r.fontFamily,"-bitmap"),s=!0;if(r._fill.fill&&(a+=r._fill.fill.uid,s=!1),!W.has(a)){var o=new Ie(J({style:r,overrideFill:s,overrideSize:!0},this.defaultOptions));o.once("destroy",function(){return W.remove(a)}),W.set(a,o)}var u=W.get(a);return(t=u.ensureCharacters)===null||t===void 0||t.call(u,e),u}},{key:"getLayout",value:function(e,r){var t=this.getFont(e,r);return ft(e.split(""),r,t)}},{key:"measureText",value:function(e,r){return this.getLayout(e,r)}},{key:"install",value:function(){var e,r=arguments.length<=0?void 0:arguments[0];if(typeof r=="string"){var t,a,s,o;r={name:r,style:arguments.length<=1?void 0:arguments[1],chars:(t=arguments.length<=2?void 0:arguments[2])===null||t===void 0?void 0:t.chars,resolution:(a=arguments.length<=2?void 0:arguments[2])===null||a===void 0?void 0:a.resolution,padding:(s=arguments.length<=2?void 0:arguments[2])===null||s===void 0?void 0:s.padding,skipKerning:(o=arguments.length<=2?void 0:arguments[2])===null||o===void 0?void 0:o.skipKerning},$(N,"BitmapFontManager.install(name, style, options) is deprecated, use BitmapFontManager.install({name, style, ...options})")}var u=(e=r)===null||e===void 0?void 0:e.name;if(!u)throw new Error("[BitmapFontManager] Property `name` is required.");r=J(J({},this.defaultOptions),r);var l=r.style,d=l instanceof be?l:new be(l),h=d._fill.fill!==null&&d._fill.fill!==void 0,f=new Ie({style:d,overrideFill:h,skipKerning:r.skipKerning,padding:r.padding,resolution:r.resolution,overrideSize:!1}),c=ct(r.chars);return f.ensureCharacters(c.join("")),W.set("".concat(u,"-bitmap"),f),f.once("destroy",function(){return W.remove("".concat(u,"-bitmap"))}),f}},{key:"uninstall",value:function(e){var r="".concat(e,"-bitmap"),t=W.get(r);t&&(W.remove(r),t.destroy())}}]),i}(),we=new rr;function ar(i){var n=i._stroke,e=i._fill,r=["color: ".concat(Z.shared.setValue(e.color).toHex()),"font-size: ".concat(i.fontSize,"px"),"font-family: ".concat(i.fontFamily),"font-weight: ".concat(i.fontWeight),"font-style: ".concat(i.fontStyle),"font-variant: ".concat(i.fontVariant),"letter-spacing: ".concat(i.letterSpacing,"px"),"text-align: ".concat(i.align),"padding: ".concat(i.padding,"px"),"white-space: ".concat(i.whiteSpace==="pre"&&i.wordWrap?"pre-wrap":i.whiteSpace)].concat(Q(i.lineHeight?["line-height: ".concat(i.lineHeight,"px")]:[]),Q(i.wordWrap?["word-wrap: ".concat(i.breakWords?"break-all":"break-word"),"max-width: ".concat(i.wordWrapWidth,"px")]:[]),Q(n?[pt(n)]:[]),Q(i.dropShadow?[vt(i.dropShadow)]:[]),Q(i.cssOverrides)).join(";"),t=["div { ".concat(r," }")];return nr(i.tagStyles,t),t.join(" ")}function vt(i){var n=Z.shared.setValue(i.color).setAlpha(i.alpha).toHexa(),e=Math.round(Math.cos(i.angle)*i.distance),r=Math.round(Math.sin(i.angle)*i.distance),t="".concat(e,"px ").concat(r,"px");return i.blur>0?"text-shadow: ".concat(t," ").concat(i.blur,"px ").concat(n):"text-shadow: ".concat(t," ").concat(n)}function pt(i){return["-webkit-text-stroke-width: ".concat(i.width,"px"),"-webkit-text-stroke-color: ".concat(Z.shared.setValue(i.color).toHex()),"text-stroke-width: ".concat(i.width,"px"),"text-stroke-color: ".concat(Z.shared.setValue(i.color).toHex()),"paint-order: stroke"].join(";")}var We={fontSize:"font-size: {{VALUE}}px",fontFamily:"font-family: {{VALUE}}",fontWeight:"font-weight: {{VALUE}}",fontStyle:"font-style: {{VALUE}}",fontVariant:"font-variant: {{VALUE}}",letterSpacing:"letter-spacing: {{VALUE}}px",align:"text-align: {{VALUE}}",padding:"padding: {{VALUE}}px",whiteSpace:"white-space: {{VALUE}}",lineHeight:"line-height: {{VALUE}}px",wordWrapWidth:"max-width: {{VALUE}}px"},Oe={fill:function(n){return"color: ".concat(Z.shared.setValue(n).toHex())},breakWords:function(n){return"word-wrap: ".concat(n?"break-all":"break-word")},stroke:pt,dropShadow:vt};function nr(i,n){for(var e in i){var r=i[e],t=[];for(var a in r)Oe[a]?t.push(Oe[a](r[a])):We[a]&&t.push(We[a].replace("{{VALUE}}",r[a]));n.push("".concat(e," { ").concat(t.join(";")," }"))}}var ir=function(i){K(e,i);var n=V(e);function e(){var r,t,a,s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return k(this,e),a=n.call(this,s),a._cssOverrides=[],(r=a.cssOverrides)!==null&&r!==void 0||(a.cssOverrides=s.cssOverrides),a.tagStyles=(t=s.tagStyles)!==null&&t!==void 0?t:{},a}return S(e,[{key:"cssOverrides",get:function(){return this._cssOverrides},set:function(t){this._cssOverrides=t instanceof Array?t:[t],this.update()}},{key:"_generateKey",value:function(){return this._styleKey=Ht(this)+this._cssOverrides.join("-"),this._styleKey}},{key:"update",value:function(){this._cssStyle=null,Pe(ie(e.prototype),"update",this).call(this)}},{key:"clone",value:function(){return new e({align:this.align,breakWords:this.breakWords,dropShadow:this.dropShadow,fill:this._fill,fontFamily:this.fontFamily,fontSize:this.fontSize,fontStyle:this.fontStyle,fontVariant:this.fontVariant,fontWeight:this.fontWeight,letterSpacing:this.letterSpacing,lineHeight:this.lineHeight,padding:this.padding,stroke:this._stroke,whiteSpace:this.whiteSpace,wordWrap:this.wordWrap,wordWrapWidth:this.wordWrapWidth,cssOverrides:this.cssOverrides})}},{key:"cssStyle",get:function(){return this._cssStyle||(this._cssStyle=ar(this)),this._cssStyle}},{key:"addOverride",value:function(){for(var t=this,a=arguments.length,s=new Array(a),o=0;o<a;o++)s[o]=arguments[o];var u=s.filter(function(d){return!t.cssOverrides.includes(d)});if(u.length>0){var l;(l=this.cssOverrides).push.apply(l,Q(u)),this.update()}}},{key:"removeOverride",value:function(){for(var t=this,a=arguments.length,s=new Array(a),o=0;o<a;o++)s[o]=arguments[o];var u=s.filter(function(l){return t.cssOverrides.includes(l)});u.length>0&&(this.cssOverrides=this.cssOverrides.filter(function(l){return!u.includes(l)}),this.update())}},{key:"fill",set:function(t){typeof t!="string"&&typeof t!="number"&&se("[HTMLTextStyle] only color fill is not supported by HTMLText"),Ge(ie(e.prototype),"fill",t,this,!0)}},{key:"stroke",set:function(t){t&&typeof t!="string"&&typeof t!="number"&&se("[HTMLTextStyle] only color stroke is not supported by HTMLText"),Ge(ie(e.prototype),"stroke",t,this,!0)}}]),e}(be),De="http://www.w3.org/2000/svg",Le="http://www.w3.org/1999/xhtml",gt=S(function i(){k(this,i),this.svgRoot=document.createElementNS(De,"svg"),this.foreignObject=document.createElementNS(De,"foreignObject"),this.domElement=document.createElementNS(Le,"div"),this.styleElement=document.createElementNS(Le,"style"),this.image=new Image;var n=this.foreignObject,e=this.svgRoot,r=this.styleElement,t=this.domElement;n.setAttribute("width","10000"),n.setAttribute("height","10000"),n.style.overflow="hidden",e.appendChild(n),n.appendChild(r),n.appendChild(t)}),Ee;function sr(i,n,e,r){r=r||Ee||(Ee=new gt);var t=r,a=t.domElement,s=t.styleElement,o=t.svgRoot;a.innerHTML="<style>".concat(n.cssStyle,"</style><div>").concat(i,"</div>"),a.setAttribute("style","transform-origin: top left; display: inline-block"),e&&(s.textContent=e),document.body.appendChild(o);var u=a.getBoundingClientRect();o.remove();var l=j.measureFont(n.fontStyle).descent;return{width:u.width,height:u.height+l}}var mt=function(){function i(n,e){k(this,i),this.state=Je.for2d(),this._graphicsBatchesHash=Object.create(null),this.renderer=n,this._adaptor=e,this._adaptor.init()}return S(i,[{key:"validateRenderable",value:function(e){var r=e.context,t=!!this._graphicsBatchesHash[e.uid],a=this.renderer.graphicsContext.updateGpuContext(r);return!!(a.isBatchable||t!==a.isBatchable)}},{key:"addRenderable",value:function(e,r){var t=this.renderer.graphicsContext.updateGpuContext(e.context);e._didGraphicsUpdate&&(e._didGraphicsUpdate=!1,this._rebuild(e)),t.isBatchable?this._addToBatcher(e,r):(this.renderer.renderPipes.batch.break(r),r.add(e))}},{key:"updateRenderable",value:function(e){var r=this._graphicsBatchesHash[e.uid];if(r)for(var t=0;t<r.length;t++){var a=r[t];a.batcher.updateElement(a)}}},{key:"destroyRenderable",value:function(e){this._graphicsBatchesHash[e.uid]&&this._removeBatchForRenderable(e.uid)}},{key:"execute",value:function(e){if(e.isRenderable){var r=this.renderer,t=e.context,a=r.graphicsContext;if(a.getGpuContext(t).batches.length){var s=t.customShader||this._adaptor.shader;this.state.blendMode=e.groupBlendMode;var o=s.resources.localUniforms.uniforms;o.uTransformMatrix=e.groupTransform,o.uRound=r._roundPixels|e._roundPixels,Be(e.groupColorAlpha,o.uColor,0),this._adaptor.execute(this,e)}}}},{key:"_rebuild",value:function(e){var r=!!this._graphicsBatchesHash[e.uid],t=this.renderer.graphicsContext.updateGpuContext(e.context);r&&this._removeBatchForRenderable(e.uid),t.isBatchable&&this._initBatchesForRenderable(e),e.batched=t.isBatchable}},{key:"_addToBatcher",value:function(e,r){for(var t=this.renderer.renderPipes.batch,a=this._getBatchesForRenderable(e),s=0;s<a.length;s++){var o=a[s];t.addToBatch(o,r)}}},{key:"_getBatchesForRenderable",value:function(e){return this._graphicsBatchesHash[e.uid]||this._initBatchesForRenderable(e)}},{key:"_initBatchesForRenderable",value:function(e){var r=this,t=e.context,a=this.renderer.graphicsContext.getGpuContext(t),s=this.renderer._roundPixels|e._roundPixels,o=a.batches.map(function(u){var l=U.get(It);return u.copyTo(l),l.renderable=e,l.roundPixels=s,l});return this._graphicsBatchesHash[e.uid]=o,e.on("destroyed",function(){r.destroyRenderable(e)}),o}},{key:"_removeBatchForRenderable",value:function(e){this._graphicsBatchesHash[e].forEach(function(r){U.return(r)}),this._graphicsBatchesHash[e]=null}},{key:"destroy",value:function(){this.renderer=null,this._adaptor.destroy(),this._adaptor=null,this.state=null;for(var e in this._graphicsBatchesHash)this._removeBatchForRenderable(e);this._graphicsBatchesHash=null}}]),i}();mt.extension={type:[y.WebGLPipes,y.WebGPUPipes,y.CanvasPipes],name:"graphics"};var xt=function(i){K(e,i);var n=V(e);function e(){var r,t;k(this,e),t=n.call(this,{});var a=(r=arguments.length<=0?void 0:arguments[0])!==null&&r!==void 0?r:{};return typeof a=="number"&&($(N,"PlaneGeometry constructor changed please use { width, height, verticesX, verticesY } instead"),a={width:a,height:arguments.length<=1?void 0:arguments[1],verticesX:arguments.length<=2?void 0:arguments[2],verticesY:arguments.length<=3?void 0:arguments[3]}),t.build(a),t}return S(e,[{key:"build",value:function(t){var a,s,o,u;t=J(J({},e.defaultOptions),t),this.verticesX=(a=this.verticesX)!==null&&a!==void 0?a:t.verticesX,this.verticesY=(s=this.verticesY)!==null&&s!==void 0?s:t.verticesY,this.width=(o=this.width)!==null&&o!==void 0?o:t.width,this.height=(u=this.height)!==null&&u!==void 0?u:t.height;for(var l=this.verticesX*this.verticesY,d=[],h=[],f=[],c=this.verticesX-1,v=this.verticesY-1,p=this.width/c,g=this.height/v,x=0;x<l;x++){var m=x%this.verticesX,_=x/this.verticesX|0;d.push(m*p,_*g),h.push(m/c,_/v)}for(var P=c*v,C=0;C<P;C++){var T=C%c,F=C/c|0,w=F*this.verticesX+T,b=F*this.verticesX+T+1,B=(F+1)*this.verticesX+T,M=(F+1)*this.verticesX+T+1;f.push(w,b,B,b,M,B)}this.buffers[0].data=new Float32Array(d),this.buffers[1].data=new Float32Array(h),this.indexBuffer.data=new Uint32Array(f),this.buffers[0].update(),this.buffers[1].update(),this.indexBuffer.update()}}]),e}(Re);xt.defaultOptions={width:100,height:100,verticesX:10,verticesY:10};var or=xt,Me=function(){function i(){k(this,i),this.batcher=null,this.batch=null,this.roundPixels=0,this._uvUpdateId=-1,this._textureMatrixUpdateId=-1}return S(i,[{key:"blendMode",get:function(){return this.mesh.groupBlendMode}},{key:"reset",value:function(){this.mesh=null,this.texture=null,this.batcher=null,this.batch=null}},{key:"packIndex",value:function(e,r,t){for(var a=this.geometry.indices,s=0;s<a.length;s++)e[r++]=a[s]+t}},{key:"packAttributes",value:function(e,r,t,a){var s=this.mesh,o=this.geometry,u=s.groupTransform,l=a<<16|this.roundPixels&65535,d=u.a,h=u.b,f=u.c,c=u.d,v=u.tx,p=u.ty,g=o.positions,x=o.getBuffer("aUV"),m=x.data,_=m,P=this.texture.textureMatrix;P.isSimple||(_=this._transformedUvs,(this._textureMatrixUpdateId!==P._updateID||this._uvUpdateId!==x._updateID)&&((!_||_.length<m.length)&&(_=this._transformedUvs=new Float32Array(m.length)),this._textureMatrixUpdateId=P._updateID,this._uvUpdateId=x._updateID,P.multiplyUvs(m,_)));for(var C=s.groupColorAlpha,T=0;T<g.length;T+=2){var F=g[T],w=g[T+1];e[t]=d*F+f*w+v,e[t+1]=h*F+c*w+p,e[t+2]=_[T],e[t+3]=_[T+1],r[t+4]=C,r[t+5]=l,t+=6}}},{key:"vertexSize",get:function(){return this.geometry.positions.length/2}},{key:"indexSize",get:function(){return this.geometry.indices.length}}]),i}(),_t=function(){function i(n,e){k(this,i),this.localUniforms=new oe({uTransformMatrix:{value:new Y,type:"mat3x3<f32>"},uColor:{value:new Float32Array([1,1,1,1]),type:"vec4<f32>"},uRound:{value:0,type:"f32"}}),this.localUniformsBindGroup=new Qe({0:this.localUniforms}),this._meshDataHash=Object.create(null),this._gpuBatchableMeshHash=Object.create(null),this.renderer=n,this._adaptor=e,this._adaptor.init()}return S(i,[{key:"validateRenderable",value:function(e){var r=this._getMeshData(e),t=r.batched,a=e.batched;if(r.batched=a,t!==a)return!0;if(a){var s=e._geometry;if(s.indices.length!==r.indexSize||s.positions.length!==r.vertexSize)return r.indexSize=s.indices.length,r.vertexSize=s.positions.length,!0;var o=this._getBatchableMesh(e),u=e.texture;if(o.texture._source!==u._source&&o.texture._source!==u._source)return!o.batcher.checkAndUpdateTexture(o,u)}return!1}},{key:"addRenderable",value:function(e,r){var t=this.renderer.renderPipes.batch,a=this._getMeshData(e),s=a.batched;if(s){var o=this._getBatchableMesh(e);o.texture=e._texture,o.geometry=e._geometry,t.addToBatch(o)}else t.break(r),r.add({renderPipeId:"mesh",mesh:e})}},{key:"updateRenderable",value:function(e){if(e.batched){var r=this._gpuBatchableMeshHash[e.uid];r.texture=e._texture,r.geometry=e._geometry,r.batcher.updateElement(r)}}},{key:"destroyRenderable",value:function(e){this._meshDataHash[e.uid]=null;var r=this._gpuBatchableMeshHash[e.uid];r&&(U.return(r),this._gpuBatchableMeshHash[e.uid]=null)}},{key:"execute",value:function(e){var r=e.mesh;if(r.isRenderable){r.state.blendMode=r.groupBlendMode;var t=this.localUniforms;t.uniforms.uTransformMatrix=r.groupTransform,t.uniforms.uRound=this.renderer._roundPixels|r._roundPixels,t.update(),Be(r.groupColorAlpha,t.uniforms.uColor,0),this._adaptor.execute(this,r)}}},{key:"_getMeshData",value:function(e){return this._meshDataHash[e.uid]||this._initMeshData(e)}},{key:"_initMeshData",value:function(e){var r,t,a=this;return this._meshDataHash[e.uid]={batched:e.batched,indexSize:(r=e._geometry.indices)===null||r===void 0?void 0:r.length,vertexSize:(t=e._geometry.positions)===null||t===void 0?void 0:t.length},e.on("destroyed",function(){a.destroyRenderable(e)}),this._meshDataHash[e.uid]}},{key:"_getBatchableMesh",value:function(e){return this._gpuBatchableMeshHash[e.uid]||this._initBatchableMesh(e)}},{key:"_initBatchableMesh",value:function(e){var r=U.get(Me);return r.mesh=e,r.texture=e._texture,r.roundPixels=this.renderer._roundPixels|e._roundPixels,this._gpuBatchableMeshHash[e.uid]=r,r.mesh=e,r}},{key:"destroy",value:function(){for(var e in this._gpuBatchableMeshHash)this._gpuBatchableMeshHash[e]&&U.return(this._gpuBatchableMeshHash[e]);this._gpuBatchableMeshHash=null,this._meshDataHash=null,this.localUniforms=null,this.localUniformsBindGroup=null,this._adaptor.destroy(),this._adaptor=null,this.renderer=null}}]),i}();_t.extension={type:[y.WebGLPipes,y.WebGPUPipes,y.CanvasPipes],name:"mesh"};var yt=function(i){K(e,i);var n=V(e);function e(){var r,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return k(this,e),t=J(J({},e.defaultOptions),t),r=n.call(this,{width:t.width,height:t.height,verticesX:4,verticesY:4}),r.update(t),r}return S(e,[{key:"update",value:function(t){var a,s,o,u,l,d,h,f;this.width=(a=t.width)!==null&&a!==void 0?a:this.width,this.height=(s=t.height)!==null&&s!==void 0?s:this.height,this._originalWidth=(o=t.originalWidth)!==null&&o!==void 0?o:this._originalWidth,this._originalHeight=(u=t.originalHeight)!==null&&u!==void 0?u:this._originalHeight,this._leftWidth=(l=t.leftWidth)!==null&&l!==void 0?l:this._leftWidth,this._rightWidth=(d=t.rightWidth)!==null&&d!==void 0?d:this._rightWidth,this._topHeight=(h=t.topHeight)!==null&&h!==void 0?h:this._topHeight,this._bottomHeight=(f=t.bottomHeight)!==null&&f!==void 0?f:this._bottomHeight,this.updateUvs(),this.updatePositions()}},{key:"updatePositions",value:function(){var t=this.positions,a=this._leftWidth+this._rightWidth,s=this.width>a?1:this.width/a,o=this._topHeight+this._bottomHeight,u=this.height>o?1:this.height/o,l=Math.min(s,u);t[9]=t[11]=t[13]=t[15]=this._topHeight*l,t[17]=t[19]=t[21]=t[23]=this.height-this._bottomHeight*l,t[25]=t[27]=t[29]=t[31]=this.height,t[2]=t[10]=t[18]=t[26]=this._leftWidth*l,t[4]=t[12]=t[20]=t[28]=this.width-this._rightWidth*l,t[6]=t[14]=t[22]=t[30]=this.width,this.getBuffer("aPosition").update()}},{key:"updateUvs",value:function(){var t=this.uvs;t[0]=t[8]=t[16]=t[24]=0,t[1]=t[3]=t[5]=t[7]=0,t[6]=t[14]=t[22]=t[30]=1,t[25]=t[27]=t[29]=t[31]=1;var a=1/this._originalWidth,s=1/this._originalHeight;t[2]=t[10]=t[18]=t[26]=a*this._leftWidth,t[9]=t[11]=t[13]=t[15]=s*this._topHeight,t[4]=t[12]=t[20]=t[28]=1-a*this._rightWidth,t[17]=t[19]=t[21]=t[23]=1-s*this._bottomHeight,this.getBuffer("aUV").update()}}]),e}(or);yt.defaultOptions={width:100,height:100,leftWidth:10,topHeight:10,rightWidth:10,bottomHeight:10,originalWidth:100,originalHeight:100};var ur=yt,bt=function(){function i(n){k(this,i),this._gpuSpriteHash=Object.create(null),this._renderer=n}return S(i,[{key:"addRenderable",value:function(e,r){var t=this._getGpuSprite(e);e._didSpriteUpdate&&this._updateBatchableSprite(e,t),this._renderer.renderPipes.batch.addToBatch(t)}},{key:"updateRenderable",value:function(e){var r=this._gpuSpriteHash[e.uid];e._didSpriteUpdate&&this._updateBatchableSprite(e,r),r.batcher.updateElement(r)}},{key:"validateRenderable",value:function(e){var r=e._texture,t=this._getGpuSprite(e);return t.texture._source!==r._source?!t.batcher.checkAndUpdateTexture(t,r):!1}},{key:"destroyRenderable",value:function(e){var r=this._gpuSpriteHash[e.uid];U.return(r),this._gpuSpriteHash[e.uid]=null}},{key:"_updateBatchableSprite",value:function(e,r){e._didSpriteUpdate=!1,r.geometry.update(e),r.texture=e._texture}},{key:"_getGpuSprite",value:function(e){return this._gpuSpriteHash[e.uid]||this._initGPUSprite(e)}},{key:"_initGPUSprite",value:function(e){var r=this,t=new Me;return t.geometry=new ur,t.mesh=e,t.texture=e._texture,t.roundPixels=this._renderer._roundPixels|e._roundPixels,this._gpuSpriteHash[e.uid]=t,e.on("destroyed",function(){r.destroyRenderable(e)}),t}},{key:"destroy",value:function(){for(var e in this._gpuSpriteHash){var r=this._gpuSpriteHash[e];r.geometry.destroy()}this._gpuSpriteHash=null,this._renderer=null}}]),i}();bt.extension={type:[y.WebGLPipes,y.WebGPUPipes,y.CanvasPipes],name:"nineSliceSprite"};var lr={name:"tiling-bit",vertex:{header:`
            struct TilingUniforms {
                uMapCoord:mat3x3<f32>,
                uClampFrame:vec4<f32>,
                uClampOffset:vec2<f32>,
                uTextureTransform:mat3x3<f32>,
                uSizeAnchor:vec4<f32>
            };

            @group(2) @binding(0) var<uniform> tilingUniforms: TilingUniforms;
            @group(2) @binding(1) var uTexture: texture_2d<f32>;
            @group(2) @binding(2) var uSampler: sampler;
        `,main:`
            uv = (tilingUniforms.uTextureTransform * vec3(uv, 1.0)).xy;

            position = (position - tilingUniforms.uSizeAnchor.zw) * tilingUniforms.uSizeAnchor.xy;
        `},fragment:{header:`
            struct TilingUniforms {
                uMapCoord:mat3x3<f32>,
                uClampFrame:vec4<f32>,
                uClampOffset:vec2<f32>,
                uTextureTransform:mat3x3<f32>,
                uSizeAnchor:vec4<f32>
            };

            @group(2) @binding(0) var<uniform> tilingUniforms: TilingUniforms;
            @group(2) @binding(1) var uTexture: texture_2d<f32>;
            @group(2) @binding(2) var uSampler: sampler;
        `,main:`

            var coord = vUV + ceil(tilingUniforms.uClampOffset - vUV);
            coord = (tilingUniforms.uMapCoord * vec3(coord, 1.0)).xy;
            var unclamped = coord;
            coord = clamp(coord, tilingUniforms.uClampFrame.xy, tilingUniforms.uClampFrame.zw);

            var bias = 0.;

            if(unclamped.x == coord.x && unclamped.y == coord.y)
            {
                bias = -32.;
            } 

            outColor = textureSampleBias(uTexture, uSampler, coord, bias);
        `}},dr={name:"tiling-bit",vertex:{header:`
            uniform mat3 uTextureTransform;
            uniform vec4 uSizeAnchor;
        
        `,main:`
            uv = (uTextureTransform * vec3(aUV, 1.0)).xy;

            position = (position - uSizeAnchor.zw) * uSizeAnchor.xy;
        `},fragment:{header:`
            uniform sampler2D uTexture;
            uniform mat3 uMapCoord;
            uniform vec4 uClampFrame;
            uniform vec2 uClampOffset;
        `,main:`

        vec2 coord = vUV + ceil(uClampOffset - vUV);
        coord = (uMapCoord * vec3(coord, 1.0)).xy;
        vec2 unclamped = coord;
        coord = clamp(coord, uClampFrame.xy, uClampFrame.zw);
        
        outColor = texture(uTexture, coord, unclamped == coord ? 0.0 : -32.0);// lod-bias very negative to force lod 0
    
        `}},me,xe,hr=function(i){K(e,i);var n=V(e);function e(){var r,t;k(this,e),(r=me)!==null&&r!==void 0||(me=et({name:"tiling-sprite-shader",bits:[Et,lr,rt]})),(t=xe)!==null&&t!==void 0||(xe=tt({name:"tiling-sprite-shader",bits:[Xt,dr,at]}));var a=new oe({uMapCoord:{value:new Y,type:"mat3x3<f32>"},uClampFrame:{value:new Float32Array([0,0,1,1]),type:"vec4<f32>"},uClampOffset:{value:new Float32Array([0,0]),type:"vec2<f32>"},uTextureTransform:{value:new Y,type:"mat3x3<f32>"},uSizeAnchor:{value:new Float32Array([100,100,.5,.5]),type:"vec4<f32>"}});return n.call(this,{glProgram:xe,gpuProgram:me,resources:{localUniforms:new oe({uTransformMatrix:{value:new Y,type:"mat3x3<f32>"},uColor:{value:new Float32Array([1,1,1,1]),type:"vec4<f32>"},uRound:{value:0,type:"f32"}}),tilingUniforms:a,uTexture:O.EMPTY.source,uSampler:O.EMPTY.source.style}})}return S(e,[{key:"updateUniforms",value:function(t,a,s,o,u,l){var d=this.resources.tilingUniforms,h=l.width,f=l.height,c=l.textureMatrix,v=d.uniforms.uTextureTransform;v.set(s.a*h/t,s.b*h/a,s.c*f/t,s.d*f/a,s.tx/t,s.ty/a),v.invert(),d.uniforms.uMapCoord=c.mapCoord,d.uniforms.uClampFrame=c.uClampFrame,d.uniforms.uClampOffset=c.uClampOffset,d.uniforms.uTextureTransform=v,d.uniforms.uSizeAnchor[0]=t,d.uniforms.uSizeAnchor[1]=a,d.uniforms.uSizeAnchor[2]=o,d.uniforms.uSizeAnchor[3]=u,l&&(this.resources.uTexture=l.source,this.resources.uSampler=l.source.style)}}]),e}(Ze),cr=function(i){K(e,i);var n=V(e);function e(){return k(this,e),n.call(this,{positions:new Float32Array([0,0,1,0,1,1,0,1]),uvs:new Float32Array([0,0,1,0,1,1,0,1]),indices:new Uint32Array([0,1,2,0,2,3])})}return S(e)}(Re);function fr(i,n){var e=i.anchor.x,r=i.anchor.y;n[0]=-e*i.width,n[1]=-r*i.height,n[2]=(1-e)*i.width,n[3]=-r*i.height,n[4]=(1-e)*i.width,n[5]=(1-r)*i.height,n[6]=-e*i.width,n[7]=(1-r)*i.height}function vr(i,n,e,r){var t=0,a=i.length/(n||2),s=r.a,o=r.b,u=r.c,l=r.d,d=r.tx,h=r.ty;for(e*=n;t<a;){var f=i[e],c=i[e+1];i[e]=s*f+u*c+d,i[e+1]=o*f+l*c+h,e+=n,t++}}function pr(i,n){var e=i.texture,r=e.frame.width,t=e.frame.height,a=0,s=0;i._applyAnchorToTexture&&(a=i.anchor.x,s=i.anchor.y),n[0]=n[6]=-a,n[2]=n[4]=1-a,n[1]=n[3]=-s,n[5]=n[7]=1-s;var o=Y.shared;o.copyFrom(i._tileTransform.matrix),o.tx/=i.width,o.ty/=i.height,o.invert(),o.scale(i.width/r,i.height/t),vr(n,2,0,o)}var le=new cr,Tt=function(){function i(n){k(this,i),this._tilingSpriteDataHash=Object.create(null),this._renderer=n}return S(i,[{key:"validateRenderable",value:function(e){var r=this._getTilingSpriteData(e),t=r.canBatch;this._updateCanBatch(e);var a=r.canBatch;if(a&&a===t){var s=r.batchableMesh;if(s.texture._source!==e.texture._source)return!s.batcher.checkAndUpdateTexture(s,e.texture)}return t!==a}},{key:"addRenderable",value:function(e,r){var t=this._renderer.renderPipes.batch;this._updateCanBatch(e);var a=this._getTilingSpriteData(e),s=a.geometry,o=a.canBatch;if(o){a.batchableMesh||(a.batchableMesh=new Me);var u=a.batchableMesh;e._didTilingSpriteUpdate&&(e._didTilingSpriteUpdate=!1,this._updateBatchableMesh(e),u.geometry=s,u.mesh=e,u.texture=e._texture),u.roundPixels=this._renderer._roundPixels|e._roundPixels,t.addToBatch(u)}else t.break(r),a.shader||(a.shader=new hr),this.updateRenderable(e),r.add(e)}},{key:"execute",value:function(e){var r=this._tilingSpriteDataHash[e.uid].shader;r.groups[0]=this._renderer.globalUniforms.bindGroup;var t=r.resources.localUniforms.uniforms;t.uTransformMatrix=e.groupTransform,t.uRound=this._renderer._roundPixels|e._roundPixels,Be(e.groupColorAlpha,t.uColor,0),this._renderer.encoder.draw({geometry:le,shader:r,state:Je.default2d})}},{key:"updateRenderable",value:function(e){var r=this._getTilingSpriteData(e),t=r.canBatch;if(t){var a=r.batchableMesh;e._didTilingSpriteUpdate&&this._updateBatchableMesh(e),a.batcher.updateElement(a)}else if(e._didTilingSpriteUpdate){var s=r.shader;s.updateUniforms(e.width,e.height,e._tileTransform.matrix,e.anchor.x,e.anchor.y,e.texture)}e._didTilingSpriteUpdate=!1}},{key:"destroyRenderable",value:function(e){var r,t=this._getTilingSpriteData(e);t.batchableMesh=null,(r=t.shader)===null||r===void 0||r.destroy(),this._tilingSpriteDataHash[e.uid]=null}},{key:"_getTilingSpriteData",value:function(e){return this._tilingSpriteDataHash[e.uid]||this._initTilingSpriteData(e)}},{key:"_initTilingSpriteData",value:function(e){var r=this,t=new Re({indices:le.indices,positions:le.positions.slice(),uvs:le.uvs.slice()});return this._tilingSpriteDataHash[e.uid]={canBatch:!0,renderable:e,geometry:t},e.on("destroyed",function(){r.destroyRenderable(e)}),this._tilingSpriteDataHash[e.uid]}},{key:"_updateBatchableMesh",value:function(e){var r=this._getTilingSpriteData(e),t=r.geometry,a=e.texture.source.style;a.addressMode!=="repeat"&&(a.addressMode="repeat",a.update()),pr(e,t.uvs),fr(e,t.positions)}},{key:"destroy",value:function(){for(var e in this._tilingSpriteDataHash)this.destroyRenderable(this._tilingSpriteDataHash[e].renderable);this._tilingSpriteDataHash=null,this._renderer=null}},{key:"_updateCanBatch",value:function(e){var r=this._getTilingSpriteData(e),t=e.texture,a=!0;return this._renderer.type===Fe.WEBGL&&(a=this._renderer.context.supports.nonPowOf2wrapping),r.canBatch=t.textureMatrix.isSimple&&(a||t.source.isPowerOfTwo),r.canBatch}}]),i}();Tt.extension={type:[y.WebGLPipes,y.WebGPUPipes,y.CanvasPipes],name:"tilingSprite"};var _e={test:function(n){return typeof n=="string"&&n.startsWith("info face=")},parse:function(n){var e,r=n.match(/^[a-z]+\s+.+$/gm),t={info:[],common:[],page:[],char:[],chars:[],kerning:[],kernings:[],distanceField:[]};for(var a in r){var s=r[a].match(/^[a-z]+/gm)[0],o=r[a].match(/[a-zA-Z]+=([^\s"']+|"([^"]*)")/gm),u={};for(var l in o){var d=o[l].split("="),h=d[0],f=d[1].replace(/"/gm,""),c=parseFloat(f),v=isNaN(c)?f:c;u[h]=v}t[s].push(u)}var p={chars:{},pages:[],lineHeight:0,fontSize:0,fontFamily:"",distanceField:null,baseLineOffset:0},g=pe(t.info,1),x=g[0],m=pe(t.common,1),_=m[0],P=(e=t.distanceField)!==null&&e!==void 0?e:[],C=pe(P,1),T=C[0];T&&(p.distanceField={range:parseInt(T.distanceRange,10),type:T.fieldType}),p.fontSize=parseInt(x.size,10),p.fontFamily=x.face,p.lineHeight=parseInt(_.lineHeight,10);for(var F=t.page,w=0;w<F.length;w++)p.pages.push({id:parseInt(F[w].id,10)||0,file:F[w].file});var b={};p.baseLineOffset=p.lineHeight-parseInt(_.base,10);for(var B=t.char,M=0;M<B.length;M++){var te,q,A=B[M],D=parseInt(A.id,10),L=(te=(q=A.letter)!==null&&q!==void 0?q:A.char)!==null&&te!==void 0?te:String.fromCharCode(D);L==="space"&&(L=" "),b[D]=L,p.chars[L]={id:D,page:parseInt(A.page,10)||0,x:parseInt(A.x,10),y:parseInt(A.y,10),width:parseInt(A.width,10),height:parseInt(A.height,10),xOffset:parseInt(A.xoffset,10),yOffset:parseInt(A.yoffset,10),xAdvance:parseInt(A.xadvance,10),kerning:{}}}for(var H=t.kerning||[],z=0;z<H.length;z++){var re=parseInt(H[z].first,10),ee=parseInt(H[z].second,10),I=parseInt(H[z].amount,10);p.chars[b[ee]].kerning[b[re]]=I}return p}},Xe={test:function(n){var e=n;return typeof e!="string"&&"getElementsByTagName"in e&&e.getElementsByTagName("page").length&&e.getElementsByTagName("info")[0].getAttribute("face")!==null},parse:function(n){var e={chars:{},pages:[],lineHeight:0,fontSize:0,fontFamily:"",distanceField:null,baseLineOffset:0},r=n.getElementsByTagName("info")[0],t=n.getElementsByTagName("common")[0],a=n.getElementsByTagName("distanceField")[0];a&&(e.distanceField={type:a.getAttribute("fieldType"),range:parseInt(a.getAttribute("distanceRange"),10)});var s=n.getElementsByTagName("page"),o=n.getElementsByTagName("char"),u=n.getElementsByTagName("kerning");e.fontSize=parseInt(r.getAttribute("size"),10),e.fontFamily=r.getAttribute("face"),e.lineHeight=parseInt(t.getAttribute("lineHeight"),10);for(var l=0;l<s.length;l++)e.pages.push({id:parseInt(s[l].getAttribute("id"),10)||0,file:s[l].getAttribute("file")});var d={};e.baseLineOffset=e.lineHeight-parseInt(t.getAttribute("base"),10);for(var h=0;h<o.length;h++){var f,c,v=o[h],p=parseInt(v.getAttribute("id"),10),g=(f=(c=v.getAttribute("letter"))!==null&&c!==void 0?c:v.getAttribute("char"))!==null&&f!==void 0?f:String.fromCharCode(p);g==="space"&&(g=" "),d[p]=g,e.chars[g]={id:p,page:parseInt(v.getAttribute("page"),10)||0,x:parseInt(v.getAttribute("x"),10),y:parseInt(v.getAttribute("y"),10),width:parseInt(v.getAttribute("width"),10),height:parseInt(v.getAttribute("height"),10),xOffset:parseInt(v.getAttribute("xoffset"),10),yOffset:parseInt(v.getAttribute("yoffset"),10),xAdvance:parseInt(v.getAttribute("xadvance"),10),kerning:{}}}for(var x=0;x<u.length;x++){var m=parseInt(u[x].getAttribute("first"),10),_=parseInt(u[x].getAttribute("second"),10),P=parseInt(u[x].getAttribute("amount"),10);e.chars[d[_]].kerning[d[m]]=P}return e}},Ye={test:function(n){return typeof n=="string"&&n.includes("<font>")?Xe.test(ue.get().parseXML(n)):!1},parse:function(n){return Xe.parse(ue.get().parseXML(n))}},wt=function(i){K(e,i);var n=V(e);function e(r,t){var a,s;k(this,e),s=n.call(this);var o=r.textures,u=r.data;return Object.keys(u.pages).forEach(function(l){var d=u.pages[parseInt(l,10)],h=o[d.id];s.pages.push({texture:h})}),Object.keys(u.chars).forEach(function(l){var d,h=u.chars[l],f=o[h.page].source,c=new he(h.x,h.y,h.width,h.height),v=new O({source:f,frame:c});s.chars[l]={id:l.codePointAt(0),xOffset:h.xOffset,yOffset:h.yOffset,xAdvance:h.xAdvance,kerning:(d=h.kerning)!==null&&d!==void 0?d:{},texture:v}}),s.baseRenderedFontSize=u.fontSize,s.baseMeasurementFontSize=u.fontSize,s.fontMetrics={ascent:0,descent:0,fontSize:u.fontSize},s.baseLineOffset=u.baseLineOffset,s.lineHeight=u.lineHeight,s.fontFamily=u.fontFamily,s.distanceField=(a=u.distanceField)!==null&&a!==void 0?a:{type:"none",range:0},s.url=t,s}return S(e,[{key:"destroy",value:function(){Pe(ie(e.prototype),"destroy",this).call(this);for(var t=0;t<this.pages.length;t++){var a=this.pages[t].texture;a.destroy(!0)}this.pages=null}}],[{key:"install",value:function(t){we.install(t)}},{key:"uninstall",value:function(t){we.uninstall(t)}}]),e}(ht),gr=[".xml",".fnt"],mr={extension:y.CacheParser,test:function(n){return n instanceof wt},getCacheableAssets:function(n,e){var r={};return n.forEach(function(t){r[t]=e}),r["".concat(e.fontFamily,"-bitmap")]=e,r}},xr={extension:{type:y.LoadParser,priority:Wt.Normal},test:function(n){return gr.includes(ge.extname(n).toLowerCase())},testParse:function(n){return X(R().mark(function e(){return R().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",_e.test(n)||Ye.test(n));case 1:case"end":return t.stop()}},e)}))()},parse:function(n,e,r){return X(R().mark(function t(){var a,s,o,u,l,d,h,f,c,v;return R().wrap(function(g){for(;;)switch(g.prev=g.next){case 0:for(a=_e.test(n)?_e.parse(n):Ye.parse(n),s=e.src,o=a.pages,u=[],l=0;l<o.length;++l)d=o[l].file,h=ge.join(ge.dirname(s),d),h=Ot(h,s),u.push(h);return g.next=7,r.load(u);case 7:return f=g.sent,c=u.map(function(x){return f[x]}),v=new wt({data:a,textures:c},s),g.abrupt("return",v);case 11:case"end":return g.stop()}},t)}))()},load:function(n,e){return X(R().mark(function r(){var t;return R().wrap(function(s){for(;;)switch(s.prev=s.next){case 0:return s.next=2,ue.get().fetch(n);case 2:return t=s.sent,s.next=5,t.text();case 5:return s.abrupt("return",s.sent);case 6:case"end":return s.stop()}},r)}))()},unload:function(n,e,r){return X(R().mark(function t(){return R().wrap(function(s){for(;;)switch(s.prev=s.next){case 0:return s.next=2,Promise.all(n.pages.map(function(o){return r.unload(o.texture.source._sourceOrigin)}));case 2:n.destroy();case 3:case"end":return s.stop()}},t)}))()}},_r={name:"local-uniform-msdf-bit",vertex:{header:`
            struct LocalUniforms {
                uColor:vec4<f32>,
                uTransformMatrix:mat3x3<f32>,
                uDistance: f32,
                uRound:f32,
            }

            @group(2) @binding(0) var<uniform> localUniforms : LocalUniforms;
        `,main:`
            vColor *= localUniforms.uColor;
            modelMatrix *= localUniforms.uTransformMatrix;
        `,end:`
            if(localUniforms.uRound == 1)
            {
                vPosition = vec4(roundPixels(vPosition.xy, globalUniforms.uResolution), vPosition.zw);
            }
        `},fragment:{header:`
            struct LocalUniforms {
                uColor:vec4<f32>,
                uTransformMatrix:mat3x3<f32>,
                uDistance: f32
            }

            @group(2) @binding(0) var<uniform> localUniforms : LocalUniforms;
         `,main:` 
            outColor = vColor * calculateMSDFAlpha(outColor, localUniforms.uDistance);
        `}},yr={name:"local-uniform-msdf-bit",vertex:{header:`
            uniform mat3 uTransformMatrix;
            uniform vec4 uColor;
            uniform float uRound;
        `,main:`
            vColor *= uColor;
            modelMatrix *= uTransformMatrix;
        `,end:`
            if(uRound == 1.)
            {
                gl_Position.xy = roundPixels(gl_Position.xy, uResolution);
            }
        `},fragment:{header:`
            uniform float uDistance;
         `,main:` 
            outColor = vColor * calculateMSDFAlpha(outColor, uDistance);
        `}},br={name:"msdf-bit",fragment:{header:`
            fn calculateMSDFAlpha(msdfColor:vec4<f32>, distance:f32) -> f32 {
                
                // MSDF
                var median = msdfColor.r + msdfColor.g + msdfColor.b -
                    min(msdfColor.r, min(msdfColor.g, msdfColor.b)) -
                    max(msdfColor.r, max(msdfColor.g, msdfColor.b));
            
                // SDF
                median = min(median, msdfColor.a);

                var screenPxDistance = distance * (median - 0.5);
                var alpha = clamp(screenPxDistance + 0.5, 0.0, 1.0);
                if (median < 0.01) {
                    alpha = 0.0;
                } else if (median > 0.99) {
                    alpha = 1.0;
                }

                return alpha;
            }
        `}},Tr={name:"msdf-bit",fragment:{header:`
            float calculateMSDFAlpha(vec4 msdfColor, float distance) {
                
                // MSDF
                float median = msdfColor.r + msdfColor.g + msdfColor.b -
                                min(msdfColor.r, min(msdfColor.g, msdfColor.b)) -
                                max(msdfColor.r, max(msdfColor.g, msdfColor.b));
               
                // SDF
                median = min(median, msdfColor.a);
            
                float screenPxDistance = distance * (median - 0.5);
                float alpha = clamp(screenPxDistance + 0.5, 0.0, 1.0);
           
                if (median < 0.01) {
                    alpha = 0.0;
                } else if (median > 0.99) {
                    alpha = 1.0;
                }

                return alpha;
            }
        `}},wr=function(i){K(e,i);var n=V(e);function e(){k(this,e);var r=new oe({uColor:{value:new Float32Array([1,1,1,1]),type:"vec4<f32>"},uTransformMatrix:{value:new Y,type:"mat3x3<f32>"},uDistance:{value:4,type:"f32"},uRound:{value:0,type:"f32"}}),t=et({name:"sdf-shader",bits:[Yt,Kt(ze),_r,br,rt]}),a=tt({name:"sdf-shader",bits:[Vt,qt(ze),yr,Tr,at]});return n.call(this,{glProgram:a,gpuProgram:t,resources:{localUniforms:r,batchSamplers:jt}})}return S(e)}(Ze),St=function(){function i(n){k(this,i),this._gpuBitmapText={},this._renderer=n}return S(i,[{key:"validateRenderable",value:function(e){var r=this._getGpuBitmapText(e);return e._didTextUpdate&&(e._didTextUpdate=!1,this._updateContext(e,r)),this._renderer.renderPipes.graphics.validateRenderable(r)}},{key:"addRenderable",value:function(e,r){var t=this._getGpuBitmapText(e);Ke(e,t),e._didTextUpdate&&(e._didTextUpdate=!1,this._updateContext(e,t)),this._renderer.renderPipes.graphics.addRenderable(t,r),t.context.customShader&&this._updateDistanceField(e)}},{key:"destroyRenderable",value:function(e){this._destroyRenderableByUid(e.uid)}},{key:"_destroyRenderableByUid",value:function(e){U.return(this._gpuBitmapText[e]),this._gpuBitmapText[e]=null}},{key:"updateRenderable",value:function(e){var r=this._getGpuBitmapText(e);Ke(e,r),this._renderer.renderPipes.graphics.updateRenderable(r),r.context.customShader&&this._updateDistanceField(e)}},{key:"_updateContext",value:function(e,r){var t,a=r.context,s=we.getFont(e.text,e._style);a.clear(),s.distanceField.type!=="none"&&(a.customShader||(this._sdfShader||(this._sdfShader=new wr),a.customShader=this._sdfShader));var o=Array.from(e.text),u=e._style,l=(((t=u._stroke)===null||t===void 0?void 0:t.width)||0)/2;l+=s.baseLineOffset;var d=ft(o,u,s),h=0,f=u.padding,c=d.scale;a.translate(-e._anchor._x*d.width-f,-e._anchor._y*(d.height+d.offsetY)-f).scale(c,c);for(var v=u._fill.color,p=0;p<d.lines.length;p++){for(var g=d.lines[p],x=0;x<g.charPositions.length;x++){var m=o[h++],_=s.chars[m];_!=null&&_.texture&&a.texture(_.texture,v||"black",Math.round(g.charPositions[x]+_.xOffset),Math.round(l+_.yOffset))}l+=s.lineHeight}}},{key:"_getGpuBitmapText",value:function(e){return this._gpuBitmapText[e.uid]||this.initGpuText(e)}},{key:"initGpuText",value:function(e){var r=this,t=U.get(Dt);return this._gpuBitmapText[e.uid]=t,this._updateContext(e,t),e.on("destroyed",function(){r.destroyRenderable(e)}),this._gpuBitmapText[e.uid]}},{key:"_updateDistanceField",value:function(e){var r,t=this._getGpuBitmapText(e).context,a=e._style.fontFamily,s=W.get("".concat(a,"-bitmap")),o=e.groupTransform,u=o.a,l=o.b,d=o.c,h=o.d,f=Math.sqrt(u*u+l*l),c=Math.sqrt(d*d+h*h),v=(Math.abs(f)+Math.abs(c))/2,p=s.baseRenderedFontSize/e._style.fontSize,g=(r=e.resolution)!==null&&r!==void 0?r:this._renderer.resolution,x=v*s.distanceField.range*(1/p)*g;t.customShader.resources.localUniforms.uniforms.uDistance=x}},{key:"destroy",value:function(){var e;for(var r in this._gpuBitmapText)this._destroyRenderableByUid(r);this._gpuBitmapText=null,(e=this._sdfShader)===null||e===void 0||e.destroy(!0),this._sdfShader=null,this._renderer=null}}]),i}();St.extension={type:[y.WebGLPipes,y.WebGPUPipes,y.CanvasPipes],name:"bitmapText"};function Ke(i,n){n.groupTransform=i.groupTransform,n.groupColorAlpha=i.groupColorAlpha,n.groupColor=i.groupColor,n.groupBlendMode=i.groupBlendMode,n.globalDisplayStatus=i.globalDisplayStatus,n.groupTransform=i.groupTransform,n.localDisplayStatus=i.localDisplayStatus,n.groupAlpha=i.groupAlpha,n._roundPixels=i._roundPixels}var kt=function(){function i(n){k(this,i),this._gpuText=Object.create(null),this._renderer=n}return S(i,[{key:"validateRenderable",value:function(e){var r=this._getGpuText(e),t=e._getKey();return r.textureNeedsUploading?(r.textureNeedsUploading=!1,!0):r.currentKey!==t}},{key:"addRenderable",value:function(e){var r=this._getGpuText(e),t=r.batchableSprite;e._didTextUpdate&&this._updateText(e),this._renderer.renderPipes.batch.addToBatch(t)}},{key:"updateRenderable",value:function(e){var r=this._getGpuText(e),t=r.batchableSprite;e._didTextUpdate&&this._updateText(e),t.batcher.updateElement(t)}},{key:"destroyRenderable",value:function(e){this._destroyRenderableById(e.uid)}},{key:"_destroyRenderableById",value:function(e){var r=this._gpuText[e];this._renderer.htmlText.decreaseReferenceCount(r.currentKey),U.return(r.batchableSprite),this._gpuText[e]=null}},{key:"_updateText",value:function(e){var r=e._getKey(),t=this._getGpuText(e),a=t.batchableSprite;t.currentKey!==r&&this._updateGpuText(e).catch(function(o){console.error(o)}),e._didTextUpdate=!1;var s=e._style.padding;Te(a.bounds,e._anchor,a.texture,s)}},{key:"_updateGpuText",value:function(){var n=X(R().mark(function r(t){var a,s,o,u,l,d,h;return R().wrap(function(c){for(;;)switch(c.prev=c.next){case 0:if(t._didTextUpdate=!1,s=this._getGpuText(t),!s.generatingTexture){c.next=4;break}return c.abrupt("return");case 4:return o=t._getKey(),this._renderer.htmlText.decreaseReferenceCount(s.currentKey),s.generatingTexture=!0,s.currentKey=o,u=(a=t.resolution)!==null&&a!==void 0?a:this._renderer.resolution,c.next=11,this._renderer.htmlText.getManagedTexture(t.text,u,t._style,t._getKey());case 11:l=c.sent,d=s.batchableSprite,d.texture=s.texture=l,s.generatingTexture=!1,s.textureNeedsUploading=!0,t.onViewUpdate(),h=t._style.padding,Te(d.bounds,t._anchor,d.texture,h);case 19:case"end":return c.stop()}},r,this)}));function e(r){return n.apply(this,arguments)}return e}()},{key:"_getGpuText",value:function(e){return this._gpuText[e.uid]||this.initGpuText(e)}},{key:"initGpuText",value:function(e){var r=this,t={texture:O.EMPTY,currentKey:"--",batchableSprite:U.get(nt),textureNeedsUploading:!1,generatingTexture:!1},a=t.batchableSprite;return a.renderable=e,a.texture=O.EMPTY,a.bounds={minX:0,maxX:1,minY:0,maxY:0},a.roundPixels=this._renderer._roundPixels|e._roundPixels,this._gpuText[e.uid]=t,e.on("destroyed",function(){r.destroyRenderable(e)}),t}},{key:"destroy",value:function(){for(var e in this._gpuText)this._destroyRenderableById(e);this._gpuText=null,this._renderer=null}}]),i}();kt.extension={type:[y.WebGLPipes,y.WebGPUPipes,y.CanvasPipes],name:"htmlText"};function Sr(){var i=ue.get().getNavigator(),n=i.userAgent;return/^((?!chrome|android).)*safari/i.test(n)}var kr=new Ne;function Ct(i,n,e,r){var t=kr;t.minX=0,t.minY=0,t.maxX=i.width/r|0,t.maxY=i.height/r|0;var a=E.getOptimalTexture(t.width,t.height,r,!1);return a.source.uploadMethodId="image",a.source.resource=i,a.source.alphaMode="premultiply-alpha-on-upload",a.frame.width=n/r,a.frame.height=e/r,a.source.emit("update",a.source),a.updateUvs(),a}function Cr(i,n){var e=n.fontFamily,r=[],t={},a=/font-family:([^;"\s]+)/g,s=i.match(a);function o(h){t[h]||(r.push(h),t[h]=!0)}if(Array.isArray(e))for(var u=0;u<e.length;u++)o(e[u]);else o(e);s&&s.forEach(function(h){var f=h.split(":")[1].trim();o(f)});for(var l in n.tagStyles){var d=n.tagStyles[l].fontFamily;o(d)}return r}function Fr(i){return Se.apply(this,arguments)}function Se(){return Se=X(R().mark(function i(n){var e,r,t,a;return R().wrap(function(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,ue.get().fetch(n);case 2:return e=o.sent,o.next=5,e.blob();case 5:return r=o.sent,t=new FileReader,o.next=9,new Promise(function(u,l){t.onloadend=function(){return u(t.result)},t.onerror=l,t.readAsDataURL(r)});case 9:return a=o.sent,o.abrupt("return",a);case 11:case"end":return o.stop()}},i)})),Se.apply(this,arguments)}function Ve(i,n){return ke.apply(this,arguments)}function ke(){return ke=X(R().mark(function i(n,e){var r;return R().wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,Fr(e);case 2:return r=a.sent,a.abrupt("return",`@font-face {
        font-family: "`.concat(n.fontFamily,`";
        src: url('`).concat(r,`');
        font-weight: `).concat(n.fontWeight,`;
        font-style: `).concat(n.fontStyle,`;
    }`));case 4:case"end":return a.stop()}},i)})),ke.apply(this,arguments)}var de=new Map;function Pr(i,n,e){return Ce.apply(this,arguments)}function Ce(){return Ce=X(R().mark(function i(n,e,r){var t;return R().wrap(function(s){for(;;)switch(s.prev=s.next){case 0:return t=n.filter(function(o){return W.has("".concat(o,"-and-url"))}).map(function(o,u){if(!de.has(o)){var l=W.get("".concat(o,"-and-url")),d=l.url;u===0?de.set(o,Ve(e,d)):de.set(o,Ve({fontWeight:r.fontWeight,fontStyle:r.fontStyle,fontFamily:o},d))}return de.get(o)}),s.next=3,Promise.all(t);case 3:return s.abrupt("return",s.sent.join(`
`));case 4:case"end":return s.stop()}},i)})),Ce.apply(this,arguments)}function Br(i,n,e,r,t){var a=t.domElement,s=t.styleElement,o=t.svgRoot;a.innerHTML="<style>".concat(n.cssStyle,"</style><div>").concat(i,"</div>"),a.setAttribute("style","transform: scale(".concat(e,");transform-origin: top left; display: inline-block")),s.textContent=r;var u=t.image,l=u.width,d=u.height;return o.setAttribute("width",l.toString()),o.setAttribute("height",d.toString()),new XMLSerializer().serializeToString(o)}function Rr(i,n){var e=ne.getOptimalCanvasAndContext(i.width,i.height,n),r=e.context;return r.clearRect(0,0,i.width,i.height),r.drawImage(i,0,0),ne.returnCanvasAndContext(e),e.canvas}function Mr(i,n,e){return new Promise(function(){var r=X(R().mark(function t(a){return R().wrap(function(o){for(;;)switch(o.prev=o.next){case 0:if(!e){o.next=3;break}return o.next=3,new Promise(function(u){return setTimeout(u,100)});case 3:i.onload=function(){a()},i.src="data:image/svg+xml;charset=utf8,".concat(encodeURIComponent(n)),i.crossOrigin="anonymous";case 6:case"end":return o.stop()}},t)}));return function(t){return r.apply(this,arguments)}}())}var Ae=function(){function i(n){k(this,i),this._activeTextures={},this._renderer=n,this._createCanvas=n.type===Fe.WEBGPU}return S(i,[{key:"getTexture",value:function(e){return this._buildTexturePromise(e.text,e.resolution,e.style)}},{key:"getManagedTexture",value:function(e,r,t,a){var s=this;if(this._activeTextures[a])return this._increaseReferenceCount(a),this._activeTextures[a].promise;var o=this._buildTexturePromise(e,r,t).then(function(u){return s._activeTextures[a].texture=u,u});return this._activeTextures[a]={texture:null,promise:o,usageCount:1},o}},{key:"_buildTexturePromise",value:function(){var n=X(R().mark(function r(t,a,s){var o,u,l,d,h,f,c,v,p,g;return R().wrap(function(m){for(;;)switch(m.prev=m.next){case 0:return o=U.get(gt),u=Cr(t,s),m.next=4,Pr(u,s,ir.defaultTextStyle);case 4:return l=m.sent,d=sr(t,s,l,o),h=Math.ceil(Math.ceil(Math.max(1,d.width)+s.padding*2)*a),f=Math.ceil(Math.ceil(Math.max(1,d.height)+s.padding*2)*a),c=o.image,c.width=h|0,c.height=f|0,v=Br(t,s,a,l,o),m.next=14,Mr(c,v,Sr()&&u.length>0);case 14:return p=c,this._createCanvas&&(p=Rr(c,a)),g=Ct(p,c.width,c.height,a),this._createCanvas&&this._renderer.texture.initSource(g.source),U.return(o),m.abrupt("return",g);case 20:case"end":return m.stop()}},r,this)}));function e(r,t,a){return n.apply(this,arguments)}return e}()},{key:"_increaseReferenceCount",value:function(e){this._activeTextures[e].usageCount++}},{key:"decreaseReferenceCount",value:function(e){var r=this,t=this._activeTextures[e];t&&(t.usageCount--,t.usageCount===0&&(t.texture?this._cleanUp(t):t.promise.then(function(a){t.texture=a,r._cleanUp(t)}).catch(function(){se("HTMLTextSystem: Failed to clean texture")}),this._activeTextures[e]=null))}},{key:"_cleanUp",value:function(e){E.returnTexture(e.texture),e.texture.source.resource=null,e.texture.source.uploadMethodId="unknown"}},{key:"getReferenceCount",value:function(e){return this._activeTextures[e].usageCount}},{key:"destroy",value:function(){this._activeTextures=null}}]),i}();Ae.extension={type:[y.WebGLSystem,y.WebGPUSystem,y.CanvasSystem],name:"htmlText"};Ae.defaultFontOptions={fontFamily:"Arial",fontStyle:"normal",fontWeight:"normal"};var Ft=function(){function i(n){k(this,i),this._gpuText=Object.create(null),this._renderer=n}return S(i,[{key:"validateRenderable",value:function(e){var r=this._getGpuText(e),t=e._getKey();if(r.currentKey!==t){var a,s=(a=e.resolution)!==null&&a!==void 0?a:this._renderer.resolution,o=this._renderer.canvasText.getTextureSize(e.text,s,e._style),u=o.width,l=o.height;return!(this._renderer.canvasText.getReferenceCount(r.currentKey)===1&&u===r.texture._source.width&&l===r.texture._source.height)}return!1}},{key:"addRenderable",value:function(e,r){var t=this._getGpuText(e),a=t.batchableSprite;e._didTextUpdate&&this._updateText(e),this._renderer.renderPipes.batch.addToBatch(a)}},{key:"updateRenderable",value:function(e){var r=this._getGpuText(e),t=r.batchableSprite;e._didTextUpdate&&this._updateText(e),t.batcher.updateElement(t)}},{key:"destroyRenderable",value:function(e){this._destroyRenderableById(e.uid)}},{key:"_destroyRenderableById",value:function(e){var r=this._gpuText[e];this._renderer.canvasText.decreaseReferenceCount(r.currentKey),U.return(r.batchableSprite),this._gpuText[e]=null}},{key:"_updateText",value:function(e){var r=e._getKey(),t=this._getGpuText(e),a=t.batchableSprite;t.currentKey!==r&&this._updateGpuText(e),e._didTextUpdate=!1;var s=e._style.padding;Te(a.bounds,e._anchor,a.texture,s)}},{key:"_updateGpuText",value:function(e){var r,t=this._getGpuText(e),a=t.batchableSprite;t.texture&&this._renderer.canvasText.decreaseReferenceCount(t.currentKey);var s=(r=e.resolution)!==null&&r!==void 0?r:this._renderer.resolution;t.texture=a.texture=this._renderer.canvasText.getTexture(e.text,s,e._style,e._getKey()),t.currentKey=e._getKey(),a.texture=t.texture}},{key:"_getGpuText",value:function(e){return this._gpuText[e.uid]||this.initGpuText(e)}},{key:"initGpuText",value:function(e){var r=this,t={texture:null,currentKey:"--",batchableSprite:U.get(nt)};return t.batchableSprite.renderable=e,t.batchableSprite.bounds={minX:0,maxX:1,minY:0,maxY:0},t.batchableSprite.roundPixels=this._renderer._roundPixels|e._roundPixels,this._gpuText[e.uid]=t,this._updateText(e),e.on("destroyed",function(){r.destroyRenderable(e)}),t}},{key:"destroy",value:function(){for(var e in this._gpuText)this._destroyRenderableById(e);this._gpuText=null,this._renderer=null}}]),i}();Ft.extension={type:[y.WebGLPipes,y.WebGPUPipes,y.CanvasPipes],name:"text"};function qe(i,n,e){for(var r=0,t=4*e*n;r<n;++r,t+=4)if(i[t+3]!==0)return!1;return!0}function je(i,n,e,r,t){for(var a=4*n,s=r,o=r*a+4*e;s<=t;++s,o+=a)if(i[o+3]!==0)return!1;return!0}function Ar(i){var n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,e=i.width,r=i.height,t=i.getContext("2d",{willReadFrequently:!0});if(t===null)throw new TypeError("Failed to get canvas 2D context");for(var a=t.getImageData(0,0,e,r),s=a.data,o=0,u=0,l=e-1,d=r-1;u<r&&qe(s,e,u);)++u;if(u===r)return he.EMPTY;for(;qe(s,e,d);)--d;for(;je(s,e,o,u,d);)++o;for(;je(s,e,l,u,d);)--l;return++l,++d,new he(o/n,u/n,(l-o)/n,(d-u)/n)}var Pt=function(){function i(){k(this,i),this._activeTextures={}}return S(i,[{key:"getTextureSize",value:function(e,r,t){var a=j.measureText(e||" ",t),s=Math.ceil(Math.ceil(Math.max(1,a.width)+t.padding*2)*r),o=Math.ceil(Math.ceil(Math.max(1,a.height)+t.padding*2)*r);return s=Math.ceil(s-1e-6),o=Math.ceil(o-1e-6),s=He(s),o=He(o),{width:s,height:o}}},{key:"getTexture",value:function(e,r,t,a){if(this._activeTextures[a])return this._increaseReferenceCount(a),this._activeTextures[a].texture;var s=j.measureText(e||" ",t),o=Math.ceil(Math.ceil(Math.max(1,s.width)+t.padding*2)*r),u=Math.ceil(Math.ceil(Math.max(1,s.height)+t.padding*2)*r),l=ne.getOptimalCanvasAndContext(o,u),d=l.canvas;this.renderTextToCanvas(e,t,r,l);var h=Ct(d,o,u,r);if(t.trim){var f=Ar(d,r);h.frame.copyFrom(f),h.updateUvs()}return this._activeTextures[a]={canvasAndContext:l,texture:h,usageCount:1},h}},{key:"_increaseReferenceCount",value:function(e){this._activeTextures[e].usageCount++}},{key:"decreaseReferenceCount",value:function(e){var r=this._activeTextures[e];if(r.usageCount--,r.usageCount===0){ne.returnCanvasAndContext(r.canvasAndContext),E.returnTexture(r.texture);var t=r.texture.source;t.resource=null,t.uploadMethodId="unknown",t.alphaMode="no-premultiply-alpha",this._activeTextures[e]=null}}},{key:"getReferenceCount",value:function(e){return this._activeTextures[e].usageCount}},{key:"renderTextToCanvas",value:function(e,r,t,a){var s,o=a.canvas,u=a.context,l=ye(r),d=j.measureText(e||" ",r),h=d.lines,f=d.lineHeight,c=d.lineWidths,v=d.maxLineWidth,p=d.fontProperties,g=o.height;if(u.resetTransform(),u.scale(t,t),u.clearRect(0,0,d.width+4,d.height+4),(s=r._stroke)!==null&&s!==void 0&&s.width){var x=r._stroke;u.lineWidth=x.width,u.miterLimit=x.miterLimit,u.lineJoin=x.join,u.lineCap=x.cap}u.font=l;for(var m,_,P=r.dropShadow?2:1,C=0;C<P;++C){var T,F,w=r.dropShadow&&C===0,b=w?Math.ceil(Math.max(1,g)+r.padding*2):0,B=b*t;if(w){u.fillStyle="black",u.strokeStyle="black";var M=r.dropShadow,te=M.color,q=M.alpha;u.shadowColor=Z.shared.setValue(te).setAlpha(q).toRgbaString();var A=M.blur*t,D=M.distance*t;u.shadowBlur=A,u.shadowOffsetX=Math.cos(M.angle)*D,u.shadowOffsetY=Math.sin(M.angle)*D+B}else{var L,H,z;u.globalAlpha=(L=(H=r._fill)===null||H===void 0?void 0:H.alpha)!==null&&L!==void 0?L:1,u.fillStyle=r._fill?ce(r._fill,u):null,(z=r._stroke)!==null&&z!==void 0&&z.width&&(u.strokeStyle=ce(r._stroke,u)),u.shadowColor="black"}var re=(f-p.fontSize)/2;f-p.fontSize<0&&(re=0);for(var ee=(T=(F=r._stroke)===null||F===void 0?void 0:F.width)!==null&&T!==void 0?T:0,I=0;I<h.length;I++)m=ee/2,_=ee/2+I*f+p.ascent+re,r.align==="right"?m+=v-c[I]:r.align==="center"&&(m+=(v-c[I])/2),r._stroke&&this._drawLetterSpacing(h[I],r,a,m+r.padding,_+r.padding-b,!0),r._fill!==void 0&&this._drawLetterSpacing(h[I],r,a,m+r.padding,_+r.padding-b)}}},{key:"_drawLetterSpacing",value:function(e,r,t,a,s){var o=arguments.length>5&&arguments[5]!==void 0?arguments[5]:!1,u=t.context,l=r.letterSpacing,d=!1;if(j.experimentalLetterSpacingSupported&&(j.experimentalLetterSpacing?(u.letterSpacing="".concat(l,"px"),u.textLetterSpacing="".concat(l,"px"),d=!0):(u.letterSpacing="0px",u.textLetterSpacing="0px")),l===0||d){o?u.strokeText(e,a,s):u.fillText(e,a,s);return}for(var h=a,f=j.graphemeSegmenter(e),c=u.measureText(e).width,v=0,p=0;p<f.length;++p){var g=f[p];o?u.strokeText(g,h,s):u.fillText(g,h,s);for(var x="",m=p+1;m<f.length;++m)x+=f[m];v=u.measureText(x).width,h+=c-v+l,c=v}}},{key:"destroy",value:function(){this._activeTextures=null}}]),i}();Pt.extension={type:[y.WebGLSystem,y.WebGPUSystem,y.CanvasSystem],name:"canvasText"};G.add(it);G.add(st);G.add(mt);G.add(Lt);G.add(_t);G.add(Pt);G.add(Ft);G.add(St,xr,mr);G.add(Ae);G.add(kt);G.add(Tt);G.add(bt);G.add(lt);G.add(ot);
