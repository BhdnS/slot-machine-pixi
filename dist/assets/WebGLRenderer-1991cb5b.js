import{_ as v,M as J,k as N,E,a as d,S as F,s as I,g,D as k,w as b,Z as ee,ab as Ie,j as De,F as p,y as te,q as T,c as M,d as L,a1 as j,x as Ce,v as D,z as Ue,U as H,A as re,i as A,h as R,R as Pe,H as Oe}from"./index-e9a6487e.js";import{e as w,f as ne,h as ae,i as V,j as ie}from"./colorToUniform-e74e556a.js";import{b as se}from"./batchSamplersUniformGroup-77861437.js";import{e as Fe,G as ke,c as Me,b as Le,U as He,R as we,B as oe,d as C,f as Ve,S as Xe,a as We}from"./SharedSystems-3691ce08.js";var ue=function(){function t(){d(this,t),this._didUpload=!1,this._tempState=F.for2d()}return v(t,[{key:"init",value:function(e){var r=w({name:"batch",bits:[ne,ae(J),V]});this._shader=new N({glProgram:r,resources:{batchSamplers:se}}),e.renderer.runners.contextChange.add(this)}},{key:"contextChange",value:function(){this._didUpload=!1}},{key:"start",value:function(e,r){var a=e.renderer;a.shader.bind(this._shader,this._didUpload),a.shader.updateUniformGroup(a.globalUniforms.uniformGroup),a.geometry.bind(r,this._shader.glProgram)}},{key:"execute",value:function(e,r){var a=e.renderer;this._didUpload=!0,this._tempState.blendMode=r.blendMode,a.state.set(this._tempState);for(var i=r.textures.textures,s=0;s<i.length;s++)a.texture.bind(i[s],s);a.geometry.draw("triangle-list",r.size,r.start)}},{key:"destroy",value:function(){this._shader.destroy(!0),this._shader=null}}]),t}();ue.extension={type:[E.WebGLPipesAdaptor],name:"batch"};var B=function(t){return t[t.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER",t[t.ARRAY_BUFFER=34962]="ARRAY_BUFFER",t[t.UNIFORM_BUFFER=35345]="UNIFORM_BUFFER",t}(B||{}),Ke=v(function t(n,e){d(this,t),this.buffer=n||null,this.updateID=-1,this.byteLength=-1,this.type=e}),ce=function(){function t(n){d(this,t),this._gpuBuffers=Object.create(null),this._boundBufferBases=Object.create(null),this._renderer=n}return v(t,[{key:"destroy",value:function(){this._renderer=null,this._gl=null,this._gpuBuffers=null,this._boundBufferBases=null}},{key:"contextChange",value:function(){this._gpuBuffers=Object.create(null),this._gl=this._renderer.gl}},{key:"getGlBuffer",value:function(e){return this._gpuBuffers[e.uid]||this.createGLBuffer(e)}},{key:"bind",value:function(e){var r=this._gl,a=this.getGlBuffer(e);r.bindBuffer(a.type,a.buffer)}},{key:"bindBufferBase",value:function(e,r){var a=this._gl;if(this._boundBufferBases[r]!==e){var i=this.getGlBuffer(e);this._boundBufferBases[r]=e,a.bindBufferBase(a.UNIFORM_BUFFER,r,i.buffer)}}},{key:"bindBufferRange",value:function(e,r,a){var i=this._gl;a=a||0;var s=this.getGlBuffer(e);i.bindBufferRange(i.UNIFORM_BUFFER,r||0,s.buffer,a*256,256)}},{key:"updateBuffer",value:function(e){var r=this._gl,a=this.getGlBuffer(e);if(e._updateID===a.updateID)return a;a.updateID=e._updateID,r.bindBuffer(a.type,a.buffer);var i=e.data;if(a.byteLength>=e.data.byteLength)r.bufferSubData(a.type,0,i,0,e._updateSize/i.BYTES_PER_ELEMENT);else{var s=e.descriptor.usage&I.STATIC?r.STATIC_DRAW:r.DYNAMIC_DRAW;a.byteLength=i.byteLength,r.bufferData(a.type,i,s)}return a}},{key:"destroyAll",value:function(){var e=this._gl;for(var r in this._gpuBuffers)e.deleteBuffer(this._gpuBuffers[r].buffer);this._gpuBuffers=Object.create(null)}},{key:"onBufferDestroy",value:function(e,r){var a=this._gpuBuffers[e.uid],i=this._gl;r||i.deleteBuffer(a.buffer),this._gpuBuffers[e.uid]=null}},{key:"createGLBuffer",value:function(e){var r=this._gl,a=B.ARRAY_BUFFER;e.descriptor.usage&I.INDEX?a=B.ELEMENT_ARRAY_BUFFER:e.descriptor.usage&I.UNIFORM&&(a=B.UNIFORM_BUFFER);var i=new Ke(r.createBuffer(),a);return this._gpuBuffers[e.uid]=i,e.on("destroy",this.onBufferDestroy,this),i}}]),t}();ce.extension={type:[E.WebGLSystem],name:"buffer"};var X=function(){function t(n){d(this,t),this.supports={uint32Indices:!0,uniformBufferObject:!0,vertexArrayObject:!0,srgbTextures:!0,nonPowOf2wrapping:!0,msaa:!0,nonPowOf2mipmaps:!0},this._renderer=n,this.extensions=Object.create(null),this.handleContextLost=this.handleContextLost.bind(this),this.handleContextRestored=this.handleContextRestored.bind(this)}return v(t,[{key:"isLost",get:function(){return!this.gl||this.gl.isContextLost()}},{key:"contextChange",value:function(e){this.gl=e,this._renderer.gl=e}},{key:"init",value:function(e){if(e=g(g({},t.defaultOptions),e),e.context)this.initFromContext(e.context);else{var r,a,i=this._renderer.background.alpha<1,s=(r=e.premultipliedAlpha)!==null&&r!==void 0?r:!0,u=e.antialias&&!this._renderer.backBuffer.useBackBuffer;this.createContext(e.preferWebGLVersion,{alpha:i,premultipliedAlpha:s,antialias:u,stencil:!0,preserveDrawingBuffer:e.preserveDrawingBuffer,powerPreference:(a=e.powerPreference)!==null&&a!==void 0?a:"default"})}}},{key:"initFromContext",value:function(e){this.gl=e,this.webGLVersion=e instanceof k.get().getWebGLRenderingContext()?1:2,this.getExtensions(),this.validateContext(e),this._renderer.runners.contextChange.emit(e);var r=this._renderer.view.canvas;r.addEventListener("webglcontextlost",this.handleContextLost,!1),r.addEventListener("webglcontextrestored",this.handleContextRestored,!1)}},{key:"createContext",value:function(e,r){var a,i=this._renderer.view.canvas;if(e===2&&(a=i.getContext("webgl2",r)),!a&&(a=i.getContext("webgl",r),!a))throw new Error("This browser does not support WebGL. Try using the canvas renderer");this.gl=a,this.initFromContext(this.gl)}},{key:"getExtensions",value:function(){var e=this.gl,r={anisotropicFiltering:e.getExtension("EXT_texture_filter_anisotropic"),floatTextureLinear:e.getExtension("OES_texture_float_linear"),s3tc:e.getExtension("WEBGL_compressed_texture_s3tc"),s3tc_sRGB:e.getExtension("WEBGL_compressed_texture_s3tc_srgb"),etc:e.getExtension("WEBGL_compressed_texture_etc"),etc1:e.getExtension("WEBGL_compressed_texture_etc1"),pvrtc:e.getExtension("WEBGL_compressed_texture_pvrtc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),atc:e.getExtension("WEBGL_compressed_texture_atc"),astc:e.getExtension("WEBGL_compressed_texture_astc"),bptc:e.getExtension("EXT_texture_compression_bptc"),rgtc:e.getExtension("EXT_texture_compression_rgtc"),loseContext:e.getExtension("WEBGL_lose_context")};if(this.webGLVersion===1)this.extensions=g(g({},r),{},{drawBuffers:e.getExtension("WEBGL_draw_buffers"),depthTexture:e.getExtension("WEBGL_depth_texture"),vertexArrayObject:e.getExtension("OES_vertex_array_object")||e.getExtension("MOZ_OES_vertex_array_object")||e.getExtension("WEBKIT_OES_vertex_array_object"),uint32ElementIndex:e.getExtension("OES_element_index_uint"),floatTexture:e.getExtension("OES_texture_float"),floatTextureLinear:e.getExtension("OES_texture_float_linear"),textureHalfFloat:e.getExtension("OES_texture_half_float"),textureHalfFloatLinear:e.getExtension("OES_texture_half_float_linear"),vertexAttribDivisorANGLE:e.getExtension("ANGLE_instanced_arrays"),srgb:e.getExtension("EXT_sRGB")});else{this.extensions=g(g({},r),{},{colorBufferFloat:e.getExtension("EXT_color_buffer_float")});var a=e.getExtension("WEBGL_provoking_vertex");a&&a.provokingVertexWEBGL(a.FIRST_VERTEX_CONVENTION_WEBGL)}}},{key:"handleContextLost",value:function(e){var r=this;e.preventDefault(),this._contextLossForced&&(this._contextLossForced=!1,setTimeout(function(){if(r.gl.isContextLost()){var a;(a=r.extensions.loseContext)===null||a===void 0||a.restoreContext()}},0))}},{key:"handleContextRestored",value:function(){this._renderer.runners.contextChange.emit(this.gl)}},{key:"destroy",value:function(){var e,r=this._renderer.view.canvas;this._renderer=null,r.removeEventListener("webglcontextlost",this.handleContextLost),r.removeEventListener("webglcontextrestored",this.handleContextRestored),this.gl.useProgram(null),(e=this.extensions.loseContext)===null||e===void 0||e.loseContext()}},{key:"forceContextLoss",value:function(){var e;(e=this.extensions.loseContext)===null||e===void 0||e.loseContext(),this._contextLossForced=!0}},{key:"validateContext",value:function(e){var r=e.getContextAttributes();r&&!r.stencil&&b("Provided WebGL context does not have a stencil buffer, masks may not render correctly");var a=this.supports,i=this.webGLVersion===2,s=this.extensions;a.uint32Indices=i||!!s.uint32ElementIndex,a.uniformBufferObject=i,a.vertexArrayObject=i||!!s.vertexArrayObject,a.srgbTextures=i||!!s.srgb,a.nonPowOf2wrapping=i,a.nonPowOf2mipmaps=i,a.msaa=i,a.uint32Indices||b("Provided WebGL context does not support 32 index buffer, large scenes may not render correctly")}}]),t}();X.extension={type:[E.WebGLSystem],name:"context"};X.defaultOptions={context:null,premultipliedAlpha:!0,preserveDrawingBuffer:!1,powerPreference:void 0,preferWebGLVersion:2};var je=X,O=function(t){return t[t.RGBA=6408]="RGBA",t[t.RGB=6407]="RGB",t[t.RG=33319]="RG",t[t.RED=6403]="RED",t[t.RGBA_INTEGER=36249]="RGBA_INTEGER",t[t.RGB_INTEGER=36248]="RGB_INTEGER",t[t.RG_INTEGER=33320]="RG_INTEGER",t[t.RED_INTEGER=36244]="RED_INTEGER",t[t.ALPHA=6406]="ALPHA",t[t.LUMINANCE=6409]="LUMINANCE",t[t.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA",t[t.DEPTH_COMPONENT=6402]="DEPTH_COMPONENT",t[t.DEPTH_STENCIL=34041]="DEPTH_STENCIL",t}(O||{}),fe=function(t){return t[t.TEXTURE_2D=3553]="TEXTURE_2D",t[t.TEXTURE_CUBE_MAP=34067]="TEXTURE_CUBE_MAP",t[t.TEXTURE_2D_ARRAY=35866]="TEXTURE_2D_ARRAY",t[t.TEXTURE_CUBE_MAP_POSITIVE_X=34069]="TEXTURE_CUBE_MAP_POSITIVE_X",t[t.TEXTURE_CUBE_MAP_NEGATIVE_X=34070]="TEXTURE_CUBE_MAP_NEGATIVE_X",t[t.TEXTURE_CUBE_MAP_POSITIVE_Y=34071]="TEXTURE_CUBE_MAP_POSITIVE_Y",t[t.TEXTURE_CUBE_MAP_NEGATIVE_Y=34072]="TEXTURE_CUBE_MAP_NEGATIVE_Y",t[t.TEXTURE_CUBE_MAP_POSITIVE_Z=34073]="TEXTURE_CUBE_MAP_POSITIVE_Z",t[t.TEXTURE_CUBE_MAP_NEGATIVE_Z=34074]="TEXTURE_CUBE_MAP_NEGATIVE_Z",t}(fe||{}),h=function(t){return t[t.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",t[t.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",t[t.UNSIGNED_SHORT_5_6_5=33635]="UNSIGNED_SHORT_5_6_5",t[t.UNSIGNED_SHORT_4_4_4_4=32819]="UNSIGNED_SHORT_4_4_4_4",t[t.UNSIGNED_SHORT_5_5_5_1=32820]="UNSIGNED_SHORT_5_5_5_1",t[t.UNSIGNED_INT=5125]="UNSIGNED_INT",t[t.UNSIGNED_INT_10F_11F_11F_REV=35899]="UNSIGNED_INT_10F_11F_11F_REV",t[t.UNSIGNED_INT_2_10_10_10_REV=33640]="UNSIGNED_INT_2_10_10_10_REV",t[t.UNSIGNED_INT_24_8=34042]="UNSIGNED_INT_24_8",t[t.UNSIGNED_INT_5_9_9_9_REV=35902]="UNSIGNED_INT_5_9_9_9_REV",t[t.BYTE=5120]="BYTE",t[t.SHORT=5122]="SHORT",t[t.INT=5124]="INT",t[t.FLOAT=5126]="FLOAT",t[t.FLOAT_32_UNSIGNED_INT_24_8_REV=36269]="FLOAT_32_UNSIGNED_INT_24_8_REV",t[t.HALF_FLOAT=36193]="HALF_FLOAT",t}(h||{}),z={uint8x2:h.UNSIGNED_BYTE,uint8x4:h.UNSIGNED_BYTE,sint8x2:h.BYTE,sint8x4:h.BYTE,unorm8x2:h.UNSIGNED_BYTE,unorm8x4:h.UNSIGNED_BYTE,snorm8x2:h.BYTE,snorm8x4:h.BYTE,uint16x2:h.UNSIGNED_SHORT,uint16x4:h.UNSIGNED_SHORT,sint16x2:h.SHORT,sint16x4:h.SHORT,unorm16x2:h.UNSIGNED_SHORT,unorm16x4:h.UNSIGNED_SHORT,snorm16x2:h.SHORT,snorm16x4:h.SHORT,float16x2:h.HALF_FLOAT,float16x4:h.HALF_FLOAT,float32:h.FLOAT,float32x2:h.FLOAT,float32x3:h.FLOAT,float32x4:h.FLOAT,uint32:h.UNSIGNED_INT,uint32x2:h.UNSIGNED_INT,uint32x3:h.UNSIGNED_INT,uint32x4:h.UNSIGNED_INT,sint32:h.INT,sint32x2:h.INT,sint32x3:h.INT,sint32x4:h.INT};function ze(t){var n;return(n=z[t])!==null&&n!==void 0?n:z.float32}var Ye={"point-list":0,"line-list":1,"line-strip":3,"triangle-list":4,"triangle-strip":5},_e=function(){function t(n){d(this,t),this._geometryVaoHash=Object.create(null),this._renderer=n,this._activeGeometry=null,this._activeVao=null,this.hasVao=!0,this.hasInstance=!0}return v(t,[{key:"contextChange",value:function(){var e=this.gl=this._renderer.gl;if(!this._renderer.context.supports.vertexArrayObject)throw new Error("[PixiJS] Vertex Array Objects are not supported on this device");var r=this._renderer.context.extensions.vertexArrayObject;r&&(e.createVertexArray=function(){return r.createVertexArrayOES()},e.bindVertexArray=function(i){return r.bindVertexArrayOES(i)},e.deleteVertexArray=function(i){return r.deleteVertexArrayOES(i)});var a=this._renderer.context.extensions.vertexAttribDivisorANGLE;a&&(e.drawArraysInstanced=function(i,s,u,o){a.drawArraysInstancedANGLE(i,s,u,o)},e.drawElementsInstanced=function(i,s,u,o,c){a.drawElementsInstancedANGLE(i,s,u,o,c)},e.vertexAttribDivisor=function(i,s){return a.vertexAttribDivisorANGLE(i,s)}),this._activeGeometry=null,this._activeVao=null,this._geometryVaoHash=Object.create(null)}},{key:"bind",value:function(e,r){var a=this.gl;this._activeGeometry=e;var i=this.getVao(e,r);this._activeVao!==i&&(this._activeVao=i,a.bindVertexArray(i)),this.updateBuffers()}},{key:"reset",value:function(){this.unbind()}},{key:"updateBuffers",value:function(){for(var e=this._activeGeometry,r=this._renderer.buffer,a=0;a<e.buffers.length;a++){var i=e.buffers[a];r.updateBuffer(i)}}},{key:"checkCompatibility",value:function(e,r){var a=e.attributes,i=r._attributeData;for(var s in i)if(!a[s])throw new Error('shader and geometry incompatible, geometry missing the "'.concat(s,'" attribute'))}},{key:"getSignature",value:function(e,r){var a=e.attributes,i=r._attributeData,s=["g",e.uid];for(var u in a)i[u]&&s.push(u,i[u].location);return s.join("-")}},{key:"getVao",value:function(e,r){var a;return((a=this._geometryVaoHash[e.uid])===null||a===void 0?void 0:a[r._key])||this.initGeometryVao(e,r)}},{key:"initGeometryVao",value:function(e,r){var a=this._renderer.gl,i=this._renderer.buffer;this._renderer.shader._getProgramData(r),this.checkCompatibility(e,r);var s=this.getSignature(e,r);this._geometryVaoHash[e.uid]||(this._geometryVaoHash[e.uid]=Object.create(null),e.on("destroy",this.onGeometryDestroy,this));var u=this._geometryVaoHash[e.uid],o=u[s];if(o)return u[r._key]=o,o;Fe(e,r._attributeData);var c=e.buffers;o=a.createVertexArray(),a.bindVertexArray(o);for(var f=0;f<c.length;f++){var _=c[f];i.bind(_)}return this.activateVao(e,r),u[r._key]=o,u[s]=o,a.bindVertexArray(null),o}},{key:"onGeometryDestroy",value:function(e,r){var a=this._geometryVaoHash[e.uid],i=this.gl;if(a){if(r)for(var s in a)this._activeVao!==a[s]&&this.unbind(),i.deleteVertexArray(a[s]);this._geometryVaoHash[e.uid]=null}}},{key:"destroyAll",value:function(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,r=this.gl;for(var a in this._geometryVaoHash){if(e)for(var i in this._geometryVaoHash[a]){var s=this._geometryVaoHash[a];this._activeVao!==s&&this.unbind(),r.deleteVertexArray(s[i])}this._geometryVaoHash[a]=null}}},{key:"activateVao",value:function(e,r){var a=this._renderer.gl,i=this._renderer.buffer,s=e.attributes;e.indexBuffer&&i.bind(e.indexBuffer);var u=null;for(var o in s){var c=s[o],f=c.buffer,_=i.getGlBuffer(f),l=r._attributeData[o];if(l){var m;u!==_&&(i.bind(f),u=_);var S=c.location;a.enableVertexAttribArray(S);var G=ee(c.format),K=ze(c.format);if(((m=l.format)===null||m===void 0?void 0:m.substring(1,4))==="int"?a.vertexAttribIPointer(S,G.size,K,c.stride,c.offset):a.vertexAttribPointer(S,G.size,K,G.normalised,c.stride,c.offset),c.instance)if(this.hasInstance)a.vertexAttribDivisor(S,1);else throw new Error("geometry error, GPU Instancing is not supported on this device")}}}},{key:"draw",value:function(e,r,a,i){var s=this._renderer.gl,u=this._activeGeometry,o=Ye[u.topology||e];if(i||(i=u.instanceCount),u.indexBuffer){var c=u.indexBuffer.data.BYTES_PER_ELEMENT,f=c===2?s.UNSIGNED_SHORT:s.UNSIGNED_INT;i>1?s.drawElementsInstanced(o,r||u.indexBuffer.data.length,f,(a||0)*c,i):s.drawElements(o,r||u.indexBuffer.data.length,f,(a||0)*c)}else i>1?s.drawArraysInstanced(o,a||0,r||u.getSize(),i):s.drawArrays(o,a||0,r||u.getSize());return this}},{key:"unbind",value:function(){this.gl.bindVertexArray(null),this._activeVao=null,this._activeGeometry=null}},{key:"destroy",value:function(){this._renderer=null,this.gl=null,this._activeVao=null,this._activeGeometry=null}}]),t}();_e.extension={type:[E.WebGLSystem],name:"geometry"};var qe=new Ie({attributes:{aPosition:[-1,-1,3,-1,-1,3]}}),W=function(){function t(n){d(this,t),this.useBackBuffer=!1,this._useBackBufferThisRender=!1,this._renderer=n}return v(t,[{key:"init",value:function(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},r=g(g({},t.defaultOptions),e),a=r.useBackBuffer,i=r.antialias;this.useBackBuffer=a,this._antialias=i,this._renderer.context.supports.msaa||(b("antialiasing, is not supported on when using the back buffer"),this._antialias=!1),this._state=F.for2d();var s=new De({vertex:`
                attribute vec2 aPosition;
                out vec2 vUv;

                void main() {
                    gl_Position = vec4(aPosition, 0.0, 1.0);

                    vUv = (aPosition + 1.0) / 2.0;

                    // flip dem UVs
                    vUv.y = 1.0 - vUv.y;
                }`,fragment:`
                in vec2 vUv;
                out vec4 finalColor;

                uniform sampler2D uTexture;

                void main() {
                    finalColor = texture(uTexture, vUv);
                }`,name:"big-triangle"});this._bigTriangleShader=new N({glProgram:s,resources:{uTexture:p.WHITE.source}})}},{key:"renderStart",value:function(e){var r=this._renderer.renderTarget.getRenderTarget(e.target);if(this._useBackBufferThisRender=this.useBackBuffer&&!!r.isRoot,this._useBackBufferThisRender){var a=this._renderer.renderTarget.getRenderTarget(e.target);this._targetTexture=a.colorTexture,e.target=this._getBackBufferTexture(a.colorTexture)}}},{key:"renderEnd",value:function(){this._presentBackBuffer()}},{key:"_presentBackBuffer",value:function(){var e=this._renderer;e.renderTarget.finishRenderPass(),this._useBackBufferThisRender&&(e.renderTarget.bind(this._targetTexture,!1),this._bigTriangleShader.resources.uTexture=this._backBufferTexture.source,e.encoder.draw({geometry:qe,shader:this._bigTriangleShader,state:this._state}))}},{key:"_getBackBufferTexture",value:function(e){return this._backBufferTexture=this._backBufferTexture||new p({source:new te({width:e.width,height:e.height,resolution:e._resolution,antialias:this._antialias})}),this._backBufferTexture.source.resize(e.width,e.height,e._resolution),this._backBufferTexture}},{key:"destroy",value:function(){this._backBufferTexture&&(this._backBufferTexture.destroy(),this._backBufferTexture=null)}}]),t}();W.extension={type:[E.WebGLSystem],name:"backBuffer",priority:1};W.defaultOptions={useBackBuffer:!1};var Ze=W,he=function(){function t(n){d(this,t),this._colorMaskCache=15,this._renderer=n}return v(t,[{key:"setMask",value:function(e){this._colorMaskCache!==e&&(this._colorMaskCache=e,this._renderer.gl.colorMask(!!(e&8),!!(e&4),!!(e&2),!!(e&1)))}}]),t}();he.extension={type:[E.WebGLSystem],name:"colorMask"};var le=function(){function t(n){d(this,t),this.commandFinished=Promise.resolve(),this._renderer=n}return v(t,[{key:"setGeometry",value:function(e,r){this._renderer.geometry.bind(e,r.glProgram)}},{key:"finishRenderPass",value:function(){}},{key:"draw",value:function(e){var r=this._renderer,a=e.geometry,i=e.shader,s=e.state,u=e.skipSync,o=e.topology,c=e.size,f=e.start,_=e.instanceCount;r.shader.bind(i,u),r.geometry.bind(a,r.shader._activeProgram),s&&r.state.set(s),r.geometry.draw(o,c,f,_??a.instanceCount)}},{key:"destroy",value:function(){this._renderer=null}}]),t}();le.extension={type:[E.WebGLSystem],name:"encoder"};var Qe=v(function t(){d(this,t),this.width=-1,this.height=-1,this.msaa=!1,this.msaaRenderBuffer=[]}),ve=function(){function t(n){d(this,t),this._stencilCache={enabled:!1,stencilReference:0,stencilMode:T.NONE},this._renderTargetStencilState=Object.create(null),n.renderTarget.onRenderTargetChange.add(this)}return v(t,[{key:"contextChange",value:function(e){this._gl=e,this._comparisonFuncMapping={always:e.ALWAYS,never:e.NEVER,equal:e.EQUAL,"not-equal":e.NOTEQUAL,less:e.LESS,"less-equal":e.LEQUAL,greater:e.GREATER,"greater-equal":e.GEQUAL},this._stencilOpsMapping={keep:e.KEEP,zero:e.ZERO,replace:e.REPLACE,invert:e.INVERT,"increment-clamp":e.INCR,"decrement-clamp":e.DECR,"increment-wrap":e.INCR_WRAP,"decrement-wrap":e.DECR_WRAP},this._stencilCache.enabled=!1,this._stencilCache.stencilMode=T.NONE,this._stencilCache.stencilReference=0}},{key:"onRenderTargetChange",value:function(e){if(this._activeRenderTarget!==e){this._activeRenderTarget=e;var r=this._renderTargetStencilState[e.uid];r||(r=this._renderTargetStencilState[e.uid]={stencilMode:T.DISABLED,stencilReference:0}),this.setStencilMode(r.stencilMode,r.stencilReference)}}},{key:"setStencilMode",value:function(e,r){var a=this._renderTargetStencilState[this._activeRenderTarget.uid],i=this._gl,s=ke[e],u=this._stencilCache;if(a.stencilMode=e,a.stencilReference=r,e===T.DISABLED){this._stencilCache.enabled&&(this._stencilCache.enabled=!1,i.disable(i.STENCIL_TEST));return}this._stencilCache.enabled||(this._stencilCache.enabled=!0,i.enable(i.STENCIL_TEST)),(e!==u.stencilMode||u.stencilReference!==r)&&(u.stencilMode=e,u.stencilReference=r,i.stencilFunc(this._comparisonFuncMapping[s.stencilBack.compare],r,255),i.stencilOp(i.KEEP,i.KEEP,this._stencilOpsMapping[s.stencilBack.passOp]))}}]),t}();ve.extension={type:[E.WebGLSystem],name:"stencil"};var de={f32:4,"vec2<f32>":8,"vec3<f32>":12,"vec4<f32>":16,"mat2x2<f32>":16*2,"mat3x3<f32>":16*3,"mat4x4<f32>":16*4};function $e(t){for(var n=t.map(function(o){return{data:o,offset:0,size:0}}),e=0,r=0,a=0,i=0;i<n.length;i++){var s=n[i];if(e=de[s.data.type],!e)throw new Error("Unknown type ".concat(s.data.type));if(s.data.size>1&&(e=Math.max(e,16)*s.data.size),s.size=e,r%e!==0&&r<16){var u=r%e%16;r+=u,a+=u}r+e>16?(a=Math.ceil(a/16)*16,s.offset=a,a+=e,r=e):(s.offset=a,r+=e,a+=e)}return a=Math.ceil(a/16)*16,{uboElements:n,size:a}}function Je(t,n){var e=Math.max(de[t.data.type]/16,1),r=t.data.value.length/t.data.size,a=(4-r%4)%4;return`
        v = uv.`.concat(t.data.name,`;
        offset += `).concat(n,`;

        arrayOffset = offset;

        t = 0;

        for(var i=0; i < `).concat(t.data.size*e,`; i++)
        {
            for(var j = 0; j < `).concat(r,`; j++)
            {
                data[arrayOffset++] = v[t++];
            }
            `).concat(a!==0?"arrayOffset += ".concat(a,";"):"",`
        }
    `)}function et(t){return Me(t,"uboStd40",Je,Le)}var me=function(t){M(e,t);var n=L(e);function e(){return d(this,e),n.call(this,{createUboElements:$e,generateUboSync:et})}return v(e)}(He);me.extension={type:[E.WebGLSystem],name:"ubo"};var tt=function(){function t(){d(this,t),this._clearColorCache=[0,0,0,0],this._viewPortCache=new j}return v(t,[{key:"init",value:function(e,r){this._renderer=e,this._renderTargetSystem=r,e.runners.contextChange.add(this)}},{key:"contextChange",value:function(){this._clearColorCache=[0,0,0,0],this._viewPortCache=new j}},{key:"copyToTexture",value:function(e,r,a,i,s){var u=this._renderTargetSystem,o=this._renderer,c=u.getGpuRenderTarget(e),f=o.gl;return this.finishRenderPass(e),f.bindFramebuffer(f.FRAMEBUFFER,c.resolveTargetFramebuffer),o.texture.bind(r,0),f.copyTexSubImage2D(f.TEXTURE_2D,0,s.x,s.y,a.x,a.y,i.width,i.height),r}},{key:"startRenderPass",value:function(e){var r=this,a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0,i=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0,u=this._renderTargetSystem,o=e.colorTexture,c=u.getGpuRenderTarget(e),f=s.y;e.isRoot&&(f=o.pixelHeight-s.height),e.colorTextures.forEach(function(m){r._renderer.texture.unbind(m)});var _=this._renderer.gl;_.bindFramebuffer(_.FRAMEBUFFER,c.framebuffer);var l=this._viewPortCache;(l.x!==s.x||l.y!==f||l.width!==s.width||l.height!==s.height)&&(l.x=s.x,l.y=f,l.width=s.width,l.height=s.height,_.viewport(s.x,f,s.width,s.height)),!c.depthStencilRenderBuffer&&(e.stencil||e.depth)&&this._initStencil(c),this.clear(e,a,i)}},{key:"finishRenderPass",value:function(e){var r=this._renderTargetSystem,a=r.getGpuRenderTarget(e);if(a.msaa){var i=this._renderer.gl;i.bindFramebuffer(i.FRAMEBUFFER,a.resolveTargetFramebuffer),i.bindFramebuffer(i.READ_FRAMEBUFFER,a.framebuffer),i.blitFramebuffer(0,0,a.width,a.height,0,0,a.width,a.height,i.COLOR_BUFFER_BIT,i.NEAREST),i.bindFramebuffer(i.FRAMEBUFFER,a.framebuffer)}}},{key:"initGpuRenderTarget",value:function(e){var r=this._renderer,a=r.gl,i=new Qe;return Ce.test(e.colorTexture.resource)?(i.framebuffer=null,i):(this._initColor(e,i),a.bindFramebuffer(a.FRAMEBUFFER,null),i)}},{key:"clear",value:function(e,r,a){if(r){var i=this._renderTargetSystem;typeof r=="boolean"&&(r=r?D.ALL:D.NONE);var s=this._renderer.gl;if(r&D.COLOR){var u;(u=a)!==null&&u!==void 0||(a=i.defaultClearColor);var o=this._clearColorCache,c=a;(o[0]!==c[0]||o[1]!==c[1]||o[2]!==c[2]||o[3]!==c[3])&&(o[0]=c[0],o[1]=c[1],o[2]=c[2],o[3]=c[3],s.clearColor(c[0],c[1],c[2],c[3]))}s.clear(r)}}},{key:"resizeGpuRenderTarget",value:function(e){if(!e.isRoot){var r=this._renderTargetSystem,a=r.getGpuRenderTarget(e);this._resizeColor(e,a),e.stencil&&this._resizeStencil(a)}}},{key:"_initColor",value:function(e,r){var a=this._renderer,i=a.gl,s=i.createFramebuffer();if(r.resolveTargetFramebuffer=s,i.bindFramebuffer(i.FRAMEBUFFER,s),r.width=e.colorTexture.source.pixelWidth,r.height=e.colorTexture.source.pixelHeight,e.colorTextures.forEach(function(o,c){var f=o.source;f.antialias&&(a.context.supports.msaa?r.msaa=!0:b("[RenderTexture] Antialiasing on textures is not supported in WebGL1")),a.texture.bindSource(f,0);var _=a.texture.getGlSource(f),l=_.texture;i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+c,3553,l,0)}),r.msaa){var u=i.createFramebuffer();r.framebuffer=u,i.bindFramebuffer(i.FRAMEBUFFER,u),e.colorTextures.forEach(function(o,c){var f=i.createRenderbuffer();r.msaaRenderBuffer[c]=f})}else r.framebuffer=s;this._resizeColor(e,r)}},{key:"_resizeColor",value:function(e,r){var a=e.colorTexture.source;if(r.width=a.pixelWidth,r.height=a.pixelHeight,e.colorTextures.forEach(function(o,c){c!==0&&o.source.resize(a.width,a.height,a._resolution)}),r.msaa){var i=this._renderer,s=i.gl,u=r.framebuffer;s.bindFramebuffer(s.FRAMEBUFFER,u),e.colorTextures.forEach(function(o,c){var f=o.source;i.texture.bindSource(f,0);var _=i.texture.getGlSource(f),l=_.internalFormat,m=r.msaaRenderBuffer[c];s.bindRenderbuffer(s.RENDERBUFFER,m),s.renderbufferStorageMultisample(s.RENDERBUFFER,4,l,f.pixelWidth,f.pixelHeight),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0+c,s.RENDERBUFFER,m)})}}},{key:"_initStencil",value:function(e){if(e.framebuffer!==null){var r=this._renderer.gl,a=r.createRenderbuffer();e.depthStencilRenderBuffer=a,r.bindRenderbuffer(r.RENDERBUFFER,a),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_STENCIL_ATTACHMENT,r.RENDERBUFFER,a),this._resizeStencil(e)}}},{key:"_resizeStencil",value:function(e){var r=this._renderer.gl;r.bindRenderbuffer(r.RENDERBUFFER,e.depthStencilRenderBuffer),e.msaa?r.renderbufferStorageMultisample(r.RENDERBUFFER,4,r.DEPTH24_STENCIL8,e.width,e.height):r.renderbufferStorage(r.RENDERBUFFER,this._renderer.context.webGLVersion===2?r.DEPTH24_STENCIL8:r.DEPTH_STENCIL,e.width,e.height)}}]),t}(),Ee=function(t){M(e,t);var n=L(e);function e(r){var a;return d(this,e),a=n.call(this,r),a.adaptor=new tt,a.adaptor.init(r,Ue(a)),a}return v(e)}(we);Ee.extension={type:[E.WebGLSystem],name:"renderTarget"};function rt(t,n){var e=[],r=[`
        var g = s.groups;
        var sS = r.shader;
        var p = s.glProgram;
        var ugS = r.uniformGroup;
        var resources;
    `],a=!1,i=0,s=0,u=n._getProgramData(t.glProgram);for(var o in t.groups){var c=t.groups[o];e.push(`
            resources = g[`.concat(o,`].resources;
        `));for(var f in c.resources){var _=c.resources[f];if(_ instanceof H)_.ubo?e.push(`
                        sS.bindUniformBlock(
                            resources[`.concat(f,`],
                            sS._uniformBindMap[`).concat(o,"[").concat(f,`],
                            `).concat(i++,`
                        );
                    `)):e.push(`
                        ugS.updateUniformGroup(resources[`.concat(f,`], p, sD);
                    `));else if(_ instanceof oe)e.push(`
                    sS.bindUniformBlock(
                        resources[`.concat(f,`],
                        sS._uniformBindMap[`).concat(o,"[").concat(f,`],
                        `).concat(i++,`
                    );
                `));else if(_ instanceof te){var l=t._uniformBindMap[o][f],m=u.uniformData[l];m&&(a||(a=!0,r.push(`
                        var tS = r.texture;
                        `)),n._gl.uniform1i(m.location,s),e.push(`
                        tS.bind(resources[`.concat(f,"], ").concat(s,`);
                    `)),s++)}}}var S=[].concat(r,e).join(`
`);return new Function("r","s","sD",S)}var nt=function(){function t(n,e){d(this,t),this.program=n,this.uniformData=e,this.uniformGroups={},this.uniformDirtyGroups={},this.uniformBlockBindings={}}return v(t,[{key:"destroy",value:function(){this.uniformData=null,this.uniformGroups=null,this.uniformDirtyGroups=null,this.uniformBlockBindings=null,this.program=null}}]),t}();function Y(t,n,e){var r=t.createShader(n);return t.shaderSource(r,e),t.compileShader(r),r}function U(t){for(var n=new Array(t),e=0;e<n.length;e++)n[e]=!1;return n}function ge(t,n){switch(t){case"float":return 0;case"vec2":return new Float32Array(2*n);case"vec3":return new Float32Array(3*n);case"vec4":return new Float32Array(4*n);case"int":case"uint":case"sampler2D":case"sampler2DArray":return 0;case"ivec2":return new Int32Array(2*n);case"ivec3":return new Int32Array(3*n);case"ivec4":return new Int32Array(4*n);case"uvec2":return new Uint32Array(2*n);case"uvec3":return new Uint32Array(3*n);case"uvec4":return new Uint32Array(4*n);case"bool":return!1;case"bvec2":return U(2*n);case"bvec3":return U(3*n);case"bvec4":return U(4*n);case"mat2":return new Float32Array([1,0,0,1]);case"mat3":return new Float32Array([1,0,0,0,1,0,0,0,1]);case"mat4":return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}return null}var y=null,q={FLOAT:"float",FLOAT_VEC2:"vec2",FLOAT_VEC3:"vec3",FLOAT_VEC4:"vec4",INT:"int",INT_VEC2:"ivec2",INT_VEC3:"ivec3",INT_VEC4:"ivec4",UNSIGNED_INT:"uint",UNSIGNED_INT_VEC2:"uvec2",UNSIGNED_INT_VEC3:"uvec3",UNSIGNED_INT_VEC4:"uvec4",BOOL:"bool",BOOL_VEC2:"bvec2",BOOL_VEC3:"bvec3",BOOL_VEC4:"bvec4",FLOAT_MAT2:"mat2",FLOAT_MAT3:"mat3",FLOAT_MAT4:"mat4",SAMPLER_2D:"sampler2D",INT_SAMPLER_2D:"sampler2D",UNSIGNED_INT_SAMPLER_2D:"sampler2D",SAMPLER_CUBE:"samplerCube",INT_SAMPLER_CUBE:"samplerCube",UNSIGNED_INT_SAMPLER_CUBE:"samplerCube",SAMPLER_2D_ARRAY:"sampler2DArray",INT_SAMPLER_2D_ARRAY:"sampler2DArray",UNSIGNED_INT_SAMPLER_2D_ARRAY:"sampler2DArray"},at={float:"float32",vec2:"float32x2",vec3:"float32x3",vec4:"float32x4",int:"sint32",ivec2:"sint32x2",ivec3:"sint32x3",ivec4:"sint32x4",uint:"uint32",uvec2:"uint32x2",uvec3:"uint32x3",uvec4:"uint32x4",bool:"uint32",bvec2:"uint32x2",bvec3:"uint32x3",bvec4:"uint32x4"};function Se(t,n){if(!y){var e=Object.keys(q);y={};for(var r=0;r<e.length;++r){var a=e[r];y[t[a]]=q[a]}}return y[n]}function it(t,n){var e=Se(t,n);return at[e]||"float32"}function st(t,n){for(var e=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,r={},a=n.getProgramParameter(t,n.ACTIVE_ATTRIBUTES),i=0;i<a;i++){var s=n.getActiveAttrib(t,i);if(!s.name.startsWith("gl_")){var u=it(n,s.type);r[s.name]={location:0,format:u,stride:ee(u).stride,offset:0,instance:!1,start:0}}}var o=Object.keys(r);if(e){o.sort(function(_,l){return _>l?1:-1});for(var c=0;c<o.length;c++)r[o[c]].location=c,n.bindAttribLocation(t,c,o[c]);n.linkProgram(t)}else for(var f=0;f<o.length;f++)r[o[f]].location=n.getAttribLocation(t,o[f]);return r}function ot(t,n){if(!n.ACTIVE_UNIFORM_BLOCKS)return{};for(var e={},r=n.getProgramParameter(t,n.ACTIVE_UNIFORM_BLOCKS),a=0;a<r;a++){var i=n.getActiveUniformBlockName(t,a),s=n.getUniformBlockIndex(t,i),u=n.getActiveUniformBlockParameter(t,a,n.UNIFORM_BLOCK_DATA_SIZE);e[i]={name:i,index:s,size:u}}return e}function ut(t,n){for(var e={},r=n.getProgramParameter(t,n.ACTIVE_UNIFORMS),a=0;a<r;a++){var i=n.getActiveUniform(t,a),s=i.name.replace(/\[.*?\]$/,""),u=!!i.name.match(/\[.*?\]$/),o=Se(n,i.type);e[s]={name:s,index:a,type:o,size:i.size,isArray:u,value:ge(o,i.size)}}return e}function Z(t,n){var e,r=t.getShaderSource(n).split(`
`).map(function(f,_){return"".concat(_,": ").concat(f)}),a=t.getShaderInfoLog(n),i=a.split(`
`),s={},u=i.map(function(f){return parseFloat(f.replace(/^ERROR\: 0\:([\d]+)\:.*$/,"$1"))}).filter(function(f){return f&&!s[f]?(s[f]=!0,!0):!1}),o=[""];u.forEach(function(f){r[f-1]="%c".concat(r[f-1],"%c"),o.push("background: #FF0000; color:#FFFFFF; font-size: 10px","font-size: 10px")});var c=r.join(`
`);o[0]=c,console.error(a),console.groupCollapsed("click to view full shader code"),(e=console).warn.apply(e,o),console.groupEnd()}function ct(t,n,e,r){t.getProgramParameter(n,t.LINK_STATUS)||(t.getShaderParameter(e,t.COMPILE_STATUS)||Z(t,e),t.getShaderParameter(r,t.COMPILE_STATUS)||Z(t,r),console.error("PixiJS Error: Could not initialize shader."),t.getProgramInfoLog(n)!==""&&console.warn("PixiJS Warning: gl.getProgramInfoLog()",t.getProgramInfoLog(n)))}function ft(t,n){var e=Y(t,t.VERTEX_SHADER,n.vertex),r=Y(t,t.FRAGMENT_SHADER,n.fragment),a=t.createProgram();t.attachShader(a,e),t.attachShader(a,r);var i=n.transformFeedbackVaryings;i&&(typeof t.transformFeedbackVaryings!="function"?b("TransformFeedback is not supported but TransformFeedbackVaryings are given."):t.transformFeedbackVaryings(a,i.names,i.bufferMode==="separate"?t.SEPARATE_ATTRIBS:t.INTERLEAVED_ATTRIBS)),t.linkProgram(a),t.getProgramParameter(a,t.LINK_STATUS)||ct(t,a,e,r),n._attributeData=st(a,t,!/^[ \t]*#[ \t]*version[ \t]+300[ \t]+es[ \t]*$/m.test(n.vertex)),n._uniformData=ut(a,t),n._uniformBlockData=ot(a,t),t.deleteShader(e),t.deleteShader(r);var s={};for(var u in n._uniformData){var o=n._uniformData[u];s[u]={location:t.getUniformLocation(a,u),value:ge(o.type,o.size)}}var c=new nt(a,s);return c}var x={textureCount:0,blockIndex:0},be=function(){function t(n){d(this,t),this._activeProgram=null,this._programDataHash=Object.create(null),this._nextIndex=0,this._boundUniformsIdsToIndexHash=Object.create(null),this._boundIndexToUniformsHash=Object.create(null),this._shaderSyncFunctions=Object.create(null),this._renderer=n}return v(t,[{key:"contextChange",value:function(e){this._gl=e,this._maxBindings=e.MAX_UNIFORM_BUFFER_BINDINGS?e.getParameter(e.MAX_UNIFORM_BUFFER_BINDINGS):0,this._programDataHash=Object.create(null),this._boundUniformsIdsToIndexHash=Object.create(null),this._boundIndexToUniformsHash=Object.create(null),this._activeProgram=null}},{key:"bind",value:function(e,r){if(this._setProgram(e.glProgram),!r){x.textureCount=0,x.blockIndex=0;var a=this._shaderSyncFunctions[e.glProgram._key];a||(a=this._shaderSyncFunctions[e.glProgram._key]=this._generateShaderSync(e,this)),a(this._renderer,e,x)}}},{key:"updateUniformGroup",value:function(e){this._renderer.uniformGroup.updateUniformGroup(e,this._activeProgram,x)}},{key:"bindUniformBlock",value:function(e,r){var a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0,i=this._renderer.buffer,s=this._getProgramData(this._activeProgram),u=e._bufferResource;u&&this._renderer.ubo.updateUniformGroup(e),i.updateBuffer(e.buffer);var o=this._boundUniformsIdsToIndexHash[e.uid];if(o===void 0){var c=this._nextIndex++%this._maxBindings,f=this._boundIndexToUniformsHash[c];f&&(this._boundUniformsIdsToIndexHash[f.uid]=void 0),o=this._boundUniformsIdsToIndexHash[e.uid]=c,this._boundIndexToUniformsHash[c]=e,u?i.bindBufferRange(e.buffer,c,e.offset):i.bindBufferBase(e.buffer,c)}var _=this._gl,l=this._activeProgram._uniformBlockData[r].index;s.uniformBlockBindings[a]!==o&&(s.uniformBlockBindings[a]=o,_.uniformBlockBinding(s.program,l,o))}},{key:"_setProgram",value:function(e){if(this._activeProgram!==e){this._activeProgram=e;var r=this._getProgramData(e);this._gl.useProgram(r.program)}}},{key:"_getProgramData",value:function(e){return this._programDataHash[e._key]||this._createProgramData(e)}},{key:"_createProgramData",value:function(e){var r=e._key;return this._programDataHash[r]=ft(this._gl,e),this._programDataHash[r]}},{key:"destroy",value:function(){for(var e=0,r=Object.keys(this._programDataHash);e<r.length;e++){var a=r[e],i=this._programDataHash[a];i.destroy(),this._programDataHash[a]=null}this._programDataHash=null,this._boundUniformsIdsToIndexHash=null}},{key:"_generateShaderSync",value:function(e,r){return rt(e,r)}}]),t}();be.extension={type:[E.WebGLSystem],name:"shader"};var _t={f32:`if (cv !== v) {
            cu.value = v;
            gl.uniform1f(location, v);
        }`,"vec2<f32>":`if (cv[0] !== v[0] || cv[1] !== v[1]) {
            cv[0] = v[0];
            cv[1] = v[1];
            gl.uniform2f(location, v[0], v[1]);
        }`,"vec3<f32>":`if (cv[0] !== v[0] || cv[1] !== v[1] || cv[2] !== v[2]) {
            cv[0] = v[0];
            cv[1] = v[1];
            cv[2] = v[2];
            gl.uniform3f(location, v[0], v[1], v[2]);
        }`,"vec4<f32>":`if (cv[0] !== v[0] || cv[1] !== v[1] || cv[2] !== v[2] || cv[3] !== v[3]) {
            cv[0] = v[0];
            cv[1] = v[1];
            cv[2] = v[2];
            cv[3] = v[3];
            gl.uniform4f(location, v[0], v[1], v[2], v[3]);
        }`,i32:`if (cv !== v) {
            cu.value = v;
            gl.uniform1i(location, v);
        }`,"vec2<i32>":`if (cv[0] !== v[0] || cv[1] !== v[1]) {
            cv[0] = v[0];
            cv[1] = v[1];
            gl.uniform2i(location, v[0], v[1]);
        }`,"vec3<i32>":`if (cv[0] !== v[0] || cv[1] !== v[1] || cv[2] !== v[2]) {
            cv[0] = v[0];
            cv[1] = v[1];
            cv[2] = v[2];
            gl.uniform3i(location, v[0], v[1], v[2]);
        }`,"vec4<i32>":`if (cv[0] !== v[0] || cv[1] !== v[1] || cv[2] !== v[2] || cv[3] !== v[3]) {
            cv[0] = v[0];
            cv[1] = v[1];
            cv[2] = v[2];
            cv[3] = v[3];
            gl.uniform4i(location, v[0], v[1], v[2], v[3]);
        }`,u32:`if (cv !== v) {
            cu.value = v;
            gl.uniform1ui(location, v);
        }`,"vec2<u32>":`if (cv[0] !== v[0] || cv[1] !== v[1]) {
            cv[0] = v[0];
            cv[1] = v[1];
            gl.uniform2ui(location, v[0], v[1]);
        }`,"vec3<u32>":`if (cv[0] !== v[0] || cv[1] !== v[1] || cv[2] !== v[2]) {
            cv[0] = v[0];
            cv[1] = v[1];
            cv[2] = v[2];
            gl.uniform3ui(location, v[0], v[1], v[2]);
        }`,"vec4<u32>":`if (cv[0] !== v[0] || cv[1] !== v[1] || cv[2] !== v[2] || cv[3] !== v[3]) {
            cv[0] = v[0];
            cv[1] = v[1];
            cv[2] = v[2];
            cv[3] = v[3];
            gl.uniform4ui(location, v[0], v[1], v[2], v[3]);
        }`,bool:`if (cv !== v) {
            cu.value = v;
            gl.uniform1i(location, v);
        }`,"vec2<bool>":`if (cv[0] !== v[0] || cv[1] !== v[1]) {
            cv[0] = v[0];
            cv[1] = v[1];
            gl.uniform2i(location, v[0], v[1]);
        }`,"vec3<bool>":`if (cv[0] !== v[0] || cv[1] !== v[1] || cv[2] !== v[2]) {
            cv[0] = v[0];
            cv[1] = v[1];
            cv[2] = v[2];
            gl.uniform3i(location, v[0], v[1], v[2]);
        }`,"vec4<bool>":`if (cv[0] !== v[0] || cv[1] !== v[1] || cv[2] !== v[2] || cv[3] !== v[3]) {
            cv[0] = v[0];
            cv[1] = v[1];
            cv[2] = v[2];
            cv[3] = v[3];
            gl.uniform4i(location, v[0], v[1], v[2], v[3]);
        }`,"mat2x2<f32>":"gl.uniformMatrix2fv(location, false, v);","mat3x3<f32>":"gl.uniformMatrix3fv(location, false, v);","mat4x4<f32>":"gl.uniformMatrix4fv(location, false, v);"},ht={f32:"gl.uniform1fv(location, v);","vec2<f32>":"gl.uniform2fv(location, v);","vec3<f32>":"gl.uniform3fv(location, v);","vec4<f32>":"gl.uniform4fv(location, v);","mat2x2<f32>":"gl.uniformMatrix2fv(location, false, v);","mat3x3<f32>":"gl.uniformMatrix3fv(location, false, v);","mat4x4<f32>":"gl.uniformMatrix4fv(location, false, v);",i32:"gl.uniform1iv(location, v);","vec2<i32>":"gl.uniform2iv(location, v);","vec3<i32>":"gl.uniform3iv(location, v);","vec4<i32>":"gl.uniform4iv(location, v);",u32:"gl.uniform1iv(location, v);","vec2<u32>":"gl.uniform2iv(location, v);","vec3<u32>":"gl.uniform3iv(location, v);","vec4<u32>":"gl.uniform4iv(location, v);",bool:"gl.uniform1iv(location, v);","vec2<bool>":"gl.uniform2iv(location, v);","vec3<bool>":"gl.uniform3iv(location, v);","vec4<bool>":"gl.uniform4iv(location, v);"};function lt(t,n){var e=[`
        var v = null;
        var cv = null;
        var cu = null;
        var t = 0;
        var gl = renderer.gl;
        var name = null;
    `];for(var r in t.uniforms){if(!n[r]){t.uniforms[r]instanceof H?t.uniforms[r].ubo?e.push(`
                        renderer.shader.bindUniformBlock(uv.`.concat(r,', "').concat(r,`");
                    `)):e.push(`
                        renderer.shader.updateUniformGroup(uv.`.concat(r,`);
                    `)):t.uniforms[r]instanceof oe&&e.push(`
                        renderer.shader.bindBufferResource(uv.`.concat(r,', "').concat(r,`");
                    `));continue}for(var a=t.uniformStructures[r],i=!1,s=0;s<C.length;s++){var u=C[s];if(a.type===u.type&&u.test(a)){e.push('name = "'.concat(r,'";'),C[s].uniform),i=!0;break}}if(!i){var o=a.size===1?_t:ht,c=o[a.type].replace("location",'ud["'.concat(r,'"].location'));e.push(`
            cu = ud["`.concat(r,`"];
            cv = cu.value;
            v = uv["`).concat(r,`"];
            `).concat(c,";"))}}return new Function("ud","uv","renderer","syncData",e.join(`
`))}var pe=function(){function t(n){d(this,t),this._cache={},this._uniformGroupSyncHash={},this._renderer=n,this.gl=null,this._cache={}}return v(t,[{key:"contextChange",value:function(e){this.gl=e}},{key:"updateUniformGroup",value:function(e,r,a){var i=this._renderer.shader._getProgramData(r);if(!e.isStatic||e._dirtyId!==i.uniformDirtyGroups[e.uid]){i.uniformDirtyGroups[e.uid]=e._dirtyId;var s=this._getUniformSyncFunction(e,r);s(i.uniformData,e.uniforms,this._renderer,a)}}},{key:"_getUniformSyncFunction",value:function(e,r){var a;return((a=this._uniformGroupSyncHash[e._signature])===null||a===void 0?void 0:a[r._key])||this._createUniformSyncFunction(e,r)}},{key:"_createUniformSyncFunction",value:function(e,r){var a=this._uniformGroupSyncHash[e._signature]||(this._uniformGroupSyncHash[e._signature]={}),i=this._getSignature(e,r._uniformData,"u");return this._cache[i]||(this._cache[i]=this._generateUniformsSync(e,r._uniformData)),a[r._key]=this._cache[i],a[r._key]}},{key:"_generateUniformsSync",value:function(e,r){return lt(e,r)}},{key:"_getSignature",value:function(e,r,a){var i=e.uniforms,s=["".concat(a,"-")];for(var u in i)s.push(u),r[u]&&s.push(r[u].type);return s.join("-")}},{key:"destroy",value:function(){this._renderer=null,this._cache=null}}]),t}();pe.extension={type:[E.WebGLSystem],name:"uniformGroup"};function vt(t){var n={};return n.normal=[t.ONE,t.ONE_MINUS_SRC_ALPHA],n.add=[t.ONE,t.ONE],n.multiply=[t.DST_COLOR,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA],n.screen=[t.ONE,t.ONE_MINUS_SRC_COLOR,t.ONE,t.ONE_MINUS_SRC_ALPHA],n.none=[0,0],n["normal-npm"]=[t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA],n["add-npm"]=[t.SRC_ALPHA,t.ONE,t.ONE,t.ONE],n["screen-npm"]=[t.SRC_ALPHA,t.ONE_MINUS_SRC_COLOR,t.ONE,t.ONE_MINUS_SRC_ALPHA],n.erase=[t.ZERO,t.ONE_MINUS_SRC_ALPHA],n}var dt=0,mt=1,Et=2,gt=3,St=4,bt=5,Re=function(){function t(){d(this,t),this.gl=null,this.stateId=0,this.polygonOffset=0,this.blendMode="none",this._blendEq=!1,this.map=[],this.map[dt]=this.setBlend,this.map[mt]=this.setOffset,this.map[Et]=this.setCullFace,this.map[gt]=this.setDepthTest,this.map[St]=this.setFrontFace,this.map[bt]=this.setDepthMask,this.checks=[],this.defaultState=F.for2d()}return v(t,[{key:"contextChange",value:function(e){this.gl=e,this.blendModesMap=vt(e),this.reset()}},{key:"set",value:function(e){if(e=e||this.defaultState,this.stateId!==e.data){for(var r=this.stateId^e.data,a=0;r;)r&1&&this.map[a].call(this,!!(e.data&1<<a)),r=r>>1,a++;this.stateId=e.data}for(var i=0;i<this.checks.length;i++)this.checks[i](this,e)}},{key:"forceState",value:function(e){e=e||this.defaultState;for(var r=0;r<this.map.length;r++)this.map[r].call(this,!!(e.data&1<<r));for(var a=0;a<this.checks.length;a++)this.checks[a](this,e);this.stateId=e.data}},{key:"setBlend",value:function(e){this._updateCheck(t._checkBlendMode,e),this.gl[e?"enable":"disable"](this.gl.BLEND)}},{key:"setOffset",value:function(e){this._updateCheck(t._checkPolygonOffset,e),this.gl[e?"enable":"disable"](this.gl.POLYGON_OFFSET_FILL)}},{key:"setDepthTest",value:function(e){this.gl[e?"enable":"disable"](this.gl.DEPTH_TEST)}},{key:"setDepthMask",value:function(e){this.gl.depthMask(e)}},{key:"setCullFace",value:function(e){this.gl[e?"enable":"disable"](this.gl.CULL_FACE)}},{key:"setFrontFace",value:function(e){this.gl.frontFace(this.gl[e?"CW":"CCW"])}},{key:"setBlendMode",value:function(e){if(this.blendModesMap[e]||(e="normal"),e!==this.blendMode){this.blendMode=e;var r=this.blendModesMap[e],a=this.gl;r.length===2?a.blendFunc(r[0],r[1]):a.blendFuncSeparate(r[0],r[1],r[2],r[3]),r.length===6?(this._blendEq=!0,a.blendEquationSeparate(r[4],r[5])):this._blendEq&&(this._blendEq=!1,a.blendEquationSeparate(a.FUNC_ADD,a.FUNC_ADD))}}},{key:"setPolygonOffset",value:function(e,r){this.gl.polygonOffset(e,r)}},{key:"reset",value:function(){this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,!1),this.forceState(this.defaultState),this._blendEq=!0,this.blendMode="",this.setBlendMode("normal")}},{key:"_updateCheck",value:function(e,r){var a=this.checks.indexOf(e);r&&a===-1?this.checks.push(e):!r&&a!==-1&&this.checks.splice(a,1)}},{key:"destroy",value:function(){this.gl=null,this.checks.length=0}}],[{key:"_checkBlendMode",value:function(e,r){e.setBlendMode(r.blendMode)}},{key:"_checkPolygonOffset",value:function(e,r){e.setPolygonOffset(1,r.polygonOffset)}}]),t}();Re.extension={type:[E.WebGLSystem],name:"state"};var pt=Re,Rt=v(function t(n){d(this,t),this.target=fe.TEXTURE_2D,this.texture=n,this.width=-1,this.height=-1,this.type=h.UNSIGNED_BYTE,this.internalFormat=O.RGBA,this.format=O.RGBA,this.samplerType=0}),Tt={id:"image",upload:function(n,e,r){e.width===n.width||e.height===n.height?r.texSubImage2D(r.TEXTURE_2D,0,0,0,e.format,e.type,n.resource):r.texImage2D(e.target,0,e.internalFormat,n.width,n.height,0,e.format,e.type,n.resource),e.width=n.width,e.height=n.height}},yt={"bc1-rgba-unorm":!0,"bc1-rgba-unorm-srgb":!0,"bc2-rgba-unorm":!0,"bc2-rgba-unorm-srgb":!0,"bc3-rgba-unorm":!0,"bc3-rgba-unorm-srgb":!0,"bc4-r-unorm":!0,"bc4-r-snorm":!0,"bc5-rg-unorm":!0,"bc5-rg-snorm":!0,"bc6h-rgb-ufloat":!0,"bc6h-rgb-float":!0,"bc7-rgba-unorm":!0,"bc7-rgba-unorm-srgb":!0,"etc2-rgb8unorm":!0,"etc2-rgb8unorm-srgb":!0,"etc2-rgb8a1unorm":!0,"etc2-rgb8a1unorm-srgb":!0,"etc2-rgba8unorm":!0,"etc2-rgba8unorm-srgb":!0,"eac-r11unorm":!0,"eac-r11snorm":!0,"eac-rg11unorm":!0,"eac-rg11snorm":!0,"astc-4x4-unorm":!0,"astc-4x4-unorm-srgb":!0,"astc-5x4-unorm":!0,"astc-5x4-unorm-srgb":!0,"astc-5x5-unorm":!0,"astc-5x5-unorm-srgb":!0,"astc-6x5-unorm":!0,"astc-6x5-unorm-srgb":!0,"astc-6x6-unorm":!0,"astc-6x6-unorm-srgb":!0,"astc-8x5-unorm":!0,"astc-8x5-unorm-srgb":!0,"astc-8x6-unorm":!0,"astc-8x6-unorm-srgb":!0,"astc-8x8-unorm":!0,"astc-8x8-unorm-srgb":!0,"astc-10x5-unorm":!0,"astc-10x5-unorm-srgb":!0,"astc-10x6-unorm":!0,"astc-10x6-unorm-srgb":!0,"astc-10x8-unorm":!0,"astc-10x8-unorm-srgb":!0,"astc-10x10-unorm":!0,"astc-10x10-unorm-srgb":!0,"astc-12x10-unorm":!0,"astc-12x10-unorm-srgb":!0,"astc-12x12-unorm":!0,"astc-12x12-unorm-srgb":!0},xt={id:"compressed",upload:function(n,e,r){r.pixelStorei(r.UNPACK_ALIGNMENT,4);for(var a=n.pixelWidth,i=n.pixelHeight,s=!!yt[n.format],u=0;u<n.resource.length;u++){var o=n.resource[u];s?r.compressedTexImage2D(r.TEXTURE_2D,u,e.internalFormat,a,i,0,o):r.texImage2D(r.TEXTURE_2D,u,e.internalFormat,a,i,0,e.format,e.type,o),a=Math.max(a>>1,1),i=Math.max(i>>1,1)}}},Te={id:"image",upload:function(n,e,r,a){var i=n.alphaMode==="premultiply-alpha-on-upload";r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,i);var s=e.width,u=e.height,o=n.pixelWidth,c=n.pixelHeight,f=n.resourceWidth,_=n.resourceHeight;f<o||_<c?((s!==o||u!==c)&&r.texImage2D(e.target,0,e.internalFormat,o,c,0,e.format,e.type,null),a===2?r.texSubImage2D(r.TEXTURE_2D,0,0,0,f,_,e.format,e.type,n.resource):r.texSubImage2D(r.TEXTURE_2D,0,0,0,e.format,e.type,n.resource)):s===o||u===c?r.texSubImage2D(r.TEXTURE_2D,0,0,0,e.format,e.type,n.resource):a===2?r.texImage2D(e.target,0,e.internalFormat,o,c,0,e.format,e.type,n.resource):r.texImage2D(e.target,0,e.internalFormat,e.format,e.type,n.resource),e.width=o,e.height=c}},Bt={id:"video",upload:function(n,e,r,a){if(!n.isValid){r.texImage2D(e.target,0,e.internalFormat,1,1,0,e.format,e.type,null);return}Te.upload(n,e,r,a)}},Q={linear:9729,nearest:9728},At={linear:{linear:9987,nearest:9985},nearest:{linear:9986,nearest:9984}},P={"clamp-to-edge":33071,repeat:10497,"mirror-repeat":33648},Nt={never:512,less:513,equal:514,"less-equal":515,greater:516,"not-equal":517,"greater-equal":518,always:519};function $(t,n,e,r,a,i,s,u){var o=i;if(!u||t.addressModeU!=="repeat"||t.addressModeV!=="repeat"||t.addressModeW!=="repeat"){var c=P[s?"clamp-to-edge":t.addressModeU],f=P[s?"clamp-to-edge":t.addressModeV],_=P[s?"clamp-to-edge":t.addressModeW];n[a](o,n.TEXTURE_WRAP_S,c),n[a](o,n.TEXTURE_WRAP_T,f),n.TEXTURE_WRAP_R&&n[a](o,n.TEXTURE_WRAP_R,_)}if((!u||t.magFilter!=="linear")&&n[a](o,n.TEXTURE_MAG_FILTER,Q[t.magFilter]),e){if(!u||t.mipmapFilter!=="linear"){var l=At[t.minFilter][t.mipmapFilter];n[a](o,n.TEXTURE_MIN_FILTER,l)}}else n[a](o,n.TEXTURE_MIN_FILTER,Q[t.minFilter]);if(r&&t.maxAnisotropy>1){var m=Math.min(t.maxAnisotropy,n.getParameter(r.MAX_TEXTURE_MAX_ANISOTROPY_EXT));n[a](o,r.TEXTURE_MAX_ANISOTROPY_EXT,m)}t.compare&&n[a](o,n.TEXTURE_COMPARE_FUNC,Nt[t.compare])}function Gt(t){return{r8unorm:t.RED,r8snorm:t.RED,r8uint:t.RED,r8sint:t.RED,r16uint:t.RED,r16sint:t.RED,r16float:t.RED,rg8unorm:t.RG,rg8snorm:t.RG,rg8uint:t.RG,rg8sint:t.RG,r32uint:t.RED,r32sint:t.RED,r32float:t.RED,rg16uint:t.RG,rg16sint:t.RG,rg16float:t.RG,rgba8unorm:t.RGBA,"rgba8unorm-srgb":t.RGBA,rgba8snorm:t.RGBA,rgba8uint:t.RGBA,rgba8sint:t.RGBA,bgra8unorm:t.RGBA,"bgra8unorm-srgb":t.RGBA,rgb9e5ufloat:t.RGB,rgb10a2unorm:t.RGBA,rg11b10ufloat:t.RGB,rg32uint:t.RG,rg32sint:t.RG,rg32float:t.RG,rgba16uint:t.RGBA,rgba16sint:t.RGBA,rgba16float:t.RGBA,rgba32uint:t.RGBA,rgba32sint:t.RGBA,rgba32float:t.RGBA,stencil8:t.STENCIL_INDEX8,depth16unorm:t.DEPTH_COMPONENT,depth24plus:t.DEPTH_COMPONENT,"depth24plus-stencil8":t.DEPTH_STENCIL,depth32float:t.DEPTH_COMPONENT,"depth32float-stencil8":t.DEPTH_STENCIL}}function It(t,n){var e={},r=t.RGBA;return t instanceof k.get().getWebGLRenderingContext()?n.srgb&&(e={"rgba8unorm-srgb":n.srgb.SRGB8_ALPHA8_EXT,"bgra8unorm-srgb":n.srgb.SRGB8_ALPHA8_EXT}):(e={"rgba8unorm-srgb":t.SRGB8_ALPHA8,"bgra8unorm-srgb":t.SRGB8_ALPHA8},r=t.RGBA8),g(g(g(g(g(g(g({r8unorm:t.R8,r8snorm:t.R8_SNORM,r8uint:t.R8UI,r8sint:t.R8I,r16uint:t.R16UI,r16sint:t.R16I,r16float:t.R16F,rg8unorm:t.RG8,rg8snorm:t.RG8_SNORM,rg8uint:t.RG8UI,rg8sint:t.RG8I,r32uint:t.R32UI,r32sint:t.R32I,r32float:t.R32F,rg16uint:t.RG16UI,rg16sint:t.RG16I,rg16float:t.RG16F,rgba8unorm:t.RGBA},e),{},{rgba8snorm:t.RGBA8_SNORM,rgba8uint:t.RGBA8UI,rgba8sint:t.RGBA8I,bgra8unorm:r,rgb9e5ufloat:t.RGB9_E5,rgb10a2unorm:t.RGB10_A2,rg11b10ufloat:t.R11F_G11F_B10F,rg32uint:t.RG32UI,rg32sint:t.RG32I,rg32float:t.RG32F,rgba16uint:t.RGBA16UI,rgba16sint:t.RGBA16I,rgba16float:t.RGBA16F,rgba32uint:t.RGBA32UI,rgba32sint:t.RGBA32I,rgba32float:t.RGBA32F,stencil8:t.STENCIL_INDEX8,depth16unorm:t.DEPTH_COMPONENT16,depth24plus:t.DEPTH_COMPONENT24,"depth24plus-stencil8":t.DEPTH24_STENCIL8,depth32float:t.DEPTH_COMPONENT32F,"depth32float-stencil8":t.DEPTH32F_STENCIL8},n.s3tc?{"bc1-rgba-unorm":n.s3tc.COMPRESSED_RGBA_S3TC_DXT1_EXT,"bc2-rgba-unorm":n.s3tc.COMPRESSED_RGBA_S3TC_DXT3_EXT,"bc3-rgba-unorm":n.s3tc.COMPRESSED_RGBA_S3TC_DXT5_EXT}:{}),n.s3tc_sRGB?{"bc1-rgba-unorm-srgb":n.s3tc_sRGB.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,"bc2-rgba-unorm-srgb":n.s3tc_sRGB.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT,"bc3-rgba-unorm-srgb":n.s3tc_sRGB.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT}:{}),n.rgtc?{"bc4-r-unorm":n.rgtc.COMPRESSED_RED_RGTC1_EXT,"bc4-r-snorm":n.rgtc.COMPRESSED_SIGNED_RED_RGTC1_EXT,"bc5-rg-unorm":n.rgtc.COMPRESSED_RED_GREEN_RGTC2_EXT,"bc5-rg-snorm":n.rgtc.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT}:{}),n.bptc?{"bc6h-rgb-float":n.bptc.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT,"bc6h-rgb-ufloat":n.bptc.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT,"bc7-rgba-unorm":n.bptc.COMPRESSED_RGBA_BPTC_UNORM_EXT,"bc7-rgba-unorm-srgb":n.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT}:{}),n.etc?{"etc2-rgb8unorm":n.etc.COMPRESSED_RGB8_ETC2,"etc2-rgb8unorm-srgb":n.etc.COMPRESSED_SRGB8_ETC2,"etc2-rgb8a1unorm":n.etc.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2,"etc2-rgb8a1unorm-srgb":n.etc.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2,"etc2-rgba8unorm":n.etc.COMPRESSED_RGBA8_ETC2_EAC,"etc2-rgba8unorm-srgb":n.etc.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC,"eac-r11unorm":n.etc.COMPRESSED_R11_EAC,"eac-rg11unorm":n.etc.COMPRESSED_SIGNED_RG11_EAC}:{}),n.astc?{"astc-4x4-unorm":n.astc.COMPRESSED_RGBA_ASTC_4x4_KHR,"astc-4x4-unorm-srgb":n.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR,"astc-5x4-unorm":n.astc.COMPRESSED_RGBA_ASTC_5x4_KHR,"astc-5x4-unorm-srgb":n.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR,"astc-5x5-unorm":n.astc.COMPRESSED_RGBA_ASTC_5x5_KHR,"astc-5x5-unorm-srgb":n.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR,"astc-6x5-unorm":n.astc.COMPRESSED_RGBA_ASTC_6x5_KHR,"astc-6x5-unorm-srgb":n.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR,"astc-6x6-unorm":n.astc.COMPRESSED_RGBA_ASTC_6x6_KHR,"astc-6x6-unorm-srgb":n.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR,"astc-8x5-unorm":n.astc.COMPRESSED_RGBA_ASTC_8x5_KHR,"astc-8x5-unorm-srgb":n.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR,"astc-8x6-unorm":n.astc.COMPRESSED_RGBA_ASTC_8x6_KHR,"astc-8x6-unorm-srgb":n.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR,"astc-8x8-unorm":n.astc.COMPRESSED_RGBA_ASTC_8x8_KHR,"astc-8x8-unorm-srgb":n.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR,"astc-10x5-unorm":n.astc.COMPRESSED_RGBA_ASTC_10x5_KHR,"astc-10x5-unorm-srgb":n.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR,"astc-10x6-unorm":n.astc.COMPRESSED_RGBA_ASTC_10x6_KHR,"astc-10x6-unorm-srgb":n.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR,"astc-10x8-unorm":n.astc.COMPRESSED_RGBA_ASTC_10x8_KHR,"astc-10x8-unorm-srgb":n.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR,"astc-10x10-unorm":n.astc.COMPRESSED_RGBA_ASTC_10x10_KHR,"astc-10x10-unorm-srgb":n.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR,"astc-12x10-unorm":n.astc.COMPRESSED_RGBA_ASTC_12x10_KHR,"astc-12x10-unorm-srgb":n.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR,"astc-12x12-unorm":n.astc.COMPRESSED_RGBA_ASTC_12x12_KHR,"astc-12x12-unorm-srgb":n.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR}:{})}function Dt(t){return{r8unorm:t.UNSIGNED_BYTE,r8snorm:t.BYTE,r8uint:t.UNSIGNED_BYTE,r8sint:t.BYTE,r16uint:t.UNSIGNED_SHORT,r16sint:t.SHORT,r16float:t.HALF_FLOAT,rg8unorm:t.UNSIGNED_BYTE,rg8snorm:t.BYTE,rg8uint:t.UNSIGNED_BYTE,rg8sint:t.BYTE,r32uint:t.UNSIGNED_INT,r32sint:t.INT,r32float:t.FLOAT,rg16uint:t.UNSIGNED_SHORT,rg16sint:t.SHORT,rg16float:t.HALF_FLOAT,rgba8unorm:t.UNSIGNED_BYTE,"rgba8unorm-srgb":t.UNSIGNED_BYTE,rgba8snorm:t.BYTE,rgba8uint:t.UNSIGNED_BYTE,rgba8sint:t.BYTE,bgra8unorm:t.UNSIGNED_BYTE,"bgra8unorm-srgb":t.UNSIGNED_BYTE,rgb9e5ufloat:t.UNSIGNED_INT_5_9_9_9_REV,rgb10a2unorm:t.UNSIGNED_INT_2_10_10_10_REV,rg11b10ufloat:t.UNSIGNED_INT_10F_11F_11F_REV,rg32uint:t.UNSIGNED_INT,rg32sint:t.INT,rg32float:t.FLOAT,rgba16uint:t.UNSIGNED_SHORT,rgba16sint:t.SHORT,rgba16float:t.HALF_FLOAT,rgba32uint:t.UNSIGNED_INT,rgba32sint:t.INT,rgba32float:t.FLOAT,stencil8:t.UNSIGNED_BYTE,depth16unorm:t.UNSIGNED_SHORT,depth24plus:t.UNSIGNED_INT,"depth24plus-stencil8":t.UNSIGNED_INT_24_8,depth32float:t.FLOAT,"depth32float-stencil8":t.FLOAT_32_UNSIGNED_INT_24_8_REV}}var Ct=4,ye=function(){function t(n){d(this,t),this.managedTextures=[],this._glTextures=Object.create(null),this._glSamplers=Object.create(null),this._boundTextures=[],this._activeTextureLocation=-1,this._boundSamplers=Object.create(null),this._uploads={image:Te,buffer:Tt,video:Bt,compressed:xt},this._useSeparateSamplers=!1,this._renderer=n}return v(t,[{key:"contextChange",value:function(e){this._gl=e,this._mapFormatToInternalFormat||(this._mapFormatToInternalFormat=It(e,this._renderer.context.extensions),this._mapFormatToType=Dt(e),this._mapFormatToFormat=Gt(e)),this._glTextures=Object.create(null),this._glSamplers=Object.create(null),this._boundSamplers=Object.create(null);for(var r=0;r<16;r++)this.bind(p.EMPTY,r)}},{key:"initSource",value:function(e){this.bind(e)}},{key:"bind",value:function(e){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,a=e.source;e?(this.bindSource(a,r),this._useSeparateSamplers&&this._bindSampler(a.style,r)):(this.bindSource(null,r),this._useSeparateSamplers&&this._bindSampler(null,r))}},{key:"bindSource",value:function(e){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,a=this._gl;if(e._touched=this._renderer.textureGC.count,this._boundTextures[r]!==e){this._boundTextures[r]=e,this._activateLocation(r),e=e||p.EMPTY.source;var i=this.getGlSource(e);a.bindTexture(i.target,i.texture)}}},{key:"_bindSampler",value:function(e){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,a=this._gl;if(!e){this._boundSamplers[r]=null,a.bindSampler(r,null);return}var i=this._getGlSampler(e);this._boundSamplers[r]!==i&&(this._boundSamplers[r]=i,a.bindSampler(r,i))}},{key:"unbind",value:function(e){for(var r=e.source,a=this._boundTextures,i=this._gl,s=0;s<a.length;s++)if(a[s]===r){this._activateLocation(s);var u=this.getGlSource(r);i.bindTexture(u.target,null),a[s]=null}}},{key:"_activateLocation",value:function(e){this._activeTextureLocation!==e&&(this._activeTextureLocation=e,this._gl.activeTexture(this._gl.TEXTURE0+e))}},{key:"_initSource",value:function(e){var r=this._gl,a=new Rt(r.createTexture());if(a.type=this._mapFormatToType[e.format],a.internalFormat=this._mapFormatToInternalFormat[e.format],a.format=this._mapFormatToFormat[e.format],e.autoGenerateMipmaps&&(this._renderer.context.supports.nonPowOf2mipmaps||e.isPowerOfTwo)){var i=Math.max(e.width,e.height);e.mipLevelCount=Math.floor(Math.log2(i))+1}return this._glTextures[e.uid]=a,this.managedTextures.includes(e)||(e.on("update",this.onSourceUpdate,this),e.on("resize",this.onSourceUpdate,this),e.on("styleChange",this.onStyleChange,this),e.on("destroy",this.onSourceDestroy,this),e.on("unload",this.onSourceUnload,this),e.on("updateMipmaps",this.onUpdateMipmaps,this),this.managedTextures.push(e)),this.onSourceUpdate(e),this.updateStyle(e,!1),a}},{key:"onStyleChange",value:function(e){this.updateStyle(e,!1)}},{key:"updateStyle",value:function(e,r){var a=this._gl,i=this.getGlSource(e);a.bindTexture(a.TEXTURE_2D,i.texture),this._boundTextures[this._activeTextureLocation]=e,$(e.style,a,e.mipLevelCount>1,this._renderer.context.extensions.anisotropicFiltering,"texParameteri",a.TEXTURE_2D,!this._renderer.context.supports.nonPowOf2wrapping&&!e.isPowerOfTwo,r)}},{key:"onSourceUnload",value:function(e){var r=this._glTextures[e.uid];r&&(this.unbind(e),this._glTextures[e.uid]=null,this._gl.deleteTexture(r.texture))}},{key:"onSourceUpdate",value:function(e){var r=this._gl,a=this.getGlSource(e);r.bindTexture(r.TEXTURE_2D,a.texture),this._boundTextures[this._activeTextureLocation]=e,this._uploads[e.uploadMethodId]?this._uploads[e.uploadMethodId].upload(e,a,r,this._renderer.context.webGLVersion):r.texImage2D(r.TEXTURE_2D,0,r.RGBA,e.pixelWidth,e.pixelHeight,0,r.RGBA,r.UNSIGNED_BYTE,null),e.autoGenerateMipmaps&&e.mipLevelCount>1&&this.onUpdateMipmaps(e,!1)}},{key:"onUpdateMipmaps",value:function(e){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;r&&this.bindSource(e,0);var a=this.getGlSource(e);this._gl.generateMipmap(a.target)}},{key:"onSourceDestroy",value:function(e){e.off("destroy",this.onSourceDestroy,this),e.off("update",this.onSourceUpdate,this),e.off("resize",this.onSourceUpdate,this),e.off("unload",this.onSourceUnload,this),e.off("styleChange",this.onStyleChange,this),e.off("updateMipmaps",this.onUpdateMipmaps,this),this.managedTextures.splice(this.managedTextures.indexOf(e),1),this.onSourceUnload(e)}},{key:"_initSampler",value:function(e){var r=this._gl,a=this._gl.createSampler();return this._glSamplers[e._resourceId]=a,$(e,r,this._boundTextures[this._activeTextureLocation].mipLevelCount>1,this._renderer.context.extensions.anisotropicFiltering,"samplerParameteri",a,!1,!0),this._glSamplers[e._resourceId]}},{key:"_getGlSampler",value:function(e){return this._glSamplers[e._resourceId]||this._initSampler(e)}},{key:"getGlSource",value:function(e){return this._glTextures[e.uid]||this._initSource(e)}},{key:"generateCanvas",value:function(e){var r=this.getPixels(e),a=r.pixels,i=r.width,s=r.height,u=k.get().createCanvas();u.width=i,u.height=s;var o=u.getContext("2d");if(o){var c=o.createImageData(i,s);c.data.set(a),o.putImageData(c,0,0)}return u}},{key:"getPixels",value:function(e){var r=e.source.resolution,a=e.frame,i=Math.max(Math.round(a.width*r),1),s=Math.max(Math.round(a.height*r),1),u=new Uint8Array(Ct*i*s),o=this._renderer,c=o.renderTarget.getRenderTarget(e),f=o.renderTarget.getGpuRenderTarget(c),_=o.gl;return _.bindFramebuffer(_.FRAMEBUFFER,f.resolveTargetFramebuffer),_.readPixels(Math.round(a.x*r),Math.round(a.y*r),i,s,_.RGBA,_.UNSIGNED_BYTE,u),{pixels:new Uint8ClampedArray(u.buffer),width:i,height:s}}},{key:"destroy",value:function(){var e=this;this.managedTextures.slice().forEach(function(r){return e.onSourceDestroy(r)}),this.managedTextures=null,this._renderer=null}}]),t}();ye.extension={type:[E.WebGLSystem],name:"texture"};var xe=function(){function t(){d(this,t)}return v(t,[{key:"init",value:function(){var e=new H({uColor:{value:new Float32Array([1,1,1,1]),type:"vec4<f32>"},uTransformMatrix:{value:new re,type:"mat3x3<f32>"},uRound:{value:0,type:"f32"}}),r=w({name:"graphics",bits:[ne,ae(J),ie,V]});this.shader=new N({glProgram:r,resources:{localUniforms:e,batchSamplers:se}})}},{key:"execute",value:function(e,r){var a=r.context,i=a.customShader||this.shader,s=e.renderer,u=s.graphicsContext,o=u.getContextRenderData(a),c=o.geometry,f=o.instructions;i.groups[0]=s.globalUniforms.bindGroup,s.shader.bind(i),s.geometry.bind(c,i.glProgram);for(var _=f.instructions,l=0;l<f.instructionSize;l++){var m=_[l];if(m.size){for(var S=0;S<m.textures.textures.length;S++)s.texture.bind(m.textures.textures[S],S);s.geometry.draw("triangle-list",m.size,m.start)}}}},{key:"destroy",value:function(){this.shader.destroy(!0),this.shader=null}}]),t}();xe.extension={type:[E.WebGLPipesAdaptor],name:"graphics"};var Be=function(){function t(){d(this,t)}return v(t,[{key:"init",value:function(){var e=w({name:"mesh",bits:[ie,Ve,V]});this._shader=new N({glProgram:e,resources:{uTexture:p.EMPTY.source,textureUniforms:{uTextureMatrix:{type:"mat3x3<f32>",value:new re}}}})}},{key:"execute",value:function(e,r){var a=e.renderer,i=r._shader;if(i){if(!i.glProgram){b("Mesh shader has no glProgram",r.shader);return}}else{i=this._shader;var s=r.texture,u=s.source;i.resources.uTexture=u,i.resources.uSampler=u.style,i.resources.textureUniforms.uniforms.uTextureMatrix=s.textureMatrix.mapCoord}i.groups[100]=a.globalUniforms.bindGroup,i.groups[101]=e.localUniformsBindGroup,a.encoder.draw({geometry:r._geometry,shader:i,state:r.state})}},{key:"destroy",value:function(){this._shader.destroy(!0),this._shader=null}}]),t}();Be.extension={type:[E.WebGLPipesAdaptor],name:"mesh"};var Ut=[].concat(A(Xe),[me,Ze,je,ce,ye,Ee,_e,pe,be,le,pt,ve,he]),Pt=A(We),Ot=[ue,Be,xe],Ae=[],Ne=[],Ge=[];R.handleByNamedList(E.WebGLSystem,Ae);R.handleByNamedList(E.WebGLPipes,Ne);R.handleByNamedList(E.WebGLPipesAdaptor,Ge);R.add.apply(R,A(Ut).concat(A(Pt),Ot));var Ht=function(t){M(e,t);var n=L(e);function e(){d(this,e);var r={name:"webgl",type:Pe.WEBGL,systems:Ae,renderPipes:Ne,renderPipeAdaptors:Ge};return n.call(this,r)}return v(e)}(Oe);export{Ht as WebGLRenderer};
