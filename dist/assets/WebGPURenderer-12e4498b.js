import{S as N,_ as l,M as K,k as D,l as j,E as f,a as p,m as _e,o as I,p as T,g as M,q as E,c as z,d as H,B as q,s as A,t as ye,u as Ge,v as B,x as xe,y as be,z as Se,D as Be,U as Pe,A as Y,F as W,w as ke,i as w,h as P,R as Te,H as Ce}from"./index-e9a6487e.js";import{c as O,a as X,g as Z,r as F,l as Ue,b as Me}from"./colorToUniform-e74e556a.js";import{c as we,u as Re,U as Ae,B as Ee,G as De,e as ze,R as He,t as Oe,S as Fe,a as Le}from"./SharedSystems-3691ce08.js";import{C as V}from"./CanvasPool-b559b4fe.js";var C=N.for2d(),$=function(){function s(){p(this,s)}return l(s,[{key:"init",value:function(){var e=O({name:"batch",bits:[X,Z(K),F]});this._shader=new D({gpuProgram:e,groups:{}})}},{key:"start",value:function(e,t){var n=e.renderer,a=n.encoder,i=this._shader.gpuProgram;this._geometry=t,a.setGeometry(t),C.blendMode="normal",n.pipeline.getPipeline(t,i,C);var u=n.globalUniforms.bindGroup;a.resetBindGroup(1),a.setBindGroup(0,u,i)}},{key:"execute",value:function(e,t){var n=this._shader.gpuProgram,a=e.renderer,i=a.encoder;if(!t.bindGroup){var u=t.textures;t.bindGroup=j(u.textures,u.count)}C.blendMode=t.blendMode;var o=a.bindGroup.getBindGroup(t.bindGroup,n,1),d=a.pipeline.getPipeline(this._geometry,n,C);t.bindGroup._touch(a.textureGC.count),i.setPipeline(d),i.renderPassEncoder.setBindGroup(1,o),i.renderPassEncoder.drawIndexed(t.size,1,t.start)}},{key:"destroy",value:function(){this._shader.destroy(!0),this._shader=null}}]),s}();$.extension={type:[f.WebGPUPipesAdaptor],name:"batch"};var J=function(){function s(r){p(this,s),this._hash=Object.create(null),this._renderer=r}return l(s,[{key:"contextChange",value:function(e){this._gpu=e}},{key:"getBindGroup",value:function(e,t,n){e._updateKey();var a=this._hash[e._key]||this._createBindGroup(e,t,n);return a}},{key:"_createBindGroup",value:function(e,t,n){var a=this._gpu.device,i=t.layout[n],u=[],o=this._renderer;for(var d in i){var c,h=(c=e.resources[d])!==null&&c!==void 0?c:e.resources[i[d]],_=void 0;if(h._resourceType==="uniformGroup"){var G=h;o.ubo.updateUniformGroup(G);var y=G.buffer;_={buffer:o.buffer.getGPUBuffer(y),offset:0,size:y.descriptor.size}}else if(h._resourceType==="buffer"){var m=h;_={buffer:o.buffer.getGPUBuffer(m),offset:0,size:m.descriptor.size}}else if(h._resourceType==="bufferResource"){var v=h;_={buffer:o.buffer.getGPUBuffer(v.buffer),offset:v.offset,size:v.size}}else if(h._resourceType==="textureSampler"){var g=h;_=o.texture.getGpuSampler(g)}else if(h._resourceType==="textureSource"){var b=h;_=o.texture.getGpuSource(b).createView({})}u.push({binding:i[d],resource:_})}var R=o.shader.getProgramData(t).bindGroups[n],k=a.createBindGroup({layout:R,entries:u});return this._hash[e._key]=k,k}},{key:"destroy",value:function(){for(var e=0,t=Object.keys(this._hash);e<t.length;e++){var n=t[e];this._hash[n]=null}this._hash=null,this._renderer=null}}]),s}();J.extension={type:[f.WebGPUSystem],name:"bindGroup"};var Q=function(){function s(){p(this,s),this._gpuBuffers=Object.create(null),this._managedBuffers=[]}return l(s,[{key:"contextChange",value:function(e){this._gpu=e}},{key:"getGPUBuffer",value:function(e){return this._gpuBuffers[e.uid]||this.createGPUBuffer(e)}},{key:"updateBuffer",value:function(e){var t=this._gpuBuffers[e.uid]||this.createGPUBuffer(e),n=e.data;return e._updateID&&n&&(e._updateID=0,this._gpu.device.queue.writeBuffer(t,0,n.buffer,0,(e._updateSize||n.byteLength)+3&-4)),t}},{key:"destroyAll",value:function(){for(var e in this._gpuBuffers)this._gpuBuffers[e].destroy();this._gpuBuffers={}}},{key:"createGPUBuffer",value:function(e){this._gpuBuffers[e.uid]||(e.on("update",this.updateBuffer,this),e.on("change",this.onBufferChange,this),e.on("destroy",this.onBufferDestroy,this));var t=this._gpu.device.createBuffer(e.descriptor);return e._updateID=0,e.data&&(_e(e.data.buffer,t.getMappedRange()),t.unmap()),this._gpuBuffers[e.uid]=t,this._managedBuffers.push(e),t}},{key:"onBufferChange",value:function(e){var t=this._gpuBuffers[e.uid];t.destroy(),e._updateID=0,this._gpuBuffers[e.uid]=this.createGPUBuffer(e)}},{key:"onBufferDestroy",value:function(e){this._managedBuffers.splice(this._managedBuffers.indexOf(e),1),this._destroyBuffer(e)}},{key:"destroy",value:function(){var e=this;this._managedBuffers.forEach(function(t){return e._destroyBuffer(t)}),this._managedBuffers=null,this._gpuBuffers=null}},{key:"_destroyBuffer",value:function(e){var t=this._gpuBuffers[e.uid];t.destroy(),e.off("update",this.updateBuffer,this),e.off("change",this.onBufferChange,this),e.off("destroy",this.onBufferDestroy,this),this._gpuBuffers[e.uid]=null}}]),s}();Q.extension={type:[f.WebGPUSystem],name:"buffer"};var Ie=function(){function s(r){var e=r.minUniformOffsetAlignment;p(this,s),this._minUniformOffsetAlignment=256,this.byteIndex=0,this._minUniformOffsetAlignment=e,this.data=new Float32Array(65535)}return l(s,[{key:"clear",value:function(){this.byteIndex=0}},{key:"addEmptyGroup",value:function(e){if(e>this._minUniformOffsetAlignment/4)throw new Error("UniformBufferBatch: array is too large: ".concat(e*4));var t=this.byteIndex,n=t+e*4;if(n=Math.ceil(n/this._minUniformOffsetAlignment)*this._minUniformOffsetAlignment,n>this.data.length*4)throw new Error("UniformBufferBatch: ubo batch got too big");return this.byteIndex=n,t}},{key:"addGroup",value:function(e){for(var t=this.addEmptyGroup(e.length),n=0;n<e.length;n++)this.data[t/4+n]=e[n];return t}},{key:"destroy",value:function(){this._buffer.destroy(),this._buffer=null,this.data=null}}]),s}(),ee=function(){function s(r){p(this,s),this._colorMaskCache=15,this._renderer=r}return l(s,[{key:"setMask",value:function(e){this._colorMaskCache!==e&&(this._colorMaskCache=e,this._renderer.pipeline.setColorMask(e))}},{key:"destroy",value:function(){this._renderer=null,this._colorMaskCache=null}}]),s}();ee.extension={type:[f.WebGPUSystem],name:"colorMask"};var L=function(){function s(r){p(this,s),this._renderer=r}return l(s,[{key:"init",value:function(){var r=I(T().mark(function t(n){var a=this;return T().wrap(function(u){for(;;)switch(u.prev=u.next){case 0:if(!this._initPromise){u.next=2;break}return u.abrupt("return",this._initPromise);case 2:return this._initPromise=this._createDeviceAndAdaptor(n).then(function(o){a.gpu=o,a._renderer.runners.contextChange.emit(a.gpu)}),u.abrupt("return",this._initPromise);case 4:case"end":return u.stop()}},t,this)}));function e(t){return r.apply(this,arguments)}return e}()},{key:"contextChange",value:function(e){this._renderer.gpu=e}},{key:"_createDeviceAndAdaptor",value:function(){var r=I(T().mark(function t(n){var a,i,u;return T().wrap(function(d){for(;;)switch(d.prev=d.next){case 0:return d.next=2,navigator.gpu.requestAdapter({powerPreference:n.powerPreference,forceFallbackAdapter:n.forceFallbackAdapter});case 2:return a=d.sent,i=["texture-compression-bc","texture-compression-astc","texture-compression-etc2"].filter(function(c){return a.features.has(c)}),d.next=6,a.requestDevice({requiredFeatures:i});case 6:return u=d.sent,d.abrupt("return",{adapter:a,device:u});case 8:case"end":return d.stop()}},t)}));function e(t){return r.apply(this,arguments)}return e}()},{key:"destroy",value:function(){this.gpu=null,this._renderer=null}}]),s}();L.extension={type:[f.WebGPUSystem],name:"device"};L.defaultOptions={powerPreference:void 0,forceFallbackAdapter:!1};var te=function(){function s(r){p(this,s),this._boundBindGroup=Object.create(null),this._boundVertexBuffer=Object.create(null),this._renderer=r}return l(s,[{key:"renderStart",value:function(){var e=this;this.commandFinished=new Promise(function(t){e._resolveCommandFinished=t}),this.commandEncoder=this._renderer.gpu.device.createCommandEncoder()}},{key:"beginRenderPass",value:function(e){this.endRenderPass(),this._clearCache(),this.renderPassEncoder=this.commandEncoder.beginRenderPass(e.descriptor)}},{key:"endRenderPass",value:function(){this.renderPassEncoder&&this.renderPassEncoder.end(),this.renderPassEncoder=null}},{key:"setViewport",value:function(e){this.renderPassEncoder.setViewport(e.x,e.y,e.width,e.height,0,1)}},{key:"setPipelineFromGeometryProgramAndState",value:function(e,t,n,a){var i=this._renderer.pipeline.getPipeline(e,t,n,a);this.setPipeline(i)}},{key:"setPipeline",value:function(e){this._boundPipeline!==e&&(this._boundPipeline=e,this.renderPassEncoder.setPipeline(e))}},{key:"_setVertexBuffer",value:function(e,t){this._boundVertexBuffer[e]!==t&&(this._boundVertexBuffer[e]=t,this.renderPassEncoder.setVertexBuffer(e,this._renderer.buffer.updateBuffer(t)))}},{key:"_setIndexBuffer",value:function(e){if(this._boundIndexBuffer!==e){this._boundIndexBuffer=e;var t=e.data.BYTES_PER_ELEMENT===2?"uint16":"uint32";this.renderPassEncoder.setIndexBuffer(this._renderer.buffer.updateBuffer(e),t)}}},{key:"resetBindGroup",value:function(e){this._boundBindGroup[e]=null}},{key:"setBindGroup",value:function(e,t,n){if(this._boundBindGroup[e]!==t){this._boundBindGroup[e]=t,t._touch(this._renderer.textureGC.count);var a=this._renderer.bindGroup.getBindGroup(t,n,e);this.renderPassEncoder.setBindGroup(e,a)}}},{key:"setGeometry",value:function(e){for(var t in e.attributes){var n=e.attributes[t];this._setVertexBuffer(n.location,n.buffer)}e.indexBuffer&&this._setIndexBuffer(e.indexBuffer)}},{key:"_setShaderBindGroups",value:function(e,t){for(var n in e.groups){var a=e.groups[n];t||this._syncBindGroup(a),this.setBindGroup(n,a,e.gpuProgram)}}},{key:"_syncBindGroup",value:function(e){for(var t in e.resources){var n=e.resources[t];n.isUniformGroup&&this._renderer.ubo.updateUniformGroup(n)}}},{key:"draw",value:function(e){var t=e.geometry,n=e.shader,a=e.state,i=e.topology,u=e.size,o=e.start,d=e.instanceCount,c=e.skipSync;this.setPipelineFromGeometryProgramAndState(t,n.gpuProgram,a,i),this.setGeometry(t),this._setShaderBindGroups(n,c),t.indexBuffer?this.renderPassEncoder.drawIndexed(u||t.indexBuffer.data.length,d||t.instanceCount,o||0):this.renderPassEncoder.draw(u||t.getSize(),d||t.instanceCount,o||0)}},{key:"finishRenderPass",value:function(){this.renderPassEncoder&&(this.renderPassEncoder.end(),this.renderPassEncoder=null)}},{key:"postrender",value:function(){this.finishRenderPass(),this._gpu.device.queue.submit([this.commandEncoder.finish()]),this._resolveCommandFinished(),this.commandEncoder=null}},{key:"restoreRenderPass",value:function(){var e=this._renderer.renderTarget.adaptor.getDescriptor(this._renderer.renderTarget.renderTarget,!1,[0,0,0,1]);this.renderPassEncoder=this.commandEncoder.beginRenderPass(e);var t=this._boundPipeline,n=M({},this._boundVertexBuffer),a=this._boundIndexBuffer,i=M({},this._boundBindGroup);this._clearCache();var u=this._renderer.renderTarget.viewport;this.renderPassEncoder.setViewport(u.x,u.y,u.width,u.height,0,1),this.setPipeline(t);for(var o in n)this._setVertexBuffer(o,n[o]);for(var d in i)this.setBindGroup(d,i[d],null);this._setIndexBuffer(a)}},{key:"_clearCache",value:function(){for(var e=0;e<16;e++)this._boundBindGroup[e]=null,this._boundVertexBuffer[e]=null;this._boundIndexBuffer=null,this._boundPipeline=null}},{key:"destroy",value:function(){this._renderer=null,this._gpu=null,this._boundBindGroup=null,this._boundVertexBuffer=null,this._boundIndexBuffer=null,this._boundPipeline=null}},{key:"contextChange",value:function(e){this._gpu=e}}]),s}();te.extension={type:[f.WebGPUSystem],name:"encoder",priority:1};var re=function(){function s(r){p(this,s),this._renderTargetStencilState=Object.create(null),this._renderer=r,r.renderTarget.onRenderTargetChange.add(this)}return l(s,[{key:"onRenderTargetChange",value:function(e){var t=this._renderTargetStencilState[e.uid];t||(t=this._renderTargetStencilState[e.uid]={stencilMode:E.DISABLED,stencilReference:0}),this._activeRenderTarget=e,this.setStencilMode(t.stencilMode,t.stencilReference)}},{key:"setStencilMode",value:function(e,t){var n=this._renderTargetStencilState[this._activeRenderTarget.uid];n.stencilMode=e,n.stencilReference=t;var a=this._renderer;a.pipeline.setStencilMode(e),a.encoder.renderPassEncoder.setStencilReference(t)}},{key:"destroy",value:function(){this._renderer.renderTarget.onRenderTargetChange.remove(this),this._renderer=null,this._activeRenderTarget=null,this._renderTargetStencilState=null}}]),s}();re.extension={type:[f.WebGPUSystem],name:"stencil"};var U={i32:{align:4,size:4},u32:{align:4,size:4},f32:{align:4,size:4},f16:{align:2,size:2},"vec2<i32>":{align:8,size:8},"vec2<u32>":{align:8,size:8},"vec2<f32>":{align:8,size:8},"vec2<f16>":{align:4,size:4},"vec3<i32>":{align:16,size:12},"vec3<u32>":{align:16,size:12},"vec3<f32>":{align:16,size:12},"vec3<f16>":{align:8,size:6},"vec4<i32>":{align:16,size:16},"vec4<u32>":{align:16,size:16},"vec4<f32>":{align:16,size:16},"vec4<f16>":{align:8,size:8},"mat2x2<f32>":{align:8,size:16},"mat2x2<f16>":{align:4,size:8},"mat3x2<f32>":{align:8,size:24},"mat3x2<f16>":{align:4,size:12},"mat4x2<f32>":{align:8,size:32},"mat4x2<f16>":{align:4,size:16},"mat2x3<f32>":{align:16,size:32},"mat2x3<f16>":{align:8,size:16},"mat3x3<f32>":{align:16,size:48},"mat3x3<f16>":{align:8,size:24},"mat4x3<f32>":{align:16,size:64},"mat4x3<f16>":{align:8,size:32},"mat2x4<f32>":{align:16,size:32},"mat2x4<f16>":{align:8,size:16},"mat3x4<f32>":{align:16,size:48},"mat3x4<f16>":{align:8,size:24},"mat4x4<f32>":{align:16,size:64},"mat4x4<f16>":{align:8,size:32}};function We(s){for(var r=s.map(function(u){return{data:u,offset:0,size:0}}),e=0,t=0;t<r.length;t++){var n=r[t],a=U[n.data.type].size,i=U[n.data.type].align;if(!U[n.data.type])throw new Error("[Pixi.js] WebGPU UniformBuffer: Unknown type ".concat(n.data.type));n.data.size>1&&(a=Math.max(a,i)*n.data.size),e=Math.ceil(e/i)*i,n.size=a,n.offset=e,e+=a}return e=Math.ceil(e/16)*16,{uboElements:r,size:e}}function Ve(s,r){var e=U[s.data.type],t=e.size,n=e.align,a=(n-t)/4;return`
         v = uv.`.concat(s.data.name,`;
         `).concat(r!==0?"offset += ".concat(r,";"):"",`

         arrayOffset = offset;

         t = 0;

         for(var i=0; i < `).concat(s.data.size*(t/4),`; i++)
         {
             for(var j = 0; j < `).concat(t/4,`; j++)
             {
                 data[arrayOffset++] = v[t++];
             }
             `).concat(a!==0?"arrayOffset += ".concat(a,";"):"",`
         }
     `)}function Ne(s){return we(s,"uboWgsl",Ve,Re)}var ne=function(s){z(e,s);var r=H(e);function e(){return p(this,e),r.call(this,{createUboElements:We,generateUboSync:Ne})}return l(e)}(Ae);ne.extension={type:[f.WebGPUSystem],name:"ubo"};var S=128,ae=function(){function s(r){p(this,s),this._bindGroupHash=Object.create(null),this._buffers=[],this._bindGroups=[],this._bufferResources=[],this._renderer=r,this._batchBuffer=new Ie({minUniformOffsetAlignment:S});for(var e=256/S,t=0;t<e;t++){var n=A.UNIFORM|A.COPY_DST;t===0&&(n|=A.COPY_SRC),this._buffers.push(new ye({data:this._batchBuffer.data,usage:n}))}}return l(s,[{key:"renderEnd",value:function(){this._uploadBindGroups(),this._resetBindGroups()}},{key:"_resetBindGroups",value:function(){for(var e in this._bindGroupHash)this._bindGroupHash[e]=null;this._batchBuffer.clear()}},{key:"getUniformBindGroup",value:function(e,t){if(!t&&this._bindGroupHash[e.uid])return this._bindGroupHash[e.uid];this._renderer.ubo.ensureUniformGroup(e);var n=e.buffer.data,a=this._batchBuffer.addEmptyGroup(n.length);return this._renderer.ubo.syncUniformGroup(e,this._batchBuffer.data,a/4),this._bindGroupHash[e.uid]=this._getBindGroup(a/S),this._bindGroupHash[e.uid]}},{key:"getUboResource",value:function(e){this._renderer.ubo.updateUniformGroup(e);var t=e.buffer.data,n=this._batchBuffer.addGroup(t);return this._getBufferResource(n/S)}},{key:"getArrayBindGroup",value:function(e){var t=this._batchBuffer.addGroup(e);return this._getBindGroup(t/S)}},{key:"getArrayBufferResource",value:function(e){var t=this._batchBuffer.addGroup(e),n=t/S;return this._getBufferResource(n)}},{key:"_getBufferResource",value:function(e){if(!this._bufferResources[e]){var t=this._buffers[e%2];this._bufferResources[e]=new Ee({buffer:t,offset:(e/2|0)*256,size:S})}return this._bufferResources[e]}},{key:"_getBindGroup",value:function(e){if(!this._bindGroups[e]){var t=new q({0:this._getBufferResource(e)});this._bindGroups[e]=t}return this._bindGroups[e]}},{key:"_uploadBindGroups",value:function(){var e=this._renderer.buffer,t=this._buffers[0];t.update(this._batchBuffer.byteIndex),e.updateBuffer(t);for(var n=this._renderer.gpu.device.createCommandEncoder(),a=1;a<this._buffers.length;a++){var i=this._buffers[a];n.copyBufferToBuffer(e.getGPUBuffer(t),S,e.getGPUBuffer(i),0,this._batchBuffer.byteIndex)}this._renderer.gpu.device.queue.submit([n.finish()])}},{key:"destroy",value:function(){for(var e=0;e<this._bindGroups.length;e++)this._bindGroups[e].destroy();this._bindGroups=null,this._bindGroupHash=null;for(var t=0;t<this._buffers.length;t++)this._buffers[t].destroy();this._buffers=null;for(var n=0;n<this._bufferResources.length;n++)this._bufferResources[n].destroy();this._bufferResources=null,this._batchBuffer.destroy(),this._bindGroupHash=null,this._renderer=null}}]),s}();ae.extension={type:[f.WebGPUPipes],name:"uniformBatch"};var Ke={"point-list":0,"line-list":1,"line-strip":2,"triangle-list":3,"triangle-strip":4};function je(s,r,e,t,n){return s<<24|r<<16|e<<10|t<<5|n}function qe(s,r,e,t){return e<<6|s<<3|t<<1|r}var ie=function(){function s(r){p(this,s),this._moduleCache=Object.create(null),this._bufferLayoutsCache=Object.create(null),this._pipeCache=Object.create(null),this._pipeStateCaches=Object.create(null),this._colorMask=15,this._multisampleCount=1,this._renderer=r}return l(s,[{key:"contextChange",value:function(e){this._gpu=e,this.setStencilMode(E.DISABLED),this._updatePipeHash()}},{key:"setMultisampleCount",value:function(e){this._multisampleCount!==e&&(this._multisampleCount=e,this._updatePipeHash())}},{key:"setRenderTarget",value:function(e){this._multisampleCount=e.msaaSamples,this._depthStencilAttachment=e.descriptor.depthStencilAttachment?1:0,this._updatePipeHash()}},{key:"setColorMask",value:function(e){this._colorMask!==e&&(this._colorMask=e,this._updatePipeHash())}},{key:"setStencilMode",value:function(e){this._stencilMode!==e&&(this._stencilMode=e,this._stencilState=De[e],this._updatePipeHash())}},{key:"setPipeline",value:function(e,t,n,a){var i=this.getPipeline(e,t,n);a.setPipeline(i)}},{key:"getPipeline",value:function(e,t,n,a){e._layoutKey||(ze(e,t.attributeData),this._generateBufferKey(e)),a=a||e.topology;var i=je(e._layoutKey,t._layoutKey,n.data,n._blendModeId,Ke[a]);return this._pipeCache[i]?this._pipeCache[i]:(this._pipeCache[i]=this._createPipeline(e,t,n,a),this._pipeCache[i])}},{key:"_createPipeline",value:function(e,t,n,a){var i=this._gpu.device,u=this._createVertexBufferLayouts(e),o=this._renderer.state.getColorTargets(n);o[0].writeMask=this._stencilMode===E.RENDERING_MASK_ADD?0:this._colorMask;var d=this._renderer.shader.getProgramData(t).pipeline,c={vertex:{module:this._getModule(t.vertex.source),entryPoint:t.vertex.entryPoint,buffers:u},fragment:{module:this._getModule(t.fragment.source),entryPoint:t.fragment.entryPoint,targets:o},primitive:{topology:a,cullMode:n.cullMode},layout:d,multisample:{count:this._multisampleCount},label:"PIXI Pipeline"};this._depthStencilAttachment&&(c.depthStencil=M(M({},this._stencilState),{},{format:"depth24plus-stencil8",depthWriteEnabled:n.depthTest,depthCompare:n.depthTest?"less":"always"}));var h=i.createRenderPipeline(c);return h}},{key:"_getModule",value:function(e){return this._moduleCache[e]||this._createModule(e)}},{key:"_createModule",value:function(e){var t=this._gpu.device;return this._moduleCache[e]=t.createShaderModule({code:e}),this._moduleCache[e]}},{key:"_generateBufferKey",value:function(e){for(var t=[],n=0,a=Object.keys(e.attributes).sort(),i=0;i<a.length;i++){var u=e.attributes[a[i]];t[n++]=u.location,t[n++]=u.offset,t[n++]=u.format,t[n++]=u.stride}var o=t.join("");return e._layoutKey=Ge(o,"geometry"),e._layoutKey}},{key:"_createVertexBufferLayouts",value:function(e){if(this._bufferLayoutsCache[e._layoutKey])return this._bufferLayoutsCache[e._layoutKey];var t=[];return e.buffers.forEach(function(n){var a={arrayStride:0,stepMode:"vertex",attributes:[]},i=a.attributes;for(var u in e.attributes){var o=e.attributes[u];o.buffer===n&&(a.arrayStride=o.stride,a.stepMode=o.instance?"instance":"vertex",i.push({shaderLocation:o.location,offset:o.offset,format:o.format}))}i.length&&t.push(a)}),this._bufferLayoutsCache[e._layoutKey]=t,t}},{key:"_updatePipeHash",value:function(){var e=qe(this._stencilMode,this._multisampleCount,this._colorMask,this._depthStencilAttachment);this._pipeStateCaches[e]||(this._pipeStateCaches[e]=Object.create(null)),this._pipeCache=this._pipeStateCaches[e]}},{key:"destroy",value:function(){this._renderer=null,this._bufferLayoutsCache=null}}]),s}();ie.extension={type:[f.WebGPUSystem],name:"pipeline"};var Ye=l(function s(){p(this,s),this.contexts=[],this.msaaTextures=[],this.msaaSamples=1}),Xe=function(){function s(){p(this,s)}return l(s,[{key:"init",value:function(e,t){this._renderer=e,this._renderTargetSystem=t}},{key:"copyToTexture",value:function(e,t,n,a,i){var u=this._renderer,o=this._getGpuColorTexture(e),d=u.texture.getGpuSource(t.source);return u.encoder.commandEncoder.copyTextureToTexture({texture:o,origin:n},{texture:d,origin:i},a),t}},{key:"startRenderPass",value:function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0,n=arguments.length>2?arguments[2]:void 0,a=arguments.length>3?arguments[3]:void 0,i=this._renderTargetSystem,u=i.getGpuRenderTarget(e),o=this.getDescriptor(e,t,n);u.descriptor=o,this._renderer.pipeline.setRenderTarget(u),this._renderer.encoder.beginRenderPass(u),this._renderer.encoder.setViewport(a)}},{key:"finishRenderPass",value:function(){this._renderer.encoder.endRenderPass()}},{key:"_getGpuColorTexture",value:function(e){var t=this._renderTargetSystem.getGpuRenderTarget(e);return t.contexts[0]?t.contexts[0].getCurrentTexture():this._renderer.texture.getGpuSource(e.colorTextures[0].source)}},{key:"getDescriptor",value:function(e,t,n){var a=this;typeof t=="boolean"&&(t=t?B.ALL:B.NONE);var i=this._renderTargetSystem,u=i.getGpuRenderTarget(e),o=e.colorTextures.map(function(G,y){var m,v=u.contexts[y],g,b;if(v){var R=v.getCurrentTexture(),k=R.createView();g=k}else g=a._renderer.texture.getGpuSource(G).createView({mipLevelCount:1});u.msaaTextures[y]&&(b=g,g=a._renderer.texture.getTextureView(u.msaaTextures[y]));var me=t&B.COLOR?"clear":"load";return(m=n)!==null&&m!==void 0||(n=i.defaultClearColor),{view:g,resolveTarget:b,clearValue:n,storeOp:"store",loadOp:me}}),d;if((e.stencil||e.depth)&&!e.depthStencilTexture&&(e.ensureDepthStencilTexture(),e.depthStencilTexture.source.sampleCount=u.msaa?4:1),e.depthStencilTexture){var c=t&B.STENCIL?"clear":"load",h=t&B.DEPTH?"clear":"load";d={view:this._renderer.texture.getGpuSource(e.depthStencilTexture.source).createView(),stencilStoreOp:"store",stencilLoadOp:c,depthClearValue:1,depthLoadOp:h,depthStoreOp:"store"}}var _={colorAttachments:o,depthStencilAttachment:d};return _}},{key:"clear",value:function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0,n=arguments.length>2?arguments[2]:void 0,a=arguments.length>3?arguments[3]:void 0;if(t){var i=this._renderer,u=i.gpu,o=i.encoder,d=u.device,c=o.commandEncoder===null;if(c){var h=d.createCommandEncoder(),_=this.getDescriptor(e,t,n),G=h.beginRenderPass(_);G.setViewport(a.x,a.y,a.width,a.height,0,1),G.end();var y=h.finish();d.queue.submit([y])}else this.startRenderPass(e,t,n,a)}}},{key:"initGpuRenderTarget",value:function(e){var t=this;e.isRoot=!0;var n=new Ye;return e.colorTextures.forEach(function(a,i){if(xe.test(a.resource)){var u=a.resource.getContext("webgpu"),o=a.transparent?"premultiplied":"opaque";try{u.configure({device:t._renderer.gpu.device,usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC,format:"bgra8unorm",alphaMode:o})}catch(c){console.error(c)}n.contexts[i]=u}if(n.msaa=a.source.antialias,a.source.antialias){var d=new be({width:0,height:0,sampleCount:4});n.msaaTextures[i]=d}}),n.msaa&&(n.msaaSamples=4,e.depthStencilTexture&&(e.depthStencilTexture.source.sampleCount=4)),n}},{key:"ensureDepthStencilTexture",value:function(e){var t=this._renderTargetSystem.getGpuRenderTarget(e);e.depthStencilTexture&&t.msaa&&(e.depthStencilTexture.source.sampleCount=4)}},{key:"resizeGpuRenderTarget",value:function(e){var t=this._renderTargetSystem.getGpuRenderTarget(e);t.width=e.width,t.height=e.height,t.msaa&&e.colorTextures.forEach(function(n,a){var i=t.msaaTextures[a];i==null||i.resize(n.source.width,n.source.height,n.source._resolution)})}}]),s}(),se=function(s){z(e,s);var r=H(e);function e(t){var n;return p(this,e),n=r.call(this,t),n.adaptor=new Xe,n.adaptor.init(t,Se(n)),n}return l(e)}(He);se.extension={type:[f.WebGPUSystem],name:"renderTarget"};var ue=function(){function s(){p(this,s),this._gpuProgramData=Object.create(null)}return l(s,[{key:"contextChange",value:function(e){this._gpu=e}},{key:"getProgramData",value:function(e){return this._gpuProgramData[e._layoutKey]||this._createGPUProgramData(e)}},{key:"_createGPUProgramData",value:function(e){var t=this._gpu.device,n=e.gpuLayout.map(function(i){return t.createBindGroupLayout({entries:i})}),a={bindGroupLayouts:n};return this._gpuProgramData[e._layoutKey]={bindGroups:n,pipeline:t.createPipelineLayout(a)},this._gpuProgramData[e._layoutKey]}},{key:"destroy",value:function(){this._gpu=null,this._gpuProgramData=null}}]),s}();ue.extension={type:[f.WebGPUSystem],name:"shader"};var x={};x.normal={alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"},color:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}};x.add={alpha:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha",operation:"add"},color:{srcFactor:"one",dstFactor:"one",operation:"add"}};x.multiply={alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"},color:{srcFactor:"dst",dstFactor:"one-minus-src-alpha",operation:"add"}};x.screen={alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"},color:{srcFactor:"one",dstFactor:"one-minus-src",operation:"add"}};x.overlay={alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"},color:{srcFactor:"one",dstFactor:"one-minus-src",operation:"add"}};x.none={alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"},color:{srcFactor:"zero",dstFactor:"zero",operation:"add"}};x["normal-npm"]={alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"},color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha",operation:"add"}};x["add-npm"]={alpha:{srcFactor:"one",dstFactor:"one",operation:"add"},color:{srcFactor:"src-alpha",dstFactor:"one",operation:"add"}};x["screen-npm"]={alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"},color:{srcFactor:"src-alpha",dstFactor:"one-minus-src",operation:"add"}};x.erase={alpha:{srcFactor:"zero",dstFactor:"one-minus-src-alpha",operation:"add"},color:{srcFactor:"zero",dstFactor:"one-minus-src",operation:"add"}};var oe=function(){function s(){p(this,s),this.defaultState=new N,this.defaultState.blend=!0}return l(s,[{key:"contextChange",value:function(e){this.gpu=e}},{key:"getColorTargets",value:function(e){var t=x[e.blendMode]||x.normal;return[{format:"bgra8unorm",writeMask:0,blend:t}]}},{key:"destroy",value:function(){this.gpu=null}}]),s}();oe.extension={type:[f.WebGPUSystem],name:"state"};var Ze={type:"image",upload:function(r,e,t){var n=r.resource,a=(r.pixelWidth|0)*(r.pixelHeight|0),i=n.byteLength/a;t.device.queue.writeTexture({texture:e},n,{offset:0,rowsPerImage:r.pixelHeight,bytesPerRow:r.pixelHeight*i},{width:r.pixelWidth,height:r.pixelHeight,depthOrArrayLayers:1})}},de={"bc1-rgba-unorm":{blockBytes:8,blockWidth:4,blockHeight:4},"bc2-rgba-unorm":{blockBytes:16,blockWidth:4,blockHeight:4},"bc3-rgba-unorm":{blockBytes:16,blockWidth:4,blockHeight:4},"bc7-rgba-unorm":{blockBytes:16,blockWidth:4,blockHeight:4},"etc1-rgb-unorm":{blockBytes:8,blockWidth:4,blockHeight:4},"etc2-rgba8unorm":{blockBytes:16,blockWidth:4,blockHeight:4},"astc-4x4-unorm":{blockBytes:16,blockWidth:4,blockHeight:4}},$e={blockBytes:4,blockWidth:1,blockHeight:1},Je={type:"compressed",upload:function(r,e,t){for(var n=r.pixelWidth,a=r.pixelHeight,i=de[r.format]||$e,u=0;u<r.resource.length;u++){var o=r.resource[u],d=Math.ceil(n/i.blockWidth)*i.blockBytes;t.device.queue.writeTexture({texture:e,mipLevel:u},o,{offset:0,bytesPerRow:d},{width:Math.ceil(n/i.blockWidth)*i.blockWidth,height:Math.ceil(a/i.blockHeight)*i.blockHeight,depthOrArrayLayers:1}),n=Math.max(n>>1,1),a=Math.max(a>>1,1)}}},he={type:"image",upload:function(r,e,t){var n=r.resource;if(n){var a=Math.min(e.width,r.resourceWidth||r.pixelWidth),i=Math.min(e.height,r.resourceHeight||r.pixelHeight),u=r.alphaMode==="premultiply-alpha-on-upload";t.device.queue.copyExternalImageToTexture({source:n},{texture:e,premultipliedAlpha:u},{width:a,height:i})}}},Qe={type:"video",upload:function(r,e,t){he.upload(r,e,t)}},et=function(){function s(r){p(this,s),this.device=r,this.sampler=r.createSampler({minFilter:"linear"}),this.pipelines={}}return l(s,[{key:"_getMipmapPipeline",value:function(e){var t=this.pipelines[e];return t||(this.mipmapShaderModule||(this.mipmapShaderModule=this.device.createShaderModule({code:`
                        var<private> pos : array<vec2<f32>, 3> = array<vec2<f32>, 3>(
                        vec2<f32>(-1.0, -1.0), vec2<f32>(-1.0, 3.0), vec2<f32>(3.0, -1.0));

                        struct VertexOutput {
                        @builtin(position) position : vec4<f32>,
                        @location(0) texCoord : vec2<f32>,
                        };

                        @vertex
                        fn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {
                        var output : VertexOutput;
                        output.texCoord = pos[vertexIndex] * vec2<f32>(0.5, -0.5) + vec2<f32>(0.5);
                        output.position = vec4<f32>(pos[vertexIndex], 0.0, 1.0);
                        return output;
                        }

                        @group(0) @binding(0) var imgSampler : sampler;
                        @group(0) @binding(1) var img : texture_2d<f32>;

                        @fragment
                        fn fragmentMain(@location(0) texCoord : vec2<f32>) -> @location(0) vec4<f32> {
                        return textureSample(img, imgSampler, texCoord);
                        }
                    `})),t=this.device.createRenderPipeline({layout:"auto",vertex:{module:this.mipmapShaderModule,entryPoint:"vertexMain"},fragment:{module:this.mipmapShaderModule,entryPoint:"fragmentMain",targets:[{format:e}]}}),this.pipelines[e]=t),t}},{key:"generateMipmap",value:function(e){var t=this._getMipmapPipeline(e.format);if(e.dimension==="3d"||e.dimension==="1d")throw new Error("Generating mipmaps for non-2d textures is currently unsupported!");var n=e,a=e.depthOrArrayLayers||1,i=e.usage&GPUTextureUsage.RENDER_ATTACHMENT;if(!i){var u={size:{width:Math.ceil(e.width/2),height:Math.ceil(e.height/2),depthOrArrayLayers:a},format:e.format,usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_SRC|GPUTextureUsage.RENDER_ATTACHMENT,mipLevelCount:e.mipLevelCount-1};n=this.device.createTexture(u)}for(var o=this.device.createCommandEncoder({}),d=t.getBindGroupLayout(0),c=0;c<a;++c)for(var h=e.createView({baseMipLevel:0,mipLevelCount:1,dimension:"2d",baseArrayLayer:c,arrayLayerCount:1}),_=i?1:0,G=1;G<e.mipLevelCount;++G){var y=n.createView({baseMipLevel:_++,mipLevelCount:1,dimension:"2d",baseArrayLayer:c,arrayLayerCount:1}),m=o.beginRenderPass({colorAttachments:[{view:y,storeOp:"store",loadOp:"clear",clearValue:{r:0,g:0,b:0,a:0}}]}),v=this.device.createBindGroup({layout:d,entries:[{binding:0,resource:this.sampler},{binding:1,resource:h}]});m.setPipeline(t),m.setBindGroup(0,v),m.draw(3,1,0,0),m.end(),h=y}if(!i)for(var g={width:Math.ceil(e.width/2),height:Math.ceil(e.height/2),depthOrArrayLayers:a},b=1;b<e.mipLevelCount;++b)o.copyTextureToTexture({texture:n,mipLevel:b-1},{texture:e,mipLevel:b},g),g.width=Math.ceil(g.width/2),g.height=Math.ceil(g.height/2);return this.device.queue.submit([o.finish()]),i||n.destroy(),e}}]),s}(),ce=function(){function s(r){p(this,s),this.managedTextures=[],this._gpuSources=Object.create(null),this._gpuSamplers=Object.create(null),this._bindGroupHash=Object.create(null),this._textureViewHash=Object.create(null),this._uploads={image:he,buffer:Ze,video:Qe,compressed:Je},this._renderer=r}return l(s,[{key:"contextChange",value:function(e){this._gpu=e}},{key:"initSource",value:function(e){if(e.autoGenerateMipmaps){var t=Math.max(e.pixelWidth,e.pixelHeight);e.mipLevelCount=Math.floor(Math.log2(t))+1}var n=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST;e.uploadMethodId!=="compressed"&&(n|=GPUTextureUsage.RENDER_ATTACHMENT,n|=GPUTextureUsage.COPY_SRC);var a=de[e.format]||{blockBytes:4,blockWidth:1,blockHeight:1},i=Math.ceil(e.pixelWidth/a.blockWidth)*a.blockWidth,u=Math.ceil(e.pixelHeight/a.blockHeight)*a.blockHeight,o={label:e.label,size:{width:i,height:u},format:e.format,sampleCount:e.sampleCount,mipLevelCount:e.mipLevelCount,dimension:e.dimension,usage:n},d=this._gpu.device.createTexture(o);return this._gpuSources[e.uid]=d,this.managedTextures.includes(e)||(e.on("update",this.onSourceUpdate,this),e.on("resize",this.onSourceResize,this),e.on("destroy",this.onSourceDestroy,this),e.on("unload",this.onSourceUnload,this),e.on("updateMipmaps",this.onUpdateMipmaps,this),this.managedTextures.push(e)),this.onSourceUpdate(e),d}},{key:"onSourceUpdate",value:function(e){var t=this.getGpuSource(e);t&&(this._uploads[e.uploadMethodId]&&this._uploads[e.uploadMethodId].upload(e,t,this._gpu),e.autoGenerateMipmaps&&e.mipLevelCount>1&&this.onUpdateMipmaps(e))}},{key:"onSourceUnload",value:function(e){var t=this._gpuSources[e.uid];t&&(this._gpuSources[e.uid]=null,t.destroy())}},{key:"onUpdateMipmaps",value:function(e){this._mipmapGenerator||(this._mipmapGenerator=new et(this._gpu.device));var t=this.getGpuSource(e);this._mipmapGenerator.generateMipmap(t)}},{key:"onSourceDestroy",value:function(e){e.off("update",this.onSourceUpdate,this),e.off("unload",this.onSourceUnload,this),e.off("destroy",this.onSourceDestroy,this),e.off("resize",this.onSourceResize,this),e.off("updateMipmaps",this.onUpdateMipmaps,this),this.managedTextures.splice(this.managedTextures.indexOf(e),1),this.onSourceUnload(e)}},{key:"onSourceResize",value:function(e){var t=this._gpuSources[e.uid];t?(t.width!==e.pixelWidth||t.height!==e.pixelHeight)&&(this._textureViewHash[e.uid]=null,this._bindGroupHash[e.uid]=null,this.onSourceUnload(e),this.initSource(e)):this.initSource(e)}},{key:"_initSampler",value:function(e){return this._gpuSamplers[e._resourceId]=this._gpu.device.createSampler(e),this._gpuSamplers[e._resourceId]}},{key:"getGpuSampler",value:function(e){return this._gpuSamplers[e._resourceId]||this._initSampler(e)}},{key:"getGpuSource",value:function(e){return this._gpuSources[e.uid]||this.initSource(e)}},{key:"getTextureBindGroup",value:function(e){var t;return(t=this._bindGroupHash[e.uid])!==null&&t!==void 0?t:this._createTextureBindGroup(e)}},{key:"_createTextureBindGroup",value:function(e){var t=e.source,n=t.uid;return this._bindGroupHash[n]=new q({0:t,1:t.style}),this._bindGroupHash[n]}},{key:"getTextureView",value:function(e){var t,n=e.source;return(t=this._textureViewHash[n.uid])!==null&&t!==void 0?t:this._createTextureView(n)}},{key:"_createTextureView",value:function(e){return this._textureViewHash[e.uid]=this.getGpuSource(e).createView(),this._textureViewHash[e.uid]}},{key:"generateCanvas",value:function(e){var t=this._renderer,n=t.gpu.device.createCommandEncoder(),a=Be.get().createCanvas();a.width=e.source.pixelWidth,a.height=e.source.pixelHeight;var i=a.getContext("webgpu");return i.configure({device:t.gpu.device,usage:GPUTextureUsage.COPY_DST|GPUTextureUsage.COPY_SRC,format:navigator.gpu.getPreferredCanvasFormat(),alphaMode:"premultiplied"}),n.copyTextureToTexture({texture:t.texture.getGpuSource(e.source),origin:{x:0,y:0}},{texture:i.getCurrentTexture()},{width:a.width,height:a.height}),t.gpu.device.queue.submit([n.finish()]),a}},{key:"getPixels",value:function(e){var t=this.generateCanvas(e),n=V.getOptimalCanvasAndContext(t.width,t.height),a=n.context;a.drawImage(t,0,0);var i=t.width,u=t.height,o=a.getImageData(0,0,i,u),d=new Uint8ClampedArray(o.data.buffer);return V.returnCanvasAndContext(n),{pixels:d,width:i,height:u}}},{key:"destroy",value:function(){var e=this;this.managedTextures.slice().forEach(function(o){return e.onSourceDestroy(o)}),this.managedTextures=null;for(var t=0,n=Object.keys(this._bindGroupHash);t<n.length;t++){var a=n[t],i=Number(a),u=this._bindGroupHash[i];u==null||u.destroy(),this._bindGroupHash[i]=null}this._gpu=null,this._mipmapGenerator=null,this._gpuSources=null,this._bindGroupHash=null,this._textureViewHash=null,this._gpuSamplers=null}}]),s}();ce.extension={type:[f.WebGPUSystem],name:"texture"};var le=function(){function s(){p(this,s)}return l(s,[{key:"init",value:function(){var e=new Pe({uTransformMatrix:{value:new Y,type:"mat3x3<f32>"},uColor:{value:new Float32Array([1,1,1,1]),type:"vec4<f32>"},uRound:{value:0,type:"f32"}}),t=O({name:"graphics",bits:[X,Z(K),Ue,F]});this.shader=new D({gpuProgram:t,resources:{localUniforms:e}})}},{key:"execute",value:function(e,t){var n=t.context,a=n.customShader||this.shader,i=e.renderer,u=i.graphicsContext,o=u.getContextRenderData(n),d=o.geometry,c=o.instructions,h=i.encoder;h.setPipelineFromGeometryProgramAndState(d,a.gpuProgram,e.state),h.setGeometry(d);var _=i.globalUniforms.bindGroup;h.setBindGroup(0,_,a.gpuProgram);var G=i.renderPipes.uniformBatch.getUniformBindGroup(a.resources.localUniforms,!0);h.setBindGroup(2,G,a.gpuProgram);for(var y=c.instructions,m=0;m<c.instructionSize;m++){var v=y[m];if(a.groups[1]=v.bindGroup,!v.gpuBindGroup){var g=v.textures;v.bindGroup=j(g.textures,g.count),v.gpuBindGroup=i.bindGroup.getBindGroup(v.bindGroup,a.gpuProgram,1)}h.setBindGroup(1,v.bindGroup,a.gpuProgram),h.renderPassEncoder.drawIndexed(v.size,1,v.start)}}},{key:"destroy",value:function(){this.shader.destroy(!0),this.shader=null}}]),s}();le.extension={type:[f.WebGPUPipesAdaptor],name:"graphics"};var pe=function(){function s(){p(this,s)}return l(s,[{key:"init",value:function(){var e=O({name:"mesh",bits:[Me,Oe,F]});this._shader=new D({gpuProgram:e,resources:{uTexture:W.EMPTY._source,uSampler:W.EMPTY._source.style,textureUniforms:{uTextureMatrix:{type:"mat3x3<f32>",value:new Y}}}})}},{key:"execute",value:function(e,t){var n=e.renderer,a=t._shader;if(!a)a=this._shader,a.resources.uTexture=t.texture.source,a.resources.uSampler=t.texture.source.style,a.resources.textureUniforms.uniforms.uTextureMatrix=t.texture.textureMatrix.mapCoord;else if(!a.gpuProgram){ke("Mesh shader has no gpuProgram",t.shader);return}var i=a.gpuProgram;if(i.autoAssignGlobalUniforms&&(a.groups[0]=n.globalUniforms.bindGroup),i.autoAssignLocalUniforms){var u=e.localUniforms;a.groups[1]=n.renderPipes.uniformBatch.getUniformBindGroup(u,!0)}n.encoder.draw({geometry:t._geometry,shader:a,state:t.state})}},{key:"destroy",value:function(){this._shader.destroy(!0),this._shader=null}}]),s}();pe.extension={type:[f.WebGPUPipesAdaptor],name:"mesh"};var tt=[].concat(w(Fe),[ne,te,L,Q,ce,se,ue,oe,ie,ee,re,J]),rt=[].concat(w(Le),[ae]),nt=[$,pe,le],fe=[],ve=[],ge=[];P.handleByNamedList(f.WebGPUSystem,fe);P.handleByNamedList(f.WebGPUPipes,ve);P.handleByNamedList(f.WebGPUPipesAdaptor,ge);P.add.apply(P,w(tt).concat(w(rt),nt));var ot=function(s){z(e,s);var r=H(e);function e(){p(this,e);var t={name:"webgpu",type:Te.WEBGPU,systems:fe,renderPipes:ve,renderPipeAdaptors:ge};return r.call(this,t)}return l(e)}(Ce);export{ot as WebGPURenderer};
